<!DOCTYPE html>
<html lang="pt">
<head>
<title>Rede</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta charset="utf-8" />
<meta name="description" content="Visualização Gráfica de Empresas e de Sócios com dados abertos da Receita Federal do Brasil. Graphic visualization of companies and partners with open data from the Federal Revenue of Brazil."/>
<meta name="keywords" content="CNPJ, Dados Abertos, Receita Federal, OSINT"/>
<meta name="author" content="https://github.com/rictom/rede-cnpj"/>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--, minimal-ui" /--> 
<!--meta name="viewport" content="width=device-width, user-scalable=no" /-->

<!-- 
projeto disponível em https://github.com/rictom/rede-cnpj
Utilizando os seguintes códigos e recursos:
https://github.com/anvaka/VivaGraphJS
// adaptado de http://jsfiddle.net/ibigd/z7ymfpmm/
https://www.cssscript.com/beautiful-multi-level-context-menu-with-pure-javascript-and-css3/
https://fabien-d.github.io/alertify.js/
https://fontawesome.com/v4.7.0/
https://github.com/encharm/Font-Awesome-SVG-PNG
https://www.freepik.com/
-->

<meta property="og:title" content="Rede CNPJ" />
<meta property="og:type" content="website" />
<meta property="og:url" content="" />
<!--
<link rel="shortcut icon" href="/static/imagem/favicon.ico" type="imagem/x-icon"> colocando /rede/ abaixo, para evitar erro quando rodando no nginx. -->
<link rel="icon" href="/static/imagem/favicon.ico?v=1" type="imagem/x-icon"/>
<link  rel="stylesheet" href="/static/alertify/css/alertify.css" /><link  rel="stylesheet" href="/static/alertify/css/themes/default.css" />
<link rel="stylesheet" href="/static/menu/font-awesome_5.14.0_css_all.min.css"/>
<link rel="stylesheet" href="/static/menu/menu.css"/>
<!-- google fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300&display=swap" rel="stylesheet"> 

<script type="text/javascript" src="/static/alertify/alertify.min.js"></script>
<script type="text/javascript" src="/static/vivagraph/vivagraph.js"></script>


<script type="text/javascript">
//Graphic visualization of companies and partners with open data from the Federal Revenue of Brazil."
var graph = Viva.Graph.graph();
var graphics = Viva.Graph.View.svgGraphics();

var gparam = {};

	gparam.inicio = {{parametros|tojson}};
	gparam.inserirDefault = gparam.inicio.inserirDefault;
	gparam.listaImagens = gparam.inicio.listaImagens;
	
	gparam.nodeSize = 20; //24
	gparam.tamanhoFonte = 10;
	gparam.tamCorteLabel = 20; //tamanho máximo do rotulo (para link)
	gparam.corLigacaoLink = 'gray'; //'seagreen';
	gparam.bMostraLigacao = true;
	gparam.kligacoes = 0;
	gparam.btextoEmbaixoIcone = gparam.inicio.btextoEmbaixoIcone; 
	//gparam.idLigacoes = {};
	gparam.idnoSelecionado = null;
	gparam.idNosSelecionados = new Set();
	gparam.listaIdNosInseridos = [];
	gparam.confirmaAntesDeInserirNNos = 300; //100;
	gparam.renderer = null;
	gparam.layout = null;
	gparam.geom = null;
	gparam.ultimoToque = 0;
	gparam.inicioToque = 0;
	gparam.mobile = gparam.inicio.mobile;
	gparam.safari = false;
	gparam.eventclick = 'click'; //no safari ='touchend'
	//gparam.bRotulosCompletos = true;
	gparam.kTipoRotulo = 0; //rotulo completo,
	gparam.AreaSelecaoRetangular = {};
	gparam.springLength=150;
	gparam.bRenderAtivado = true;
	gparam.fScale = graphics.scale;
	gparam.paginaBuscaGoogle = {};
	gparam.camadaIdExpandido = {}; //id -> última camada por duplo clique
	gparam.termoBuscaGoogle = '';
	//gparam.itensFlag = ['situacao_fiscal', 'pep', 'ceis', 'cepim', 'cnep', 'acordo_leniência', 'ceaf', 'pgfn-fgts', 'pgfn-sida','pgfn-prev'];
	gparam.itensFlag = gparam.inicio.itensFlag; //['situacao_fiscal', 'pep', 'ceis', 'cepim', 'cnep', 'acordo_leniência', 'ceaf', 'pgfn-fgts', 'pgfn-sida','pgfn-prev'];
	gparam.embaralhaRotulo = false;
	gparam.abaFilha = null;
	gparam.usuarioLocal = window.location.href.startsWith('http://127.0.0.1');
	
// variáveis globais
var base = document.URL.split('/rede/')[0] + '/rede/'; //= gparam.baseUrl
//base = '/rede/',
	baseImagem = '/static/imagem/',
	gdebug = null,
	markerSeta = null,
	defs = null,
	menu = null;
let LF = String.fromCharCode(10);
/*
createMarker = function(id) {
	return Viva.Graph.svg('marker')
	.attr('id', id)
	.attr('viewBox', '0 0 10 10')
	.attr('refX', '10')
	.attr('refY', '5')
	.attr('markerUnits', 'strokeWidth')
	.attr('markerWidth', '10')
	.attr('markerHeight', '5')
	.attr('orient', 'auto')
	.attr('stroke', 'gray')
	.attr('fill', 'gray');
};*/

// cria a triangulo da seta.
markerSeta = Viva.Graph.svg('marker')
	.attr('id', 'Triangle')
	.attr('viewBox', '0 0 10 10')
	.attr('refX', '10')
	.attr('refY', '5')
	.attr('markerUnits', 'strokeWidth')
	.attr('markerWidth', '10')
	.attr('markerHeight', '5')
	.attr('orient', 'auto')
	.attr('stroke', 'gray')
	.attr('fill', 'gray');
markerSeta.append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');

graphics.getSvgRoot().id = 'principal_svg'; //seta id para ser reconhecido pelo drop_handler
defs = graphics.getSvgRoot().append('defs');
//insere filtro PB
defs.innerHTML = ' \
	<filter id="filtroPB"> \
	<feColorMatrix \
	  type="matrix" \
	  values="0 1 0 0 0 \
			  0 1 0 0 0 \
			  0 1 0 0 0 \
			  0 1 0 1 0 "/> \
	</filter>\
	<filter id="filtroNegativo"> \
	<feColorMatrix type="matrix" \
	values="-1  0  0 0 0  0 -1  0 0 0 0 0 -1 0 0 1 1 1 0 0"/>\
	</filter> \
	';
defs.append(markerSeta);	

// funções auxiliares -------------------
function dcopy(objetoIn) {
	// substituir por https://developer.mozilla.org/en-US/docs/Web/API/structuredClone
	return JSON.parse(JSON.stringify(objetoIn));
}

function labelsNo_LI(idno, tamCorte) {
	idno = idno.substr(3);
	if (idno.startsWith('https://')) {
		idno = idno.substr('https://'.length);
		if (idno.startsWith('www.')) {
			idno = idno.substr(4);
		}
		idno = idno.split('/')[0];
		if (idno.endsWith('.com.br')) {
			idno = idno.split('.com.br')[0];
		} else if (idno.endsWith('.com')) {
			idno = idno.split('.com')[0];
		}
	}
	if (idno.length>tamCorte) {
		idno = idno.substr(0,tamCorte) + '...';
		//descricao = idno.substr(-29);
	}
	return idno;
}

function labelsNo(node, tipoResumido) {
	//antes se passava node.data.label, mas era redundante com id e descricao
	var idno = node.data.id;
	var descricao = node.data.descricao;
	var nota = node.data.nota? node.data.nota: '';
	let tamCorte = gparam.tamCorteLabel;
	if (idno.startsWith('PF_')) {
		idno = idno.substr(3);
		idno = idno.split('-')[0];
	} else if (idno.startsWith('EN_')) {
		var partes = idno.substr(3).split('-');
		idno = partes[0];
		descricao = partes[1] + '/' + partes[2];
	} else if (idno.startsWith('LI_') || idno.startsWith('AR_')) {
		/*
		idno = idno.substr(3);
		if (idno.startsWith('https://')) {
			idno = idno.substr('https://'.length);
			if (idno.startsWith('www.')) {
				idno = idno.substr(4);
			}
			idno = idno.split('/')[0];
			if (idno.endsWith('.com.br')) {
				idno = idno.split('.com.br')[0];
			} else if (idno.endsWith('.com')) {
				idno = idno.split('.com')[0];
			}
		}
		if (idno.length>tamCorte) {
			idno = idno.substr(0,tamCorte) + '...';
			//descricao = idno.substr(-29);
		} */
		idno = labelsNo_LI(idno, tamCorte);
		if (nota.length>tamCorte) {
			nota = '...';
		}
	} else if (idno.startsWith('ID_')) {
		idno = idno.substr(3);
		if (idno.includes('__')) {
			idno = idno.substr(idno.indexOf('__')+2); 
		}
	} else if (idno.startsWith('OO_')) {
		idno = '';
	} else {
		idno = idno.substr(3);
		if (idno.includes('__') && !descricao) {
			descricao=idno.substr(idno.indexOf('__')+2); 
			idno = idno.split('__')[0];
			if (descricao.length>tamCorte) {
				descricao = descricao.substr(0,tamCorte) + '...';
			}
		}
	}
	if (gparam.embaralhaRotulo) {
		descricao = embaralhaTexto(descricao);
		idno = embaralhaTexto(idno);
	}
	if (!tipoResumido) {
		return [idno, descricao, nota]
	} else if (tipoResumido==1) {
		return [descricao, '', nota]
	} else if (tipoResumido==2) {
		return [descricao.split(' ')[0],'', nota]
	} else {
		return ['', '', '']
	}
} //.function labelsNo

function textoFlag(node, bchaveEmNegrito) { 
	var texto = '';
	var textoAJuntar = '';
	//let lista = ['pep', 'ceis', 'cepim', 'cnep', 'acordo_leniência', 'ceaf', 'pgfn-fgts', 'pgfn-sida','pgfn-prev'];
	for (var item of gparam.itensFlag) {
		if (node.data[item]) {
			//let textoAJuntar = item.toUpperCase() + ': ' + node.data[item];
			if (bchaveEmNegrito) {
				textoAJuntar = '<b>' + item + ': </b>' + node.data[item];
			} else {
				textoAJuntar = item + ': ' + node.data[item];
			}
			texto = junta(texto, LF, textoAJuntar);
		}
	}
	return texto;
} //.function textoFlag(node)

function textoTooltip(node, todoTexto){ // se todoTexto=false, exibe apenas dados dos marcadores
	let LF = String.fromCharCode(10);
	var texto = node.id;
	var nome_fantasia = sv(node.data.nome_fantasia);
	if (nome_fantasia) {
		nome_fantasia = '(' + nome_fantasia + ')' + LF;
	} 
	if (node.id.startsWith('PJ_')) {
		if (node.data.uf=='EX') { 
			texto += LF + node.data.descricao + LF + nome_fantasia + sv(node.data.logradouro) + LF + junta(node.data.municipio, '/', node.data.pais);
		} else {
			texto += LF + node.data.descricao + LF + nome_fantasia + junta(node.data.logradouro,', ',node.data.logradouro_complemento) + LF + junta(node.data.municipio, '/', node.data.uf); //sv(node.data.municipio) + '/' + sv(node.data.uf);
		}
	} else if (node.id.startsWith('PF_')) {	
	
	} else if (node.id.startsWith('LI_')) {
		texto = node.id.substr(3) + (node.data.descricao ? LF +  LF + node.data.descricao :  '') + LF;
	} else if (node.id.startsWith('AR_')) {
		texto = node.id.substr(3) + (node.data.descricao ? LF +  LF + node.data.descricao: '')
		if (gparam.usuarioLocal) {
			texto += LF +  LF + 'Clique duplo para abrir o documento.';
			if ((node.id.indexOf('\\')==-1) && (node.id.indexOf('/')==-1)) {
				texto += ' Para ser aberto, isso deve estar na pasta arquivos do projeto.';
			}
		} else { //execução não local
			if ((node.id.indexOf('\\')==-1) && (node.id.indexOf('/')==-1)) {
				texto += LF + + LF +'Para ser aberto, isso deve estar na pasta arquivos do projeto no servidor.';
			} else {
				texto +=  LF + LF + 'O arquivo não está disponível.';
			}
		}
	} else if (node.id.startsWith('ID_')) {
		if (node.id.includes('__')) { 
			texto = node.id.split('__')[0] + '...' + LF + node.id.substr(node.id.indexOf('__')+2);
		} 
		if (node.data.descricao) {
			texto += '\r' + node.data.descricao;
		}
	} else { //outros tipos
		if (node.data.descricao) {
			texto += '\r' + node.data.descricao;
		}	
	}
	if (node.data.nota) {
		texto += LF + node.data.nota;
	}
	if (node.id.startsWith('LI_')) {
		texto += LF + LF + 'Clique duplo para abrir o link';
	}
	texto = junta(texto, LF+LF, textoFlag(node));
	return texto;
} //.function textoTooltip

function imagemLinkDeSite(idNovo) {
	//aqui já se supõe que idNovo começa com LI_
	var imagem= 'link.png';
	var bTentaFavicon = true;
	/*
	if (idNovo.startsWith("LI_https://www.youtube.com/watch?v=")) {
		//nodados.imagem = "https://img.youtube.com/vi/" + idNovo.substr("LI_https://www.youtube.com/watch?v=".length) + '/1.jpg';
		imagem = imagemYoutube(idNovo.substr(3)); //youtube.png
		//converter imagens de outro domínio dá erro de permissão nodados.imagem = converteImagem2Base64(nodados.imagem);
		bTentaFavicon = false;
	} else */
	if (idNovo.startsWith("LI_https://www.youtube.com")) {
		imagem = 'youtube.png';
	} else if (idNovo.startsWith("LI_https://twitter.com/")) {
		imagem = 'twitter.png';
	} else if (idNovo.startsWith("LI_https://www.facebook.com/")) {
		imagem = 'facebook.png';
	} else if (idNovo.startsWith("LI_https://www.instagram.com/")) {
		imagem = 'instagram.png';
	} else if (idNovo.startsWith("LI_https://www.google.com/")) {
		imagem = 'google.png';
	} else if (idNovo.startsWith("LI_https://github.com/")) {
		imagem = 'github.png';
	} else if (idNovo.startsWith("LI_https://www.linkedin.com/")) {
		imagem = 'linkedin.png';
	} else if (idNovo.startsWith("LI_https://www.reddit.com/")) {
		imagem = 'reddit.png';
	} else if (idNovo.startsWith("LI_https://www.whatsapp.com/")) {
		imagem = 'whatsapp.png';
	} else if (idNovo.includes(".gov.br/") || idNovo.includes(".gov/") || idNovo.includes("jus.br/")) {
			imagem = 'institution.png';
	} else if (idNovo.includes(".wikipedia.org/")) {
		imagem = 'wikipedia-w.png';
	} else if (idNovo.includes(".amazon.com")) {
		imagem = 'amazon.png';
	} 
	return imagem;
} //function imagemLinkDeSite

function checkImage(imageSrc, fgood, fbad) {
	var img = new Image();
	img.onload = fgood; 
	img.onerror = fbad;
	img.src = imageSrc;
} //.function checkImage
//    checkImage("foo.gif", function(){ console.log("good"); }, function(){ console.log("bad"); } );

function imagemYoutube(urlvideo) {
	//pega miniatura thumbnail do vídeo
	var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
	var match = urlvideo.match(regExp);
	if  (match&&match[7].length==11) {
		return 'https://img.youtube.com/vi/' + match[7] + '/0.jpg';
	} else {
		return '';
	}
} //.function imagemYoutube

function faviconNoId(noid, urlImage) { 
	let no = graph.getNode(noid);
	var imagemAnterior = no.data.imagem;
	var node = graphics.getNodeUI(noid);
	var urlAnterior;
	try {
		urlAnterior = node.getElementsByTagName('image')[0].getAttribute('xlink:href');
	} catch (e) {};
	
	/*
	bChecaUrl = true;
	if (!bChecaUrl && !urlImage) {
		if (!imagemAnterior.includes(baseImagem) && !imagemAnterior.startsWith('data:') && !imagemAnterior.startsWith('http')) {
			return;
		}
	}*/
	if (noid.startsWith("LI_https://www.youtube.com/watch?v=")) {
		//nodados.imagem = "https://img.youtube.com/vi/" + idNovo.substr("LI_https://www.youtube.com/watch?v=".length) + '/1.jpg';
		urlImage = imagemYoutube(noid.substr(3)); //youtube.png
		//converter imagens de outro domínio dá erro de permissão nodados.imagem = converteImagem2Base64(nodados.imagem);
	} else if (!urlImage && noid.startsWith('LI_')) {
		var partes = noid.substr(3).split('/');
		if (partes.length>2) {
			urlImage = partes[0]+'/'+partes[1] + '/' + partes[2] + '/favicon.ico';	
		}
	} 
	console.log('yyy');
	console.log(urlImage);

	if (!urlImage) { //não faz nada, não parece ser url
		return;
	}
	
	urlImage2 = urlImage;

	//if (!urlImage.startsWith('http')) {
	if (!urlImage.includes(baseImagem) && !urlImage.startsWith('data:') && !urlImage.startsWith('http')) {
		urlImage2 = baseImagem + urlImage;
	}
	
	if (urlImage2.startsWith(baseImagem)) { //se for imagem do servidor da redecnpj, não busca fora
		no.data.imagem = urlImage;
		node.getElementsByTagName('image')[0].setAttribute('xlink:href', urlImage2);	
		return;
	} 

	checkImage(urlImage, 
		function() {
			no.data.imagem = urlImage;
			let urlaux = urlImage;
			if (!urlImage.includes(baseImagem) && !urlImage.startsWith('data:') && !urlImage.startsWith('http')) {
				urlaux = baseImagem + urlImage;
			}
			node.getElementsByTagName('image')[0].setAttribute('xlink:href', urlaux);
		},
		function () {
			node.getElementsByTagName('image')[0].setAttribute('xlink:href', baseImagem + 'link.png');
		}
	);
} //.function faviconNoId

function menu_faviconNosItens(imagemUrl) { 
	//se imageUrl===null, abre prompt para perguntar imagem
	//se !imageUrl ('' por exemplo), coloca favicon nos itens
	//se imageUrl, como essa url como imagem
	var imagemDefault;
	let no = graph.getNode(gparam.idnoSelecionado);
	var imagemDefault = no.data.imagem;	
	if (imagemUrl===null) {
		imagemUrl = prompt('Digite caminho da imagem para alterar os ícones dos itens selecionados. Para usar o favicon do site (caso o item for link), deixe o campo vazio.', imagemDefault);
		if (imagemUrl===null) {
			return;
		}
	}
	for (let noid of gparam.idNosSelecionados) {
		if (1 || noid.startsWith('LI_')) {
			faviconNoId(noid, imagemUrl, true);
		}
	}	
} //.menu_faviconNosItens

function iconeF(idno) {
	var tipo = idno.substr(0,3);
	var imagem = 'icone-grafo-id.png';
	if (tipo=='PF_') {
		imagem = 'icone-grafo-desconhecido.png';
	//} else if (tipo=='PJ_') {
	//	imagem =
	} else if (tipo=='EN_') {
		imagem = 'icone-grafo-endereco.png';
	} else if (tipo=='TE_') {
		imagem = 'icone-grafo-telefone.png';
	} else if (tipo=='EM_') {
		imagem = 'icone-grafo-email.png';		
	} else if (tipo=='UG_') {
		imagem = 'icone-grafo-ug.png';	
	} else if (tipo=='LI_') {
		//ttt imagem = 'link.png';
		imagem = imagemLinkDeSite(idno); 
	} else if (tipo=='AR_') {
		imagem = 'external-link.png';
	} else if (tipo=='PM_') { //PM_ pessoa mulher
		imagem = 'icone-grafo-feminino.png';
	} else if (tipo=='PH_') { //PH_ pessoa homem
		imagem = 'icone-grafo-masculino.png';
	} else if (tipo=='PP_') { //PP_ pessoa pessoa
		imagem = 'icone-grafo-desconhecido.png';
	} else if (tipo=='OO_') {
		imagem = 'circle-o.png';
	} else if (idno.startsWith('ID_')) {
		var idnox = idno.substr(3);
		if (idnox.includes('__')) { //dois undercores depois da numeração de id
			imagem = 'binary.png';
			idnox = idnox.substr(idnox.indexOf('__')+2);
			var palavra = idnox.split(' ')[0];
			if (['def','class'].includes(palavra)) {
				imagem = 'python.png';
			} else if (['return','break','continue'].includes(palavra)) {
				imagem = 'reply.png';
			} else if (['if','else:','elif:','try:', 'except:','finally','with'].includes(palavra)) {
				imagem = 'random.png';
			} else if (['for','while'].includes(palavra)) {
				imagem = 'repeat.png';
			} else if (['@'].includes(palavra)) {
				imagem = 'at.png';
			} else if (palavra.startsWith('#') || palavra.startsWith('//')) {
				imagem = 'sticky-note-o.png';
			} else if (palavra == 'function') {
				imagem = 'code.png';
			}
		}
	}
	return imagem;
} //function iconeF

graphics.node(function(node) {
	// This time it's a group of elements: http://www.w3.org/TR/SVG/struct.html#Groups
	let ui = Viva.Graph.svg('g');
	//let urlImagem = node.data.imagem ? node.data.imagem: 'icone-grafo-id.png';
	var urlImagem = node.data.imagem ? node.data.imagem: iconeF(node.id);
	/*
	var urlImagem;
	if (node.data.imagem) {
		urlImagem = node.data.imagem
	} else {
		urlImagem = iconeF(node.id);
		if (!node.id.startsWith('LI_') { 
			node.data.imagem = urlImagem;
		}
	}*/
	if (!urlImagem.includes(baseImagem) && !urlImagem.startsWith('data:') && !urlImagem.startsWith('http')) {
		urlImagem = baseImagem + urlImagem;
	}
	let img = Viva.Graph.svg('image');
	//ui.posXRel = - gparam.nodeSize/2;
	//ui.posYRel = - gparam.nodeSize/2;

	img.attr('width', gparam.nodeSize)
		.attr('height', gparam.nodeSize)
		//.attr('onError','https://www.google.com/favicon.ico') 
		.link(urlImagem); 

	//if (!node.data.situacao_ativa) {
	if (node.data.situacao_ativa==false) {
		img.attr('filter','url(#filtroPB)');
	};	
	let corFundo = node.data.cor ? node.data.cor:'transparent';
	let	rectCor = Viva.Graph.svg('rect')
			//.attr('stroke', 'black')
			//.attr('stroke-width', 0)		
			.attr('fill', corFundo) //corFundoImagemF(node)) 
			.attr('width', gparam.nodeSize)
			.attr('height', gparam.nodeSize)
			.attr('visibility', 'visible');  //hidden or visible
	
	let	rect = Viva.Graph.svg('rect') //destacar se está selecionado
			.attr('visibility', 'hidden') //hidden or visible	
			.attr('stroke', 'black') //'crimson'
			.attr('stroke-width', 1.5)	
			.attr('fill', 'transparent') 
			.attr('width', gparam.nodeSize)
			.attr('height', gparam.nodeSize)
			.attr('stroke-dasharray', '6, 6');
			
	/*
	if (!urlImagem) {
		rectCor.attr('x', 0).attr('y', gparam.nodeSize);
		rect.attr('x', 0).attr('y', gparam.nodeSize);
	}
	*/
	//https://developer.mozilla.org/pt-BR/docs/Web/SVG/Element/animate
	/*
	var animateRect = Viva.Graph.svg('animate');
	animateRect.attr('attributeName','stroke-dashoffset').attr('values','0;180;0').attr('dur', '60s').attr('repeatCount','indefinite');
	rect.appendChild(animateRect);
	*/
	var [identificador, nome, nota] = labelsNo(node, gparam.kTipoRotulo); //node.data.label.split('\n');
	//var nota = node.data.nota? node.data.nota: '';
	//node.data.nota = nota;
	var svgText, textspan, textspan2, textspan3;
	if (gparam.btextoEmbaixoIcone) { //textp embaixo do ícone
		svgText = Viva.Graph.svg('text')
			.attr('pointer-events', 'none') //o texto não é mais clicável
			.attr('y', gparam.tamanhoFonte*1.1 + gparam.nodeSize) 
			.attr('x', gparam.nodeSize/2).attr('text-anchor','middle')
			.attr('font-size',gparam.tamanhoFonte+'px'); 
		textspan = Viva.Graph.svg('tspan').attr('x', gparam.nodeSize/2).attr('dy', 0).text(identificador);
		textspan2 = Viva.Graph.svg('tspan').attr('x', gparam.nodeSize/2).attr('dy', gparam.tamanhoFonte*1.1).text(nome);		
		textspan3 = Viva.Graph.svg('tspan').attr('x', gparam.nodeSize/2).attr('dy', gparam.tamanhoFonte*1.5)
			.attr('font-size',gparam.tamanhoFonte*1.5+'px').text(nota);
	} else { //texto à direita do ícone
		svgText = Viva.Graph.svg('text')
			.attr('pointer-events', 'none')
			.attr('y',  gparam.nodeSize*0.5+gparam.tamanhoFonte*0.5)
			.attr('x', gparam.nodeSize).attr('text-anchor','left')  
			.attr('font-size',gparam.tamanhoFonte+'px')
			.attr('style','font-family:Comic Sans MS;') ; 	
		textspan = Viva.Graph.svg('tspan').attr('x', gparam.nodeSize*1.2).attr('dy', 0).text(identificador);
		textspan2 = Viva.Graph.svg('tspan').attr('x', gparam.nodeSize*1.2).attr('dy', gparam.tamanhoFonte*1.1).text(nome);	
		textspan3 = Viva.Graph.svg('tspan').attr('x', gparam.nodeSize*1.2).attr('dy', gparam.tamanhoFonte*1.5)
			.attr('font-size',gparam.tamanhoFonte*1.5+'px').text(nota);
	}

	svgText.append(textspan);
	svgText.append(textspan2);			
	svgText.append(textspan3);	
	ui.insertAdjacentHTML('beforeEnd','<title>' + textoTooltip(node, true) + '</title>'); //title deve ser a primeira coisa apos g para funcionar no firefox 48
	ui.append(rectCor);
	ui.append(img);
	ui.append(rect);
	ui.append(svgText);
		
	let textoBandeira = textoFlag(node);
	if (textoBandeira) { //redflag
		var iconeFlag = 'flag_red.png';
		if (textoBandeira.startsWith('situacao_fiscal') && (textoBandeira.indexOf(LF)==-1)) { //se tiver situação fiscal não ativa e não baixada, e for unico texto de "flag", coloca bandeira cinza.
			iconeFlag = 'flag.png';
		}
		let redflag = Viva.Graph.svg('image');
		redflag.attr('width', gparam.nodeSize*0.6)
			.attr('height', gparam.nodeSize*0.6)
			.attr('x', gparam.nodeSize/2)
			.attr('y', -gparam.nodeSize/2)
			.link(baseImagem + iconeFlag); 
		ui.append(redflag);
	}
	
	ui.onmousedown = function(event) {  //estava onmouseup, assim dá pra congelar após click
		if (event.which == 1) {
			if (event.altKey) {
				//console.log('x1'); //ttt não funciona, apesar de chegar aqui, não está abrindo... Talvez alguma coisa a ver com o altKey??
				event.preventDefault();		
				menu_abrirNovaAba(node.id);			
				return;
			}

			if (!event.ctrlKey) {
				event.preventDefault();				
				selecionaNoid(node.id, event.shiftKey);
				//pinarNoTemp(node.id, 500); //pausar layout é melhor que só pinar o nó
				pausarLayout(1000); //500); //delay para facilitar duplo clique
			}
		} else if (event.which == 2) {
			//botão central abre edição de nota
			event.preventDefault();
			menu_editarNota(node.id);
		}
		return;
	};
	ui.ondblclick = function(event) {
		if (event.which == 1) {
			reativarLayout(); //click pausa layout, se for duplo click, já pode reativar
			event.preventDefault();
			if (node.id.startsWith('AR_') || node.id.startsWith('LI_')) {
				menu_abrirNovaAba(node.id);
			} else if (node.id.startsWith('ID_') && (!gparam.inicio.bBaseLocal)) {
				//
			} else {
				selecionaNoid(node.id, false);	
				//menu_incluir1Camada(node.id); 
				menu_incluir1Camada(''); 
			}
		};
		return;
	}; 
	ui.ontouchstart = function(event) {
		gparam.inicioToque = new Date().getTime();
	};
	
	ui.ontouchend = function(event) {
		//TODO verificar posição
		var currentTime = new Date().getTime();
		var tempoToque = currentTime - gparam.ultimoToque;
		gparam.ultimoToque = currentTime;
		if ((tempoToque<500) && (tempoToque > 0)) {
			//double tab ondblclick
			selecionaNoid(node.id, false);
			//menu_incluir1Camada(node.id); 
			menu_incluir1Camada(''); 
			event.preventDefault();
		} else {
			var touchLength = currentTime - gparam.inicioToque;
			if ((touchLength>=500) && (gparam.inicioToque!=0)) {
				gparam.inicioToque=0;
				//return false;
				return true;
			}
			//single tap onclick
			selecionaNoid(node.id, event.shiftKey);
			event.preventDefault();
		}
				
		return false;
	};
	ui.onmouseover = function(event) { 
		gparam.idNoOnHover = node.id; 
		// menu_dados(false, gparam.idNoOnHover); 
		return; 
	};
	ui.onmouseleave = function(event) { 
		gparam.idNoOnHover = null;
		// alertify.alert().close(); 
		return; 
	};
	return ui;
}).placeNode(function(nodeUI, pos) {
	// 'g' element doesn't have convenient (x,y) attributes, instead
	// we have to deal with transforms: http://www.w3.org/TR/SVG/coords.html#SVGGlobalTransformAttribute
	nodeUI.attr('transform', 'translate(' + (pos.x - gparam.nodeSize/2) + ',' + (pos.y - gparam.nodeSize/2) + ')');
}); //.graphics.node(function(node) 

graphics.link(function(link){

	var label = Viva.Graph.svg('text')
		//.attr('title', String(link.data.label))
		.attr('id','link_label_'+link.data.id)
		.attr('font-size',gparam.tamanhoFonte+'px')
		.attr('fill',link.data.cor)
		.text(cortastr(filtraTextoLigacao(String(link.data.label)),25));
	label.insertAdjacentHTML('beforeEnd','<title>' + String(link.data.label) + '</title>'); 
	//gparam.idLigacoes[link.data.origem + '\n' + link.data.destino] = link.data.id;
	graphics.getSvgRoot().childNodes[0].append(label);
	var vpath = Viva.Graph.svg('path')
		.attr('stroke', link.data.cor) // 'gray')
		.attr('marker-end', 'url(#Triangle)')
		.attr('id', link.data.id);
	//if ((link.data.origem.startsWith('ID_')) || (link.data.destino.startsWith('ID_')) || (link.data.destino.startsWith('EN_')) 
	//	|| (link.data.destino.startsWith('EM_')) || (link.data.destino.startsWith('TE_')) || (link.data.tipoDescricao=='link')) {
	//if (link.data.tipoDescricao=='link') {
	if (['link','end','email','tel'].includes(link.data.tipoDescricao)) {
		vpath.attr('stroke-dasharray', '5, 5');
	};
	return vpath
	}).placeLink(function(linkUI, fromPos, toPos) {
		var toNodeSize = gparam.nodeSize,
		fromNodeSize = gparam.nodeSize;

		var dyFromRotulo = (gparam.btextoEmbaixoIcone && !linkUI.link.fromId.startsWith('OO_'))? gparam.tamanhoFonte*2 : 0;
		var dyToRotulo = (gparam.btextoEmbaixoIcone && !linkUI.link.toId.startsWith('OO_'))? gparam.tamanhoFonte*2 : 0;
		
		var from = gparam.geom.intersectRect(
			fromPos.x - fromNodeSize / 2, // left
			fromPos.y - fromNodeSize / 2, // top
			fromPos.x + fromNodeSize / 2, // right
			fromPos.y + fromNodeSize / 2 + dyFromRotulo, // bottom
			fromPos.x, fromPos.y, toPos.x, toPos.y)
		|| fromPos;
		
		var to = gparam.geom.intersectRect(
			toPos.x - toNodeSize / 2, // left
			toPos.y - toNodeSize / 2, // top
			toPos.x + toNodeSize / 2, // right
			toPos.y + toNodeSize / 2 + dyToRotulo, // bottom
			// segment:
			toPos.x, toPos.y, fromPos.x, fromPos.y)
			|| toPos;
			
		var data = 'M' + from.x + ',' + from.y + 'L' + to.x + ',' + to.y;
		linkUI.attr("d", data);
		var elemento = document.getElementById('link_label_'+linkUI.attr('id'));
		elemento.attr("x", (from.x + to.x) / 2).attr("y", (from.y + to.y) / 2)
				.attr('visibility', gparam.bMostraLigacao? 'visible' : 'hidden');	

		// se for grande, deixa o texto do link na horizontal, se for menor alinha com a ligacao.
		if  (true) { 
		// if (elemento.textContent.length <= 2*20) { //20 caracteres, length é contado em dobro por causa do <title>
			// calcula o angulo para exibir o rótulo inclinado
			var angulo = 180.0/Math.PI* Math.atan2(toPos.y-fromPos.y,toPos.x - fromPos.x);
			var baseline = '-1';
			if (angulo>90) {
				angulo = -(180.0 - angulo);
				baseline = '-1';
			} else if (angulo<-90) {
				angulo = 180.0 + angulo;
				baseline = '-2';
			}
			elemento.attr("transform","rotate(" + parseFloat(angulo) + " " + parseInt((from.x + to.x) / 2) + "," 
				+ parseInt((from.y + to.y) / 2) + ") translate(0," + baseline + ")")
				.attr('text-anchor','middle')
				.attr('visibility', gparam.bMostraLigacao? 'visible' : 'hidden');
		} else { //se estava inclinado e o texto aumentou para ficar na horizontal, tem que remover o transform
			/*
			if (elemento.hasAttribute('transform')) {
				elemento.removeAttribute('transform');
			}
			elemento.attr('text-anchor','start'); */
		}
})//.graphics.link(function(link)

function filtraTextoLigacao(texto) {
	//remove texto do link para o gráfico ficar mais limpo
	var palavras = [];
	for (let k of texto.split(';')){
		var pedaco = (k.search(':')!=-1) ? k.split(':')[0] : k
		//if (['endereço','telefone','end','tel','email','link'].includes(pedaco.trim())) {
		if (['endereço','telefone','end','tel','email','google','chave'].includes(pedaco.trim())) {
			continue;
		}
		if (pedaco=='link') {
			palavras.push(k.replaceAll('link:',''));
		} else {
			palavras.push(k);
		}
	}	
	return palavras.join('; ');
} //.filtraTextoLigacao

function embaralhaTexto(t) {
	const shuffle = str => [...str].sort(()=>Math.random()-.5).join('');
	var lista = [];
	for (x of t.split(' ')) {
		var xs = shuffle(x);
		if (xs==x){
			xs = shuffle(x);
		}
		lista.push(xs);
	}
	return lista.join(' ');
} //.function embaralhaTexto

function ajustaRetanguloAnimado(nodeid, bSeleciona) {
	//ajusta posicao do retangulo para envolver o texto
	let nodeUI = graphics.getNodeUI(nodeid)
	let uirect = nodeUI.getElementsByTagName('rect')[1];
	if (bSeleciona) {
		
		//console.log(textBox);
		
		/* //criar o retangulo depois faz com que o item não aceite duplo clique
		var	uirect = Viva.Graph.svg('rect') //destacar se está selecionado
		//.attr('visibility', 'hidden') //hidden or visible	
		.attr('stroke', 'black') //'crimson'
		.attr('stroke-width', 1.5)	
		.attr('fill', 'transparent') 
		.attr('width', gparam.nodeSize)
		.attr('height', gparam.nodeSize)
		.attr('stroke-dasharray', '6, 6')
		.attr('visibility', 'visible');
		if (false) {
			let textBox = nodeUI.getElementsByTagName('text')[0].getBBox();
			//altera retangulo da seleção para envolver o texto
			uirect.attr('x', textBox.x).attr('y', textBox.y).attr('width', textBox.width).attr('height', textBox.height);
		}
		*/
		uirect.setAttribute('visibility', 'visible');
		var animateRect = Viva.Graph.svg('animate');
		animateRect.attr('attributeName','stroke-dashoffset').attr('values','0;180;0').attr('dur', '60s').attr('repeatCount','indefinite');
		uirect.appendChild(animateRect);
		
		//uirect.setAttribute('class', 'disabled');
		//var uitexto = nodeUI.getElementsByTagName('text')[0];
		//nodeUI.appendBefore(uirect, uitexto);
		//nodeUI.append(uirect);
		//nodeUI.getElementsByTagName('rect')[1].setAttribute('visibility', 'visible');
	} else {
		uirect.setAttribute('visibility', 'hidden');
		var animateRectList = uirect.getElementsByTagName('animate');
		//gparam.debug = uirect;
		if (animateRectList.length) {
			uirect.removeChild(animateRectList[0]);
		}
		//var uirect = nodeUI.getElementsByTagName('rect')[1];
		//nodeUI.removeChild(uirect);
	}
} //.function ajustaRetanguloAnimado

function selecionaNoid(nodeid, shift_pressionado, selecionaRetangular) {
	// ativa retângulo em torno do ícone do nó.
	// se o shift está pressionado, pode ter mais de um nó. Se o nó já estiver selecionado, shift_pressionado inverte estado da seleção para nodeid
	// quando node=null e shift_pressionado=false, remove todos os nós da seleção.
	//selecionaRetangular=true, seleciona, não inverte
	var nodeEstavaSelecionado = false;
	//gparam.camadaIdExpandido = {}; //reseta memória de camada
	if (nodeid) {
		nodeEstavaSelecionado = gparam.idNosSelecionados.has(nodeid);
		if (nodeEstavaSelecionado) {
			if (selecionaRetangular) { //se o nó já estava selecionado e com selecao retangular, não há o que fazer.
				return;
				//nodeEstavaSelecionado=false; //fazer isso pode ignorar que o objeto animação já exista e criar outro.
			}
		}
	} else {
		for (let n of gparam.idNosSelecionados) {
			ajustaRetanguloAnimado(n, false);
			//graphics.getNodeUI(n).getElementsByTagName('rect')[1].setAttribute('visibility', 'hidden');  //hidden or visible)		
		}
		gparam.idNosSelecionados = new Set(); 
		gparam.idnoSelecionado = null;
		return;
	}
	if (shift_pressionado) {
		if (nodeEstavaSelecionado) {
			gparam.idnoSelecionado = null;
			gparam.idNosSelecionados.delete(nodeid);
			ajustaRetanguloAnimado(nodeid, false);
			//graphics.getNodeUI(nodeid).getElementsByTagName('rect')[1].setAttribute('visibility', 'hidden');
		} else {
			gparam.idnoSelecionado = nodeid;
			gparam.idNosSelecionados.add(nodeid);
			ajustaRetanguloAnimado(nodeid, true);
			//graphics.getNodeUI(nodeid).getElementsByTagName('rect')[1].setAttribute('visibility', 'visible');
		}
	} else {
		for (let n of gparam.idNosSelecionados) {
			ajustaRetanguloAnimado(n, false);
			//graphics.getNodeUI(n).getElementsByTagName('rect')[1].setAttribute('visibility', 'hidden');  //hidden or visible)		
		}
		gparam.idNosSelecionados = new Set(); 
		gparam.idnoSelecionado = nodeid;
		if (nodeid) {
			ajustaRetanguloAnimado(nodeid, true);
			//graphics.getNodeUI(nodeid).getElementsByTagName('rect')[1].setAttribute('visibility', 'visible');  //hidden or visible)
			gparam.idNosSelecionados.add(nodeid);
			gparam.idnoSelecionado = nodeid;
		}
	}
	//ajusta menu contextual
	//ajustaMenuContextual(nodeid);
	return;
} //.function selecionaNoid

gparam.AreaSelecaoRetangular = {
	Setup:function() {
		/*seleção retangular */
		var multiSelectOverlay;
		document.addEventListener('keydown', function(e) {
			if (e.which === 17 && !multiSelectOverlay) { // ctrl key
				multiSelectOverlay = gparam.AreaSelecaoRetangular.startMultiSelect(graph, gparam.renderer, gparam.layout);
			}
			if (e.which != 17 && multiSelectOverlay) { // pressionou outro botão (corrige problema quando se pressiona CTRL+botão para outro comando, que o tipo de cursor não mudava para o padrão
				multiSelectOverlay.destroy();
				multiSelectOverlay = null;
			}

		});
		document.addEventListener('keyup', function(e) {
			if (e.which === 17 && multiSelectOverlay) {
				multiSelectOverlay.destroy();
				multiSelectOverlay = null;
			}
		});
	}, startMultiSelect: function(graph, renderer, layout) {
		var graphics = renderer.getGraphics();
		var domOverlay = document.querySelector('.graph-overlay');
		var overlay = gparam.AreaSelecaoRetangular.createOverlay(domOverlay);
		overlay.onAreaSelected(handleAreaSelected);
	  
		return overlay;

		function handleAreaSelected(area) {
			// For the sake of this demo we are using silly O(n) implementation.
			// Could be improved with spatial indexing if required.
			var topLeft = graphics.transformClientToGraphCoordinates({
			  x: area.x,
			  y: area.y
			});

		var bottomRight = graphics.transformClientToGraphCoordinates({
			x: area.x + area.width,
			y: area.y + area.height
		});

		graph.forEachNode(higlightIfInside);
		renderer.rerender();

		return;

		function higlightIfInside(node) {
			var nodeUI = graphics.getNodeUI(node.id);
			if (isInside(node.id, topLeft, bottomRight)) {
				selecionaNoid(node.id, true, true);
			}
		}
		 
		function isInside(nodeId, topLeft, bottomRight) {
			var nodePos = layout.getNodePosition(nodeId);
			return ((topLeft.x < nodePos.x) && (nodePos.x < bottomRight.x) &&
				(topLeft.y < nodePos.y) && (nodePos.y < bottomRight.y));
		}
	  }
	}, createOverlay: function(overlayDom) {
		var selectionClasName = 'graph-selection-indicator';
		var selectionIndicator = overlayDom.querySelector('.' + selectionClasName);
		if (!selectionIndicator) {
			selectionIndicator = document.createElement('div');
			selectionIndicator.className = selectionClasName;
			overlayDom.appendChild(selectionIndicator);
		}	

		var notify = [];
		var dragndrop = Viva.Graph.Utils.dragndrop(overlayDom);
		var selectedArea = {
			x: 0,
			y: 0,
			width: 0,
			height: 0
		};
		var startX = 0;
		var startY = 0;

		dragndrop.onStart(function(e) {
			startX = selectedArea.x = e.clientX;
			startY = selectedArea.y = e.clientY;
			selectedArea.width = selectedArea.height = 0;
			updateSelectedAreaIndicator();
			selectionIndicator.style.display = 'block';
		});

		dragndrop.onDrag(function(e) {
			recalculateSelectedArea(e);
			updateSelectedAreaIndicator();
			notifyAreaSelected();
		});

		dragndrop.onStop(function() {
			selectionIndicator.style.display = 'none';
		});

		overlayDom.style.display = 'block';

		return {
			onAreaSelected: function(cb) {
				notify.push(cb);
			},
			destroy: function () {
				overlayDom.style.display = 'none';
				dragndrop.release();
			}
		};

		function notifyAreaSelected() {
			notify.forEach(function(cb) {
				cb(selectedArea);
			});
		}

		function recalculateSelectedArea(e) {
			var bcr = document.getElementById('principal').getBoundingClientRect();
			selectedArea.width = Math.abs(e.clientX - startX);
			selectedArea.height = Math.abs(e.clientY - startY);
			selectedArea.x = Math.min(e.clientX, startX)- bcr.x;
			selectedArea.y = Math.min(e.clientY, startY)- bcr.y;
		}

		function updateSelectedAreaIndicator() {
			var bcr = document.getElementById('principal').getBoundingClientRect();
			selectionIndicator.style.left = (selectedArea.x) + 'px';
			selectionIndicator.style.top = (selectedArea.y) + 'px';
			selectionIndicator.style.width = selectedArea.width + 'px';
			selectionIndicator.style.height = selectedArea.height + 'px';
		}	
	}
} //.gparam.AreaSelecaoRetangular

/* Para usar a seleção retangular, criar a seguinte função depois de scale na função svgGraphics() em vivagraph.js
		transformClientToGraphCoordinates :  function (position) {
            var p = svgRoot.createSVGPoint(),
                t = svgContainer.getCTM(),
                origin = svgRoot.createSVGPoint().matrixTransform(t.inverse());

            p.x = 0;//dx;
            p.y = 0; //dy;

            p = p.matrixTransform(t.inverse());
            p.x = (p.x - origin.x) * t.a;
            p.y = (p.y - origin.y) * t.d;

            t.e += p.x;
            t.f += p.y;
			//return {scale:t.d, ox:t.e,oy:t.f};
			var pos={};
			pos.x = (position.x - t.e) / t.d;
			pos.y = (position.y - t.f) / t.d;

			return pos;
		},
*/
//.gparam.AreaSelecaoRetangular

// outra alteração no vivagraph.js: para renderizar os links atrás dos nós: (parece que não funciona)
/*    function createSvgRoot() {
        var svgRoot = svg("svg");
		//https://github.com/gg4u/VivaGraphJS/commit/0547568448ea7e17e6558798fadbaa054ca4f104#diff-2ee351279fcef17bd76b6d9d4eef748e1a133b3fa07bd336c64778e64b9f61e7
		//readability in svg : group nodes and links 
        svgContainer = svg("g")
              //.attr("buffered-rendering", "dynamic");
              .attr("buffered-rendering", "dynamic").attr("id", "scene");

        // group nodes and links for readability of elements  
        svgNodes = svg("g").attr("id", "nodes");
        svgEdges = svg("g").attr("id", "edges");

        svgContainer.appendChild(svgEdges);
        svgContainer.appendChild(svgNodes);
		//.readability in svg : group nodes and links 
        svgRoot.appendChild(svgContainer);

        return svgRoot;
    }
*/

function localizaNo(texto, bFiltroNosSelecionados) { //retorna n. de nos localizados
	//bFiltroNosSelecionados, só procura em idNosSelecionados, senão procura em todos os itens
	var textoU = texto.toUpperCase(); 
	var idNosLocalizados= new Set(); 
	var primeiroNoid = null;
	texto = texto.trim().replace(/\n/g,';').replace(/\t/g,';');
	if (texto.search(' ')>=0) {
		let bEspaco = confirm('O texto a procurar tem espaço(s). Utiliza espaço como separador?');
		if (bEspaco) {
			texto = texto.replace(/\s/g,';')
		}
	}
	graph.forEachNode(function(node){
		for (let taux of texto.toUpperCase().split(';')) { //usa ; como separador para busca de mais de um termo
			let t = taux.trim();
			if (!t) continue;
			if ((node.id.toUpperCase().search(t)!= -1) || (node.data.descricao.toUpperCase().search(t)!=-1)
				|| (node.data.nota.toUpperCase().search(t)!= -1)) {
				if ((!bFiltroNosSelecionados) || ((bFiltroNosSelecionados) && (gparam.idNosSelecionados.has(node.id)))) {
					idNosLocalizados.add(node.id);
					if (!primeiroNoid) {
						primeiroNoid = node.id;
					}
				}
			}
		}
	});
	return selecionaSet(idNosLocalizados, primeiroNoid);
} //.function localizaNo

function selecionaSet(sidNos, primeiroNoid) {
	//seleciona um set de ids, se primeiroNoid for informado, centraliza nesse id
	if (sidNos.size) {
		selecionaNoid(null, false); //apaga seleção primeiro
		for (let n of sidNos) {
			selecionaNoid(n, true);
		}
		if (primeiroNoid) {
			if (gparam.idNosSelecionados.has(primeiroNoid)) {
				gparam.idnoSelecionado = primeiroNoid;
				//ajustaMenuContextual(gparam.idnoSelecionado);
				//var position = gparam.renderer.getLayout().getNodePosition(gparam.idnoSelecionado);
				var position = gparam.layout.getNodePosition(gparam.idnoSelecionado);
				gparam.renderer.moveTo(position.x, position.y);
			} else {
				alertify.error('erro na funcao selecionaSet');
			}
		}
		return gparam.idNosSelecionados.size;
	} else {
		return 0;
	}
} //.function selecionaSet

function menu_localiza(bFiltroNosSelecionados) {
	//bFiltroNosSelecionados, só procura em idNosSelecionados, senão procura em todos os itens
	ativaAtalhos(false);
	var brenderer = menu_rendererAtivarParar(false, false);
	var tmensagem = bFiltroNosSelecionados? 'Filtrar nos itens selecionados':'Localizar item na tela'; 
	alertify.prompt( tmensagem, 'Digite partes do Nome, CNPJ ou CPF. Utilize ponto e vírgula (;) como separador para buscar mais de um termo.', ''
	   , function(evt, texto) { 
			if (texto) { 
				contagem = localizaNo(texto, bFiltroNosSelecionados);
				if (contagem) {
					alertify.success('Localizou '+ contagem + ' ocorrencias(s) de ' + texto);
				} else {
					alertify.error('Não localizou ' + texto);
				};
			}
			menu_rendererAtivarParar(brenderer, false);
			ativaAtalhos(true);
		}, function() { 
			ativaAtalhos(true);
			menu_rendererAtivarParar(brenderer, false);
		});
} //.function menu_localiza

function menu_localizaPorCampo(bFiltroNosSelecionados) {
	//bFiltroNosSelecionados, só procura em idNosSelecionados, senão procura em todos os itens
	function localizaNoPorCampo(texto, bFiltroNosSelecionados) { //retorna n. de nos localizados
		//bFiltroNosSelecionados, só procura em idNosSelecionados, senão procura em todos os itens
		var idNosLocalizados= new Set(); 
		var primeiroNoid = null;
		var comparacoes = texto.split(';');
		graph.forEachNode(function(node){
			var data = node.data;
			var campo, valor, valorDif;
			for (let comp of comparacoes) {
				var [campo, valorDif] = comp.split('<>');
				if (!valorDif) {
					var [campo, valor] = comp.split('=');
				}
				//valor = replaceAll(replaceAll(valor, '"', ''), "'", "");
				valor = valor.replaceAll( '"', '').replaceAll( "'", "");
				if (data[campo]) {
					if ( (Boolean(valor) && (data[campo]==valor)) ||
						(Boolean(valorDif) && (data[campo]!=valorDif))) {
						idNosLocalizados.add(node.id);
						if (!primeiroNoid) {
							primeiroNoid = node.id;
						}
					}
				}
			}
		});
		return selecionaSet(idNosLocalizados, primeiroNoid);
	} //.function localizaNoPorCampo
	ativaAtalhos(false);
	var brenderer = menu_rendererAtivarParar(false, false);
	var tmensagem = bFiltroNosSelecionados? 'Filtrar nos itens selecionados':'Localizar item na tela por campo'; 
	alertify.prompt( tmensagem, 'Digite o nome do parâmetro do campo, por exemplo, cor="red"', ''
	   , function(evt, texto) { 
			if (texto) { 
				contagem = localizaNoPorCampo(texto, bFiltroNosSelecionados);
				if (contagem) {
					alertify.success('Localizou '+ contagem + ' ocorrencias(s) de ' + texto);
				} else {
					alertify.error('Não localizou ' + texto);
				};
			}
			menu_rendererAtivarParar(brenderer, false);
			ativaAtalhos(true);
		}, function() { 
			ativaAtalhos(true);
			menu_rendererAtivarParar(brenderer, false);
		});
} //.function menu_localizaPorCampo

function menu_localiza_adjacentes(bFiltroNosSelecionados) {
	//bFiltroNosSelecionados, só procura em idNosSelecionados, senão procura em todos os itens
	//ativaAtalhos(false);
	var brenderer = menu_rendererAtivarParar(false, false);
	var idNosLocalizados = new Set();
	for (let noId of gparam.idNosSelecionados) {
		graph.forEachLinkedNode(noId, function(nodeaux, link){
			idNosLocalizados.add(nodeaux.id);
		});	
	}
	menu_rendererAtivarParar(brenderer, false);
	if (idNosLocalizados.size) {
		//selecionaNoid(null, false); //apaga seleção primeiro
		for (let n of idNosLocalizados) {
			//graphics.getNodeUI(n).getElementsByTagName('rect')[1].setAttribute('visibility', 'visible'); 
			//gparam.idNosSelecionados.add(n);
			selecionaNoid(n, true, true); 
		}
		alertify.success('Localizou '+ idNosLocalizados.size + ' adjacentes');
		gparam.camadaIdExpandido = {}; 
		return idNosLocalizados.size;
	} else {
		return 0;
	}
} //.function menu_localiza_adjacentes

function menu_localiza_componente() {
	var brenderer = menu_rendererAtivarParar(false, false);
	var idNosLocalizados = new Set(gparam.idNosSelecionados);
	var tamanhoAnterior = -1;
	while (true) {
		var idNosLocalizadosFor = new Set(idNosLocalizados);
		//var idNosLocalizados = new Set();
		for (let noId of idNosLocalizadosFor) {
			graph.forEachLinkedNode(noId, function(nodeaux, link){
				idNosLocalizados.add(nodeaux.id);
			});	
		}
		if (tamanhoAnterior==idNosLocalizados.size) {
			break;
		}
		tamanhoAnterior = idNosLocalizados.size;
	}
	menu_rendererAtivarParar(brenderer, false);
	if (idNosLocalizados.size) {
		//selecionaNoid(null, false); //apaga seleção primeiro
		for (let n of idNosLocalizados) {
			//graphics.getNodeUI(n).getElementsByTagName('rect')[1].setAttribute('visibility', 'visible'); 
			//gparam.idNosSelecionados.add(n);
			selecionaNoid(n, true, true); 
		}
		if (gparam.idNosSelecionados.size == graph.getNodesCount()) { 
			alertify.success('Todo o gráfico foi selecionado, com '+ idNosLocalizados.size + ' itens');
		} else {
			alertify.success('Localizou '+ idNosLocalizados.size + ' adjacentes');
		}
		return idNosLocalizados.size;
	} else {
		return 0;
	}

} //.function menu_localiza_componente

function menu_botao_caminhos() {
	if (gparam.idNosSelecionados.size<2) {
		alertify.error('Para usar a rotina de caminhos, deve haver ao menos dois itens selecionados. Faça shift+click para selecionar mais itens.');
		return false;
	}
	var camada = prompt('Digite a camada a procurar. A camada é a partir de cada item, por isso pode encontrar caminhos até o dobro de camada. O valor máximo é 5. Se não encontrar caminho com os itens no gráfico, procura mais dados no servidor.', 3);
	if (camada===null) {
		return false;
	}
	camada = parseInt(camada); 
	if (!camada) {
		return
	}
	if (camada>5) {
		alert('Utilize camada abaixo de 5');
		return false;
	}
	menu_caminhos(camada, '', false);
} //. function menu_botao_caminhos

function menu_caminhos(camadaIn, criterioCaminhos, bBuscarNoServidor) { 
	var kitens_encontrados, resp;
	var kitensIniciais = gparam.idNosSelecionados.size;
	if (kitensIniciais<2) {
		alertify.error('Para usar a rotina de caminhos, deve haver ao menos dois itens selecionados.');
		return false;
	} else if (kitensIniciais>10) {
		resp = confirm('Fazer a busca de caminhos de muitos itens pode travar o navegador. Deseja prosseguir?');
		if (!resp) {
			return false;
		}
	} 
	if (!bBuscarNoServidor) {
		kitens_encontrados = menu_caminhos_na_tela(2*camadaIn, criterioCaminhos);
		if (kitens_encontrados) {
			if (kitens_encontrados<kitensIniciais) {
				alertify.warning('Não encontrou caminhos para todos os itens no gráfico atual. Para buscar dados no servidor, pressione CTRL+SHIFT+Número');
			} else {
				alertify.success('Encontrou caminho entre os itens no gráfico atual. Esses elementos foram selecionados.');
			}
			return;
		} else {
			resp = confirm('Não encontrou caminho no gráfico atual. Deseja buscar dados no servidor?');
			if (!resp) {
				return;
			}
		}
	}
	if (criterioCaminhos){
		criterioCaminhos = 'caminhos-' + criterioCaminhos;
	} else {
		criterioCaminhos = 'caminhos';
	}
	//camadaInsercao = (Math.floor(camadaIn/2)==camadaIn/2)? Math.floor(camadaIn/2) : Math.floor(camadaIn/2)+1;
	menu_incluirCamada('', camadaIn, criterioCaminhos); //faz chamada ao servidor
} //.function menu_caminhos

function menu_caminhos_na_tela(camada, criterioCaminhos) { 
	//ativaAtalhos(false);
	var brenderer = menu_rendererAtivarParar(false, false);

	//var camada = camadaIn*2; //+2;
	var idNosLocalizados = new Set();
	var camadasItem = {};

	document.body.style.cursor = 'wait';
	for (let noId of gparam.idNosSelecionados) {	
		var dcamada = {0:[noId,]};
		var itensCamadaAnterior = new Set([noId,]);
		var itensVisitados=new Set([noId,]);
		for (let cam=1; cam<=camada; cam++) {
			var itensNaCamada=new Set();	
			for (idr of dcamada[cam-1]) {
				graph.forEachLinkedNode(idr, function(naux, link){
					if ((naux.id!=idr) && (!itensVisitados.has(naux.id))) {
						itensNaCamada.add(naux.id);
					}
					itensVisitados.add(naux.id);
				})
			}
			//console.log([...itensNaCamada]);
			dcamada[cam] = [...itensNaCamada];
		}
		camadasItem[noId] = JSON.parse(JSON.stringify(dcamada));
	}
	var bAtendeCriterio;
	for (let no1 of gparam.idNosSelecionados) {	
		for (let no2 of gparam.idNosSelecionados) {	
			if (no1>=no2) continue;
			for (let cam=1; cam<=camada; cam++) {
				var scam = new Set(camadasItem[no1][cam]);
				if (scam.has(no2)){
					if (criterioCaminhos) {		
						bAtendeCriterio = false;					
						var nota1 = graph.getNode(no1).data.nota;
						var nota2 = graph.getNode(no2).data.nota;
						if (nota1 && nota2) {
							if (criterioCaminhos=='intra') {
								if (nota1==nota2) {
									bAtendeCriterio = true;
								}
							} else if (criterioCaminhos=='extra') {
								if (nota1!=nota2) {
									bAtendeCriterio = true;
								}						
							}
						}
					} else {
						bAtendeCriterio = true;
					}
					if (!bAtendeCriterio) continue;
					//encontrou, então faz ordem inversa
					idNosLocalizados.add(no2);
					idNosLocalizados.add(no1);
					for (let cam2=1; cam2<cam; cam2++) {
						var scam1 = new Set(camadasItem[no1][cam-cam2])
						var scam2 = new Set(camadasItem[no2][cam2]);
						for (let idaux of scam2) { //intersecção
							if (scam1.has(idaux)) {
								idNosLocalizados.add(idaux);
							}
						}
					}
					break;
				}
			}
		}
	}
	var kitensOrigemLocalizados=0;
	for (idc of idNosLocalizados) {
		if (gparam.idNosSelecionados.has(idc)) {
			kitensOrigemLocalizados += 1;
		}
	}

	for (idc of idNosLocalizados) {
		selecionaNoid(idc, true, true); 
	}

	menu_rendererAtivarParar(brenderer, false);
	document.body.style.cursor = 'default';
	return kitensOrigemLocalizados; //idNosLocalizados.size;

} //.function menu_caminhos_na_tela

function menu_localiza_CaminhosEntreitensComNotas(criterioCaminhos) {
	if (gparam.idNosSelecionados.size<=1) {
		var cont = menu_localiza_itensComNotas(false);	
		if (!cont) {
			alertify.error('Para usar esta rotina, deve haver itens com notas.');
			return;
		}
	}
	if (criterioCaminhos) {
		let dicItens = menu_incluirCamada_dicItemNota();
		if (Object.keys(dicItens).length==0) { // (dicItens) { dicItens == true??
			alert('Para usar esta opção de caminhos, os itens devem ter Anotações para identificar os grupos. Para adicionar uma anotação, clique com o botão da roda.');
			return false;
		}
	}
	var camada = prompt('Distância máxima aproximada entre os itens', 2);
	if (camada===null) {
		return;
	}
	camada = parseInt(camada);
	//menu_caminhos_na_tela(camada, criterioCaminhos);
	menu_caminhos(camada, criterioCaminhos, false) 
} //.function menu_localiza_CaminhosEntreitensComNotas

function menu_localiza_itensComMaisLigacoes() {
	var dcontagem = {};
	var bMudou = false;
	graph.forEachLink(function(link){
		dcontagem[link.fromId] = dcontagem[link.fromId] ? dcontagem[link.fromId]+1 : 1;
		dcontagem[link.toId] = dcontagem[link.toId] ? dcontagem[link.toId]+1 : 1;
	});
	listaESeleciona(dcontagem, 'Itens com mais ligações');
} //.function menu_localiza_itensComMaisLigacoes

function listaESeleciona(dcontagem, texto) {
	const listaIdContagem = Object.entries(dcontagem).sort(([,a],[,b]) => b-a);
	var tmaiores = texto + '\n\nN - ID: CONTAGEM\n\n';
	var k=0;
	var listaIds = [];
	for (const element of listaIdContagem) {
		k += 1;
		if (k<=15) {
			tmaiores += '' + k + ' - ' + element[0] + ': ' + element[1] + '\n';
		}
		listaIds.push(element[0]);
		if (k>=100) break;
	}
	tmaiores += '\n\nDeseja selecionar quantos itens?';
	var nids = prompt(tmaiores, Math.min(k,15));
	nids = parseInt(nids);
	if (!nids) return;
	selecionaSet(new Set(listaIds.slice(0,nids))); //, listaIds[0]);
	alertify.success('Os itens ' + listaIds.slice(0,nids) + ' foram selecionados');
} //.function listaESeleciona

function menu_localiza_itensLigadosAColoridos() {
	var dcontagem = {};
	var bMudou = false;
	graph.forEachLink(function(link){
		var corFrom = graph.getNode(link.fromId).data.cor ? 1: 0;
		var corTo = graph.getNode(link.toId).data.cor? 1:0 ;
		dcontagem[link.fromId] = dcontagem[link.fromId] ? dcontagem[link.fromId]+corTo : corTo;
		dcontagem[link.toId] = dcontagem[link.toId] ? dcontagem[link.toId]+corFrom : corFrom;
	});
	listaESeleciona(dcontagem, 'Ligados a itens marcados');
} //.function menu_localiza_itensLigadosAColoridos

function menu_localiza_itensComNotas(bMensagem) { 
	var setNos = new Set();
	graph.forEachNode( function(node) { 
		if (graph.getNode(node.id).data.nota) {
			setNos.add(node.id);
		}
	});
	var cont = selecionaSet(setNos);
	if (!bMensagem) {
		return cont;
	}
	if (cont) {
		alertify.success('Foram encontrados ' + cont + ' itens com Notas');
	} else {
		alertify.error('Não foi encontrado item com Nota');
	}
} //.function menu_localiza_itensComNotas

function menu_rendererAtivarParar(bAtivar, bMostraMensagem) {
	var estadoAnterior = gparam.bRenderAtivado;
	if (!bAtivar) {
		gparam.renderer.pause();
		if (bMostraMensagem && gparam.bRenderAtivado) {
			alertify.success('O leiaute foi pausado. Para ativar, pressione a Barra de Espaço.');
		}
	} else {
		gparam.renderer.resume();
		if (bMostraMensagem && !gparam.bRenderAtivado) {
			alertify.success('O leiaute foi reiniciado. Para parar, pressione a Barra de Espaço.');
		}
	}
	gparam.bRenderAtivado = bAtivar;
	return estadoAnterior;
} //.function menu_rendererAtivarParar

function pausarLayout(milissegundos) {
	if (!gparam.bRenderAtivado) {
		return;
	}
	gparam.renderer.pause();
	gparam.layout_suspenso = true;
	setTimeout(
		function() { 
			if (gparam.bRenderAtivado) {
				gparam.renderer.resume();
				gparam.layout_suspenso = false;
			};
		}, milissegundos
	);
} //.function pausarLayout

function reativarLayout() {
	if (gparam.layout_suspenso) {
		gparam.renderer.resume();
		gparam.layout_suspenso = false;
	}
} //.function reativarLayout

function removeIdNo(noId) { 
	//remover o nó da lista de nós
	//remover ligações que partem do nó e que chegam ao nó
	//procura label do link para remover
	graph.forEachLinkedNode(noId, function(nodeaux, link){
		var linkUIaux=null;
		try {
			linkUIaux = graphics.getLinkUI(link.id);
			element=document.getElementById('link_label_'+linkUIaux.attr('id'));
			element.parentNode.removeChild(element);
		} catch (e){; };
	});
	graph.removeNode(noId);
	//remove no da lista de selecionados
	gparam.idNosSelecionados.delete(noId);
	if (gparam.idnoSelecionado==noId) {
		gparam.idnoSelecionado=null;
	}
	gparam.camadaIdExpandido = {};
} //.function removeIdNo


function menu_excluirNosSelecionados(bSemConfirmar) {
	if (!gparam.idNosSelecionados.size) {
		if (!bSemConfirmar) {
			alertify.alert('Exclusão', 'Não há itens selecionados para exclusão. Selecione e tente novamente.', function(){ ; });
		}
		return;
	}
	var tmensagem = (gparam.idNosSelecionados.size==1) ? 'Excluir 1 nó.' : ('Excluir '+ gparam.idNosSelecionados.size + ' nós selecionados.');
	var tsucesso = (gparam.idNosSelecionados.size==1) ? '1 nó foi excluído.' : (gparam.idNosSelecionados.size + ' nós foram excluídos.');
	var fExcluir = function(){ 
		for (let n of gparam.idNosSelecionados) {
			removeIdNo(n);
		}			
		gparam.idnoSelecionado=null;
		alertify.success(tsucesso);
	};
	if (bSemConfirmar) {
		fExcluir();
		return;
	}
	alertify.confirm(tmensagem, 'Deseja prosseguir? Não será possível reverter a exclusão.', 
			fExcluir
            , function(){ ;}
	);
} //.function menu_excluirNosSelecionados

function menu_excluirTudo() {
	var setNos = new Set();
	graph.forEachNode( function(node) { 
		setNos.add(node.id);
	});
	alertify.confirm('Excluir todos os '+ setNos.size +  ' nós.', 'Deseja prosseguir? Não será possível reverter a exclusão.', 
			function(){ 
				for (let n of setNos) {
					removeIdNo(n);
				}			
				alertify.success(setNos.size + ' nós foram excluídos.') 
			}
            , function(){ ;}
	);
} //.function menu_excluirTudo

function excluirNoMantendoLinks() { 
	if (gparam.idNosSelecionados.size!=3) {
		alertify.error('Para usar esta rotina, deve haver três itens selecionados.');
		return;
	}
	var listaNos = [...gparam.idNosSelecionados];
	resp = confirm('Deseja remover o item ' + listaNos[1] + '?');
	if (!resp) {
		return;
	}
	removeIdNo(listaNos[1]);
	selecionaSet(new Set([listaNos[0], listaNos[2]]));
	menu_ligar_selecionados(false, '', true);
} //.function excluirNoMantendoLinks

function menu_inserirDesfazer() {
	var idNosInseridos = gparam.listaIdNosInseridos.pop();
	if (!idNosInseridos) return;
	var tam = idNosInseridos.size;
	for (let n of idNosInseridos) {
		removeIdNo(n);
	}
	var tmensagem = (tam==1 ? 'Foi removido um nó.' : ('Foram removidos ' + tam + ' nós.'))
	alertify.success(tmensagem);
	gparam.camadaIdExpandido = {}; //reseta idExpandidos
} //.menu_inserirDesfazer

function dadosEmHtmlPJ(d, noData) {
	//for (var i of Object.entries(gparam.json)) {
	//	texto += '<b>' + i[0] + ':<b> ' + i[1] + '<br> '; }
	var ht = '';
	ht += "<b>CNPJ:</b> " + d['cnpj_formatado'] + " - " + d['matriz_filial'] + "<br>";
	ht += "<b>Razão Social:</b> "+d['razao_social'] +  "<br>";
	ht += "<b>Nome Fantasia:</b> "+d['nome_fantasia'] + "<br>";
	ht += "<b>Data início atividades:</b> "+d['data_inicio_atividades']+"<br>";
	ht += "<b>Situação:</b> "+d['situacao_cadastral']+" <b>Data Situação:</b> "+d['data_situacao_cadastral']+"<br>";
	ht += "<b>Motivo situação:</b> "+d['motivo_situacao_cadastral'] +"<br>";
	ht += "<b>Natureza jurídica:</b> "+d['natureza_juridica'] +"<br>";
	ht += "<b>Porte empresa:</b> "+d['porte_empresa'] +"<br>";
	ht += "<b>Opção MEI:</b> "+d['opcao_mei'] +"<br>";
	ht += "<b>Capital Social:</b> R$ "+d['capital_social'] +"<br>";
	ht += "<b>Endereço:</b> "+d['endereco'] +"<br>";
	if (d['uf']!='EX') {
		ht += "<b>Municipio:</b> "+d['municipio']+"/"+d['uf'] + " - <b>CEP:</b>" + d['cep'] +"<br>";
	} else {
		ht += "<b>Municipio:</b> "+d['municipio']+"<br>";
		ht += "<b>País:</b> "+d['pais']+"<br>";
	}
	ht += "<b>Telefone:</b> "+d['ddd1']+" "+ d['telefone1']+"  "+d['ddd2']+" "+d['telefone2'] +"<br>";
	ht += "<b>Fax:</b> "+d['ddd_fax']+" "+d['fax'] +"<br>";
	ht += "<b>Email:</b> "+d['correio_eletronico'] +"<br>";

	ht += "<b>CNAE:</b> "+d['cnae_fiscal'] +"<br>";
	ht += "<b>CNAE Secundária:</b> "+cortastr(d['cnae_secundaria'], 250) +"<br>"; 
	if (noData.nota) {
		ht += "<br><b>Nota:</b> "+ noData.nota + "<br>";
	}
	camposPJ = ['cnpj', 'cnpj_formatado', 'matriz_filial', 'razao_social', 'nome_fantasia', 'data_inicio_atividades', 'situacao_cadastral',
				'data_situacao_cadastral', 'motivo_situacao_cadastral', 'natureza_juridica', 'cnae_fiscal', 'cnae_secundaria', 'porte_empresa', 'opcao_mei',
				'endereco', 'municipio', 'uf', 'cep', 'nm_cidade_exterior', 'nome_pais', 'nm_cidade_exterior', 'pais',
				'ddd1', 'telefone1', 'ddd2', 'telefone2', 'ddd_fax', 'fax', 'correio_eletronico', 'capital_social'
				];
	for (let k of camposPJ) {
		d[k] = '';
	}
	return ht;
} //.dadosEmHtmlPJ

function cortastr(s, tam) {
	if (!s) {
		return '';
	} else if (s.length>tam) {
		return s.substr(0, tam) + '...'; //' (...)';
	} else {
		return s;
	}
} //.function cortastr

function mensagemErroHttp(response) {
	let terro = 'Erro http ' +  response.status + ' - ' + response.statusText;
	console.log(terro);
	document.body.style.cursor = 'default';
	if (response.status==429) {
		alertify.error(terro +'. Aguarde e tente novamente. ');
	} else {
		alertify.error(terro);
	}
} //.mensagemErroHttp

function menu_dados(bNovaJanela, idNo) {
	var idin = idNo? idNo : gparam.idnoSelecionado;

	if (bNovaJanela) {
		if (idNo) {
			window.open(base+'consulta_cnpj/?cnpj='+idNo.substr(3));
		} else {
			var listaIds = [...gparam.idNosSelecionados].filter(function(id) {return id.startsWith('PJ_');}).slice(0,100).join('; ');
			window.open(base+'consulta_cnpj/?cnpj='+listaIds);
		}
		return;
	}

	if (!idin) return;
	/*
	if (bNovaJanela && idin.startsWith('PJ_')) {
		window.open(base+'consulta_cnpj/?cnpj='+idin.substr(3));
		return;
	}*/

	function mostraResultado(idin, ht) {
		if (bNovaJanela) { 
				//var win = window.open('/rede/dados_janela/'+gparam.idnoSelecionado, gparam.idnoSelecionado,'resizable,scrollbars,status,menubar=no, toolbar=no, personalbar=no, location=no, titlebar=0, height=500, width=400');
				var win = window.open('', idin,'resizable,scrollbars,status,menubar=no, toolbar=no, personalbar=no, location=no, titlebar=0, height=500, width=400');
				win.document.body.innerHTML = "<!DOCTYPE html><html><head><title>" + idin + "</title></head><body  >" + ht + "</body></html>";
		} else {
			ativaAtalhos(false);
			alertify.alert("Dados de "+idin, ht, function(){ativaAtalhos(true);});
		}	
	} //.function mostraResultado
	
	let node = graph.getNode(idin);
	var noData = node.data;
	var ht = '';
	if (!idin.startsWith('PJ_')) {
		if (idin.startsWith('PF_')) {
			ht += "<b>ID: </b> " + idin + "<br>";
			if (noData.descricao) { 
				ht += "<b>Descrição: </b> "+ noData.descricao + "<br>";
			}
			if (noData.nota) {
				ht += "<b>Nota: </b> "+ noData.nota + "<br>";
			}
			let tf = textoFlag(node, true); //ttt
			if (tf) {
				ht += "<br>" + tf + "<br>";
			}
		} else if (idin.startsWith('LI_')) { //if ([ 'LI_', 'ID_'].includes(gparam.idnoSelecionado.substr(0,3))) { 
			ht += "<b>ID: </b> " + idin + "<br>";
			if (noData.descricao) { 
				ht += "<b>Descrição: </b> "+ noData.descricao + "<br>";
			}
			if (noData.nota) {
				ht += "<b>Nota: </b> "+ noData.nota + "<br>";
			}		
			mostraResultado(idin, ht);
			return;
		} else {
			for (const [key, value] of Object.entries(noData)) {
				if (!['camada', 'situacao_ativa', 'posicao', 'pinado'].includes(key)) {
					if (value) {
						ht += "<b>" + key + ": </b> "+ value+ "<br>";
					}
					
				}
			}
		}
		if (!gparam.inicio.bBaseLocal) {
			mostraResultado(idin, ht);
			return;
		}
	}

	//var url = base + 'dadosjson/' + idin;
	var url = base + 'dadosjson/'; 
	//link pode ter caractere, como barra, que bagunça o app.route do flask, por isso os dados vão pelo body. outra opção, ignorar pedido de dadosjson de LI_
	/*
	if ([ 'LI_', 'ID_'].includes(idin.substr(0,3))) { 
		//url += idin.substr(0,3); //encodeURIComponent(idin); 
		url += encodeURIComponent(idin.replaceAll('/',' ').replaceAll('?', ' '));
	} else {
		url += idin; //o idin aqui é um enfeite, porque via post o parâmetro vai ser lido pelo body
	} */
	url += encodeURIComponent(idin.replaceAll('/',' ').replaceAll('?', ' '));
	// talvez isto é redundante para PF, pois os dados de pep, etc, já terão sido carregados. Só tem sentido se existisse atualizasse online de algum dado
	fetch(url, {method: 'post', body:JSON.stringify({'idin':idin}), headers: {"Content-type": "application/json"}, cache: "no-store"}) //, mode: 'cors',})
	  .then(
		function(response) {
		  if (response.status !== 200) {
			mensagemErroHttp(response);
			return;
		  }
		  response.json().then(function(data) {
			var texto = "";
			gparam.json = data;

			// if (data) { // se data for {}. é não nulo no javascript
			if (Object.keys(data).length) {
				if (idin.startsWith('PJ_')) {
					ht = dadosEmHtmlPJ(data, noData);
				} // else {
					//ht += noData;
				htadicional = ''
				for (const [key, value] of Object.entries(data)) {
					if (['id'].includes(key)) {
						continue;
					}
					if ((idin.startsWith('PF_')) && (gparam.itensFlag.includes(key))) { 
						continue;
					}
					if (value) {
						htadicional += "<b>" + key.toUpperCase() + ": </b> "+ value+ "<br>";
					}
				}
				if (htadicional) {
					//ht +=  "<b>--------------</b> "+ "<br>" + htadicional;
					ht +=  "<br>" + htadicional;
				}
				//}
				if (!gparam.mobile && idin.startsWith('PJ_')) {
					ht += '<a href="/rede/consulta_cnpj/?cnpj=' + idin.substring(3) + '" title="No gráfico, pressione SHIFT+D para ver dados de CNPJ em uma nova aba. Os sócios serão listados." target="_blank">Abrir em outra aba</a><br><br>';
				}
			} 
			mostraResultado(idin, ht);
		  });
		}
	  )
	  .catch(function(err) {
		console.log('Fetch Error :-S', err);
		alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
	  });
} //.function menu_dados

function menu_listaSelecao(bNovaJanela) {
	if (!gparam.idNosSelecionados) { 
		return; 
	}
	var ht = '';
	for (let n of gparam.idNosSelecionados) {
		var noData = graph.getNode(n).data;
		ht += "<b>ID: </b> " + noData.id;
		if (noData.descricao && (!noData.id.includes(noData.descricao))) { 
			ht += " ("+ noData.descricao + ")<br>";
			ht += " ("+ noData.descricao + ")<br>";
		} else {
			ht += "<br>";
		}
		if (noData.nota) {
			ht += "<b>Nota: </b> "+ noData.nota + "<br>";
		}
	}
	if (ht) {
		//document.getElementById("corpo").disabled = true; 
		if (bNovaJanela) { 
			//var win = window.open('/rede/dados_janela/'+gparam.idnoSelecionado, gparam.idnoSelecionado,'resizable,scrollbars,status,menubar=no, toolbar=no, personalbar=no, location=no, titlebar=0, height=500, width=400');
			var win = window.open('', gparam.idnoSelecionado,'resizable,scrollbars,status,menubar=no, toolbar=no, personalbar=no, location=no, titlebar=0, height=500, width=400');
			win.document.body.innerHTML = "<!DOCTYPE html><html><head><title>Itens Selecionados</title></head><body  >" + ht + "</body></html>";
		} else {
			ativaAtalhos(false); //para permitir ctrl+c
			alertify.alert("Itens selecionados: \n" + ht, function(){ativaAtalhos(true);});
		}
	} 
} //.function menu_lista_selecao


function menu_importarJsonArquivo(evt, tipo) {
	menuOnClick();
	if (tipo=='drop') {
		var files = evt.dataTransfer.files;
	} else {
		var files = evt.target.files; // FileList object
	}
	for (var i = 0; i < files.length; i++) {
		//console.log(files[i].name);
		var f=files[i];
		var reader = new FileReader();
		reader.onload = (function(f) {
			return function(e) {
				var contents = e.target.result;
				//alert( "Got the file.n"  +"name: " + f.name + "n"  +"type: " + f.type + "n"  +"size: " + f.size + " bytesn"  + "starts with: " + contents.substr(1, contents.indexOf("n"))); 
				if (f.name.endsWith('.csv')) {
					inserir_lista(contents);
					//console.log(contents);
				} else if (f.name.endsWith('.json')){
					//importaJSON(contents);
					try {
						var content_parse = JSON.parse(contents);
						gparam.debug = contents;
						inserirJson(content_parse, 'Leitura de arquivo. ');
					} catch (e) {
						alertify.error('Aconteceu um erro ' + e);
					}
				} else if (f.name.endsWith('.py')){
					//importaJSON(contents);
					inserir_lista('_>p\n' + contents);
				} else if (f.name.endsWith('.js')){
					//importaJSON(contents);
					inserir_lista('_>j\n' + contents);
				} else {
					var idNovo = 'AR_' + f.name;
					resp = confirm('Exporta arquivo para o servidor?')
					if (resp) {
						exportaArquivoServidor(f);
						//console.log(idNovo); 
					} else {
						menu_ligar_novo(idNovo,'');
					}
					/*
					var descricao = prompt('Digite uma descrição para o arquivo ' + f.name, '');
					if (graph.hasNode(idNovo)) {
						alert('Já existe um arquivo com o nome ' + f.name);
						
					} else {
						var no = {'id': idNovo,
						   'descricao': descricao,
						   'camada': 0,
						   'situacao_ativa': true,
						   'imagem': iconeF(idNovo), //'icone-grafo-id.png',
						   'cor': 'yellow'};					
						};
						graph.addNode(idNovo, JSON.parse(JSON.stringify(no)));
					}
					*/
				}
			};
		})(f);
		reader.readAsText(f);
	}
} //.function menu_importarJsonArquivo

function menu_exportaJSONServidorParaBaseLocal(bSoSelecionados, comentario, acaoAlternativa ) {
	//bExportaParaArquivoJson true, o arquivo será salvo no servidor como json, se false vai para o banco de dados local
	var jsonDados = getRedeNosLigacoes(bSoSelecionados);
	if (jsonDados.no.length==0) {
		alertify.error('Não há itens para exportar.');
		return;
	}
	var url;
	if (acaoAlternativa) {
		url = base + 'envia_json/' + acaoAlternativa;
	} else {
		if (!comentario) {
			comentario =  prompt('Digite um comentário para os dados inseridos na base local:', 'rede');
		}
		if (!comentario) {
			return;
		}
		url = base + 'json_para_base/' + encodeURIComponent(comentario);
	} 
	
	fazFetch(url, jsonDados); 
	function fazFetch(url) {
		document.body.style.cursor = 'wait';
		fetch(url, {method: 'post', body:JSON.stringify(jsonDados), headers: {"Content-type": "application/json"}, cache: "no-store"}) // mode: 'cors',
		    .then(
			function(response) {
				if (response.status !== 200) {
					mensagemErroHttp(response);
					return;
				}
				// Examine the text in the response
				response.json().then(function(data) {
					document.body.style.cursor = 'default';
					if (data.retorno) {
						if (acaoAlternativa) {
							//alertify.success('Dados enviados.');
							var textoMensagem = 'Dados enviados.';
						} else {
							//alert('Os dados foram inseridos na base local.');
							var textoMensagem = 'Os dados foram inseridos na base local.';
						}	
						exibe_mensagem_sucesso_erro(textoMensagem, data.mensagem);
					} else {
						alertify.error('Aconteceu um erro. ' + data.mensagem);
					}					
			    });
			}
		)
		  .catch(function(err) {
			document.body.style.cursor = 'default';
			console.log('Fetch Error :-S', err);
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
		  });
	}
} //.function menu_exportaJSONServidorParaBaseLocal

function menu_copiaItensParaOutraAba(bNovaJanela, bFocusNoDestino) { 
	//cria nova aba (ou não) para copiar itens selecionados. Se não criar nova aba, copia para a última aba selecionada
	//quando cria uma aba nova (filha), o focus necessariamente fica na aba filha. O parâmetro bFocusNoDestino só funciona quando a aba filha já existe
	var jsonDados = getRedeNosLigacoes(true, null, true);
	if (!bNovaJanela) {
		if (!gparam.abaFilha || !gparam.abaFilha.inserirJson || gparam.abaFilha.closed ) {
			if (!confirm('Não encontrou uma Aba "Filha" aberta. Deseja abrir uma nova aba com os itens selecionados?')) {
				return;
			}
			bNovaJanela = true;
		}
	}
	if (bNovaJanela) {
		gparam.abaFilha = window.open(base); 
	}
	var tempo = bNovaJanela ? 500 : 10;
	//gparam.abaFilha.inserirJson(jsonDados, 'itens copiados'); //neste momento a função ainda não foi criada... precisa de um delay
	setTimeout(function() {
				copiarItemSelecionadosParaAbaFilha(bNovaJanela, bFocusNoDestino)
			}, tempo
	);
} //.function menu_copiaItensParaOutraAba

function copiarItemSelecionadosParaAbaFilha(bNovaJanela, bFocusNoDestino) { 
	//ativado por duplo click no botão drag 
	//copia itens selecionados para nova janela aberta por SHIFT+A
	if (!gparam.abaFilha || gparam.abaFilha.closed || !gparam.abaFilha.inserirJson  ) { //esta checagem é redundante??
		alertify.error('Não há outra janela aberta recentemente. Use SHIFT+DUPLO CLICK no botão COPY ou a tecla SHIFT+A para criar uma nova ABA VAZIA ou a tecla A para criar nova aba com os itens selecionados.');
		return;
	}
	var jsonDados = getRedeNosLigacoes(true, null, true); //pega itens selecionados
	try {
		gparam.abaFilha.inserirJson(jsonDados, 'itens copiados da Aba "Mãe"', true); 
		if (bNovaJanela) {
			gparam.abaFilha.alertify.warning('Pressionando o botão COPY na Aba "Mãe" copiará outros itens para esta Aba "Filha".');
		}
		alertify.success('Os itens selecionados foram copiados para a outra aba.');
		if (bFocusNoDestino) {
			gparam.abaFilha.focus();
		}
	} catch (error) {
		alertify.error('Erro. Nâo copiou itens para outra aba.');
		if (bNovaJanela) {
			gparam.abaFilha.close();
			gparam.abaFilha = null;		
		}
	}
} //.function copiarItemSelecionadosParaAbaFilha

function exportaArquivoServidor(arquivo) { 
	//https://stackoverflow.com/questions/5587973/javascript-upload-file
	let formData = new FormData();
	formData.append("arquivo", arquivo);
	fetch(base + 'arquivo_upload/', {method: "POST", body: formData})
		.then(
			function(response) {
			  if (response.status !== 200) {
				mensagemErroHttp(response);
				return;
			  }
			  // Examine the text in the response
			  response.json().then(function(data) {
				//console.log(data);
				document.body.style.cursor = 'default';
				if (data.nomeArquivoServidor) {
					console.log('nome '+ data.nomeArquivoServidor); 
					let idNovo = 'AR_' + data.nomeArquivoServidor;
					menu_ligar_novo(idNovo,'');
					//return data.nomeArquivoServidor;
				} else {
					alertify.error('Aconteceu um erro. ' + data.mensagem);
				}
			  });
			}
		  )
		  .catch(function(err) {
			document.body.style.cursor = 'default';
			console.log('Fetch Error :-S', err);
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
		  });
} //.function exportaArquivoServidor

//function menu_exportaJSONServidor(bSoSelecionados, bMostraAlerta, idArquivoServidor, setNos, nomeNovaAba) {
function menu_exportaJSONServidor(bSoSelecionados, bReescreveNoLink) {
	//abre nova aba exportando dados para o servidor
	//bExportaParaArquivoJson true, o arquivo será salvo no servidor como json, se false vai para o banco de dados local
	//se setNos especificado, usa esses itens para exportar
	//se setNos = null, usa todos os itens do gráfico se bSoSelecionados=false ou só selecionados se bSoSelecionados=true
	
	var jsonDados;
	var novaJanela;
	jsonDados = getRedeNosLigacoes(bSoSelecionados);
	if (jsonDados.no.length==0) {
		alertify.error('Não há itens para exportar.');
		return;
	}
	var idArquivoServidor = '';
	
	var url = base + 'arquivos_json_upload/'
	if (bReescreveNoLink) { //xxe
		idArquivoServidor = String(window.location).split('/').pop();
		if (!confirm('o arquivo ' + idArquivoServidor + ' será ATUALIZADO no servidor. A versão anterior não poderá ser recuperada. Deseja prosseguir?')) {
			return;
		}
		url += String(window.location).split('/').pop() + '?reescreve=S';
	} else {
		idArquivoServidor =  prompt('Digite um começo para o nome do arquivo a ser carregado no servidor. Serão adicionados caracteres aleatórios para dificultar o acesso a outros usuários. Qualquer pessoa com o nome + caracteres aleatórios poderá abrir ou apagar o arquivo.', 'rede');
		if (!idArquivoServidor) {
			return;
		}
		url += encodeURIComponent(idArquivoServidor);
	}
	fazFetch(url, jsonDados); 
	function fazFetch(url, jsonDados) {
		document.body.style.cursor = 'wait';
		fetch(url, {method: 'post', body:JSON.stringify(jsonDados), headers: {"Content-type": "application/json"}, cache: "no-store"}) // mode: 'cors',
		  .then(
			function(response) {
			  if (response.status !== 200) {
				mensagemErroHttp(response);
				return;
			  }
			  // Examine the text in the response
			  response.json().then(function(data) {
				document.body.style.cursor = 'default';
				if (data.nomeArquivoServidor) {
					if (!bReescreveNoLink) {
						alert('O arquivo foi carregado no servidor com o nome: ' + data.nomeArquivoServidor + '\n' + 'Será aberto uma janela com o link, que poderá ser compartilhado.\nAtenção: QUALQUER PESSOA COM O LINK poderá ABRIR ou APAGAR o arquivo no servidor. \nOs arquivos no servidor PODERÃO SER APAGADOS sem aviso prévio. Faça uma cópia local com a opção no menu Salvar/Abrir>Arquivo>Salvar Arquivo Json.');
						var novaJanela=window.open(base + "grafico_no_servidor/" + data.nomeArquivoServidor);
					} else {
						alert('O arquivo foi carregado no servidor com o nome: ' + data.nomeArquivoServidor + '\nOs arquivos no servidor PODERÃO SER APAGADOS sem aviso prévio. Faça uma cópia local com a opção no menu Salvar/Abrir>Arquivo>Salvar Arquivo Json.');					
					}
				} else {
					alertify.error('Aconteceu um erro. ' + data.mensagem);
					alert('Aconteceu um erro. ' + data.mensagem);
				}
			  });
			}
		  )
		  .catch(function(err) {
			document.body.style.cursor = 'default';
			console.log('Fetch Error :-S', err);
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
			alert('Aconteceu um erro (Fetch error ' + err + ')');
		  });
	}
	//return novaJanela; novaJanela só retorna null
} //.function menu_exportaJSONServidor

function openWindowWithPost(data, url) {
	//https://stackoverflow.com/questions/5684303/javascript-window-open-pass-values-using-post
    var form = document.createElement("form");
    form.target = "_blank";
    form.method = "POST";
	form.rel = 'opener'; //evitar erro de window.opener is null quando clica no mapa para pedir dados
    //form.action = base + 'selecao_de_itens/' ; 
	form.action = url.startsWith('http') ? url : base + url;
    form.style.display = "none";
	var input = document.createElement("input");
	input.type = "hidden";
	input.name = "data";
	input.value = JSON.stringify(data);
	form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
} //.function openWindowWithPost

function menu_importaJSONServidor(idArquivoServidor, bNaoConfirma, bApaga) {
	var resp = null;
	var metodo = 'post';
	if (!idArquivoServidor) {
		if (bApaga) {
			idArquivoServidor =  prompt('Digite o nome do arquivo no JSON no servidor que será carregado e depois APAGADO:');
		} else {
			idArquivoServidor =  prompt('Digite o nome do arquivo no JSON no servidor:');
		}
	}
	if (!idArquivoServidor) {
		return;
	}
	var url = '';
	if (idArquivoServidor.startsWith(base+'grafico_no_servidor/')) {
		idArquivoServidor = idArquivoServidor.substr(base.length+'grafico_no_servidor/'.length);
	} 
	url = base + 'arquivos_json/' + idArquivoServidor;

	if (bApaga) {
		if (!bNaoConfirma) {
			resp = confirm('O arquivo ' + idArquivoServidor + ' será lido do Servidor e depois APAGADO?\nDeseja prosseguir?? NÃO SERÁ POSSÍVEL REVERTER!!!!.');
		}
		if (!resp) {
			return;
		}
		//parametros['apagar']='sim';
		metodo = 'delete';
	}
	//se idArquivoServidor=temporario, o arquivo será apagado do servidor após de ser servido
	fazFetch(url, idArquivoServidor); 
	function fazFetch(url, idArquivoServidor) {
		document.body.style.cursor = 'wait';
		//fetch(url, {method: 'get'}) // mode: 'cors',
		//fetch(url, {method: 'post', headers: {"Content-type": "application/json"}, cache: "no-store"}) // mode: 'cors',
		fetch(url, {method: metodo, body:JSON.stringify({}), headers: {"Content-type": "application/json"}, cache: "no-store"}) // mode: 'cors',
		  .then(
			function(response) {
			  if (response.status !== 200) {
				mensagemErroHttp(response);
				alertify.error('Não conseguiu carregar o arquivo ' + idArquivoServidor);
				return;
			  }
			  // Examine the text in the response
			  response.json().then(function(data) {
				//console.log(data);
				document.body.style.cursor = 'default';
				inserirJson(data, ' Arquivo do Servidor: ' + idArquivoServidor, bNaoConfirma);
				if (bApaga) {
					alertify.warning('O arquivo ' + idArquivoServidor + ' foi removido do servidor');
				}
			  });
			}
		  )
		  .catch(function(err) {
			document.body.style.cursor = 'default';
			console.log('Fetch Error :-S', err);
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
		  });
	}
} //.function menu_importaJSONServidor

function menu_salvaJSONNavegador(nomeIn) { //xx5
	var jsonDados;
	var ultimoNome = ''
	jsonDados = getRedeNosLigacoes();
	if (jsonDados.no.length==0) {
		alertify.error('Não há itens para exportar.');
		return false;
	}
	var arquivosLocais = JSON.parse(localStorage.getItem('jsons'));
	
	if (nomeIn) {
		idArquivo = nomeIn;
	} else {
		var tmensagem = 'Digite um nome para salvar no navegador.';
		if (arquivosLocais) {
			tmensagem += 'Os seguintes já estão na memória: \n';
			for (let nome of Object.keys(arquivosLocais))  {
				tmensagem += nome + '\n';
				ultimoNome = nome;
			}
		}
		if (!ultimoNome) {
			ultimoNome = 'rede_local';
		}	
		idArquivo =  prompt(tmensagem, ultimoNome);
		if (!idArquivo) {
			return false;
		} else if (Object.keys(arquivosLocais).includes(idArquivo)) {
			var resp = confirm('O nome ' + idArquivo + ' já está sendo usado. Deseja reescrever?');
			if (!resp) {
				return false;
			}
		}	
	}
		
	if (!arquivosLocais) {
		arquivosLocais = {};
		arquivosLocais[idArquivo] = JSON.parse(JSON.stringify(jsonDados));
	} else {
		arquivosLocais[idArquivo] = JSON.parse(JSON.stringify(jsonDados));
	}
	localStorage.setItem('jsons', JSON.stringify(arquivosLocais));
	return true;
} //.function menu_salvaJSONNavegador

function menu_carregaJSONNavegador(nomeIn) {
	var jsonDados;
	var arquivosLocais = JSON.parse(localStorage.getItem('jsons'));
	if (!arquivosLocais || (Object.keys(arquivosLocais).length==0)) {
		//arquivosLocais = {};
		alert('Nâo há arquivos tipo JSON salvos no navegador!');
		return;
	}
	var ultimoNome = '';
	var tmensagem = 'Digite um nome para carregar. Os seguintes grupos estão na memória: \n';
	
	if (nomeIn) {
		idArquivo = nomeIn;
	} else {
		for (let nome of Object.keys(arquivosLocais))  {
			tmensagem += nome + '\n';
			ultimoNome = nome;
		}
		idArquivo =  prompt(tmensagem, ultimoNome);
		if (!idArquivo) {
			return;
		}
	}

	var data = arquivosLocais[idArquivo];
	if (!data) {
		alertify.error('Não localizou '+ idArquivo + ' no navegador.');
		return;
	}
	inserirJson(data, ' Carregou no navegador: ' + idArquivo + '. ', true);
} //.function carregaJSONNavegador

function menu_botaoAbre(bshift) { //xxx
	menu_carregaJSONNavegador(bshift ? '': 'salvo_pelo_botao');
} //.function menu_botaoAbre

function menu_botaoSalva(bshift) { //xxx
	var r = menu_salvaJSONNavegador(bshift? '': 'salvo_pelo_botao');
	if (r) {
		alertify.success('Os itens foram salvos no navegador.');
	}
} //.function menu_botaoSalva

function menu_apagaJSONNavegador() {
	var tmensagem = 'Digite nome para apagar no navegador. Os seguintes conjuntos estão na memória: \n';
	var arquivosLocais = JSON.parse(localStorage.getItem('jsons'));
	var ultimoNome = ''
	if (!arquivosLocais || ( Object.keys(arquivosLocais).length==0)) {
		alert('Não há arquivos locais no navegador');
		return;
	}
	for (let nome of Object.keys(arquivosLocais))  {
		tmensagem += nome + '\n';
		ultimoNome = nome;
	}
	tmensagem += '\nOu Use * para apagar todos os arquivos locais.\nNão será possível reverter o apagamento.';
	idArquivo =  prompt(tmensagem, ultimoNome);
	if (!idArquivo) {
		return;
	}
	if (idArquivo=='*') {
		arquivosLocais = {};
	} else {
		delete arquivosLocais[idArquivo];
	}
	localStorage.setItem('jsons', JSON.stringify(arquivosLocais));
} //.function menu_apagaJSONNavegador

function menu_copiaClip() { //xx5
	var jsonDados;
	jsonDados = getRedeNosLigacoes(true);
	if (jsonDados.no.length==0) {
		alertify.error('Não há itens para copiar.');
		return false;
	}
	
	localStorage.setItem('clipboard', JSON.stringify(jsonDados));
	alertify.success('Copiou itens para a área de transferência.');
	return true;
} //.function menu_copiaClip

function menu_colaClip() {
	var jsonDados;
	try {
	 jsonDados = JSON.parse(localStorage.getItem('clipboard'));
	} catch (e) {
		alertify.error('Não há itens na área de transferência.');
		return false;	
	}
	if (jsonDados.no.length==0) {
		alertify.error('Não há itens para colar.');
		return false;
	}

	inserirJson(jsonDados, ' Colou itens da área de transferência. ', true);
} //.function menu_colaClip


function pegaAnguloLigacaoDoItemSelecionado1(brandom) { 
	//calcula o angulo do noSelecionado com o anterior, apenas se o noSelecionado tiver uma ligação, e utiliza o angulo para posicionar o novo nó.
	//brandom = true, retorna randomico se haver mais de uma ligação para noSelecionado.
	var linksDoNo = graph.getLinks(gparam.idnoSelecionado);
	var angulo = brandom ? 2.0*Math.PI*Math.random() : -Math.PI;
	if (linksDoNo &&  (linksDoNo.length==1)){
		let linkNo = linksDoNo[0];
		var posicaoItem;
		var posicaoReferencia = gparam.layout.getNodePosition(gparam.idnoSelecionado);
		if (linkNo.fromId == gparam.idnoSelecionado) {
			posicaoItem = gparam.layout.getNodePosition(linkNo.toId );
		} else {
			posicaoItem = gparam.layout.getNodePosition(linkNo.fromId );
		}
		angulo = Math.atan2(posicaoItem.y - posicaoReferencia.y, posicaoItem.x - posicaoReferencia.x) + Math.PI;
	}
	return angulo;
} //.function pegaAnguloLigacaoDoItemSelecionado1

function pegaAnguloLigacaoDoItemSelecionado(brandom) { 
	//calcula o angulo do noSelecionado com o anterior, se o noSelecionado tiver uma ligação. Se tiver mais de uma ligação e menos de 15, calcula média (faz sentido?), e utiliza o angulo para posicionar o novo nó.
	//brandom = true, retorna randomico se haver nenhuma ou muitas ligações ligação para noSelecionado.
	var angulo = brandom ? 2.0*Math.PI*Math.random() : 0.5*Math.PI;
	if (!gparam.idnoSelecionado) {
		return angulo;
	}
	var somaX = 0, somaY=0; //para calcular média dos nós ligados ao selecionado.
	var linksDoNo = graph.getLinks(gparam.idnoSelecionado);
	if (!linksDoNo || (linksDoNo.length>50)) { //se houver muitos itens ligados, não faz sentido calcular média dos angulos
		return angulo;
	}
	var posicaoReferencia = gparam.layout.getNodePosition(gparam.idnoSelecionado);
	for (linkNo of linksDoNo) {
	//if (linksDoNo &&  (linksDoNo.length==1)){
		//let linkNo = linksDoNo[0];
		var posicaoItem;
		//var posicaoReferencia = gparam.layout.getNodePosition(gparam.idnoSelecionado);
		if (linkNo.fromId == gparam.idnoSelecionado) {
			posicaoItem = gparam.layout.getNodePosition(linkNo.toId);
		} else {
			posicaoItem = gparam.layout.getNodePosition(linkNo.fromId);
		}
		somaX += posicaoItem.x;
		somaY += posicaoItem.y;
	}
	//calcula angulo do itemSelecionado com a média dos ligados a esse item
	return Math.atan2(posicaoReferencia.y - somaY/Math.max(linksDoNo.length, 1), posicaoReferencia.x - somaX/Math.max(linksDoNo.length, 1));
} //.function pegaAnguloLigacaoDoItemSelecionado

function reinsereComNovoId(id, idNovo) { 
	//reinsere nó com outro id, mantendo os dados do nó e das ligações.
	var dados = dcopy(graph.hasNode(id)).data;
	var llinks = [];
	graph.forEachLinkedNode( id, function(nodeaux, link) { 
		llinks.push(dcopy(link.data));
	});
	//graph.removeNode(id);
	//console.log(JSON.stringify(dados)); 
	//console.log(JSON.stringify(llinks));
	var posicao = gparam.layout.getNodePosition(id);
	removeIdNo(id);
	dados.id = idNovo;
	graph.addNode(idNovo, dcopy(dados));
	for (let li of llinks) {
		var lix = dcopy(li);
		lix.origem = (lix.origem==id) ? idNovo : lix.origem;
		lix.destino = (lix.destino==id) ? idNovo : lix.destino;
		graph.addLink(lix.origem, lix.destino, dcopy(lix));
	}
	gparam.layout.setNodePosition(idNovo, posicao.x, posicao.y);
} //.function reinsereComNovoId

function inserirJson(jsonIn, texto, bNaoConfirma, bSelecionaCaminho) {
	var no = jsonIn.no;
	var ligacao = jsonIn.ligacao;
	gparam.json = JSON.parse(JSON.stringify(jsonIn));
	var kn=0, kl=0;
	var idNosInseridos = new Set();
	var idNosCamadaZero = new Set();
	//var fatorTamanhoNovaLigacao = 1.0; //nova ligação sem animação fica desagradável. Quando houver poucos itens, deixa a ligação menor para ter animação

	var sNosAInserir = new Set();
	for (let noaux of Object.values(no)) { //verifica quantos nós serão inseridos
		if (!graph.hasNode(noaux.id)) { 
			sNosAInserir.add(noaux.id);
		}
	}	
	var kNosAInserir = sNosAInserir.size;
	
	if (!bNaoConfirma) {
		if (kNosAInserir > gparam.confirmaAntesDeInserirNNos) {
			let mensagem = 'Deseja inserir ' + kNosAInserir + ' itens?\n Depois será possível excluir os itens usando CTRL+Z para desfazer.';
			if (kNosAInserir>1000) mensagem += '\nObs: Com muitos itens a execução ficará muito lenta ou o browser poderá travar. ';  //\nApós carregar o gráfico, utilize a rotina no menu "Visualização>Quebrar o gráfico em partes"';
			var resp = confirm(mensagem);
			if (!resp) {
				// isso pode demorar muito e travar tudo. 
				if (gparam.usuarioLocal) {
					resp = confirm('Deseja exportar os dados dos itens não exibidos para o Excel? Obs: O processamento pode demorar. Seja paciente...');
					if (resp) {
						menu_exportaArquivo(null, 'xlsx', jsonIn); 
						console.log(JSON.stringify(jsonIn).length); 
					}
				}
				gparam.camadaIdExpandido = {}; //se cancelar inclusão de itens, zera contador (evitar erro em endereço, telefone e email não inserido, que não aceita inserir camada 2)
				return;
			}
			gparam.confirmaAntesDeInserirNNos = kNosAInserir;
		}
	}
	if (kNosAInserir>100) { 
		suspendeZoom(Math.sqrt(kNosAInserir)*200); 
		fatorTamanhoNovaLigacao = 1.0;
	} 

	//var angulo = 2.0*Math.PI*Math.random();
	//var passoAngulo = 2.0*Math.PI/Math.max(kNosAInserir, 1);
	var abertura;
	if (kNosAInserir<=1) {
		abertura = 0;
	} else if (kNosAInserir<8) { 
		abertura = 0.5*Math.PI; //os nos novos vão ficar em um intervalo de 90 graus
	} else if (kNosAInserir<20) {
		abertura = 1.0*Math.PI;
	} else {
		abertura = 1.5*Math.PI;
	}
	var angulo = pegaAnguloLigacaoDoItemSelecionado(true) - abertura/2.0;
	var passoAngulo = abertura/Math.max(kNosAInserir-1, 1);
	
	var posicaoReferencia = {'x':0, 'y':0};
	if (gparam.idnoSelecionado) { //insere novos em torno do nó selecionado.
		posicaoReferencia = gparam.layout.getNodePosition(gparam.idnoSelecionado);
	} else {
		//passoAngulo = 2*Math.PI/Math.max(kNosAInserir-1, 1);
		passoAngulo = 2*Math.PI/Math.max(kNosAInserir, 1);
		angulo = Math.PI/2;
	}
	
	for (let noaux of Object.values(no)) {
		if (!graph.hasNode(noaux.id)) { 
			if (!noaux.nota) {
				noaux.nota = ''; //em algumas funções supõe que nota é string
			}
			graph.addNode(noaux.id, JSON.parse(JSON.stringify(noaux)));
			
			if (noaux.posicao) { 
				if ((noaux.posicao.x) && (noaux.posicao.y)) {
				gparam.layout.setNodePosition(noaux.id, noaux.posicao.x, noaux.posicao.y);
				//refreshPosicoes = true;
				}
				gparam.layout.pinNode(noaux, noaux.pinado); 
			//} else if (posicaoReferencia) { //insere novos em torno do nó selecionado.
			} else { //insere novos em torno do nó selecionado.
				//gparam.layout.setNodePosition(noaux.id, posicaoReferencia.x + Math.random()*gparam.springLength-gparam.springLength/2, posicaoReferencia.y + Math.random()*gparam.springLength-gparam.springLength/2);
				//var angulo=Math.PI*(Math.random()-0.5) + Math.atan2(posicaoReferencia.y, posicaoReferencia.y); //teste, colocar itens novos em relação ao centro do gráfico (algum problema)
				//gparam.layout.setNodePosition(noaux.id, posicaoReferencia.x + Math.cos(angulo)*gparam.springLength*fatorTamanhoNovaLigacao, posicaoReferencia.y + Math.sin(angulo)*gparam.springLength*fatorTamanhoNovaLigacao);
				var fatorE = 1.0;
				if ([ 'EN_','TE_', 'EM_'].includes(noaux.id.substr(0,3))) { //coloca endereços mais longe para melhorar visualização
					fatorE = 2.0;
				}
				//fatorE = fatorE * fatorTamanhoNovaLigacao;
				gparam.layout.setNodePosition(noaux.id, 
					posicaoReferencia.x + Math.cos(angulo)*gparam.springLength*fatorE, posicaoReferencia.y + Math.sin(angulo)*gparam.springLength*fatorE);
				angulo += passoAngulo;
			}
			kn += 1;
			idNosInseridos.add(noaux.id);
			//if (!noaux.camada) {
			if ((noaux.camada===0) ||(noaux.camada==='0')) {
				idNosCamadaZero.add(noaux.id);
			}
		} else { //nó já existe. TODO: verificar se precisa atualizar .data 
		
		}
	}
	if (idNosInseridos.size) {
		gparam.listaIdNosInseridos.push(idNosInseridos);
	}
	
	for (let ligaux of Object.values(ligacao)) {
		var nosExistem = ((graph.hasNode(ligaux.origem)) && (graph.hasNode(ligaux.destino)));
		if (!nosExistem) {
			console.log('erro. Dados de um dos nós da ligação não foi definido');
			console.log('ligacao '+ ligaux.origem + ' para ' + ligaux.destino);
			alertify.error('Erro na ligacao '+ ligaux.origem + ' para ' + ligaux.destino);
			continue;
		}
		var ligExistente = graph.hasLink(ligaux.origem, ligaux.destino);
		var direcao = '';
		if (!ligExistente) {
			ligExistente = graph.hasLink(ligaux.destino, ligaux.origem);
			direcao = '-'; //item novo está na direção contrária da seta, adiciona menos antes do tipo de ligação
		}
		if (ligExistente) { 
			labelLigacao = ligExistente.data.label ? ligExistente.data.label : '';
			var conjLabel = new Set(labelLigacao.split(';')); //; é separador dos tipos de ligação
			if (direcao) { //se o tipo de ligação novo está em direção contrária da seta existente, adiciona menos
							//seria necessário tratar as situações em ligações que não há direção (não seria preciso por sinal)
				var laux = ligaux.label ?  ligaux.label.split(';') : ''.split(';');
				if (ligaux.label) {
					laux.forEach((element, index) => {
					  laux[index] = '( - )' + element;
					});
				}
				var conjNovo = new Set(laux);
			} else {
				var conjNovo = new Set(ligaux.label ?  ligaux.label.split(';') : ''.split(';'));
			}
			let uniao = new Set([...conjLabel, ...conjNovo]);
			uniao.delete('');
			var labelLigacaoNovo = [...uniao].join(';');
			if (labelLigacaoNovo != labelLigacao) {
				ligExistente.data.label = labelLigacaoNovo;
				var ligacaoElementoAux = document.getElementById('link_label_'+ligExistente.data.id); //ttt
				ligacaoElementoAux.text(cortastr(filtraTextoLigacao(ligExistente.data.label), 25)); //.attr('title',filtraTextoLigacao(ligExistente.data.label)); 
				// && (filtraTextoLigacao(labelLigacao).length > 2*20) 
				if (ligacaoElementoAux.hasAttribute('transform')) { //remove rotação (se o texto for longo, não será rotacionado)
					ligacaoElementoAux.removeAttribute('transform');
				}
				ligacaoElementoAux.attr('text-anchor','start');
				//ajusta tooltip
				//talvez não seja necessário //if (ligacaoElementoAux.children[0]) ligacaoElementoAux.children[0].remove();
				ligacaoElementoAux.insertAdjacentHTML('beforeEnd','<title>'+filtraTextoLigacao(ligExistente.data.label)+'</title>');
			}
		} else { //ligacao Nova
			ligaux.id = gparam.kligacoes;
			if (1) { //((graph.hasNode(ligaux.origem)) && (graph.hasNode(ligaux.destino))) {
				try { //dava erro com a rede de teste
					graph.addLink(ligaux.origem, ligaux.destino, JSON.parse(JSON.stringify(ligaux)));
					kl += 1;
					gparam.kligacoes += 1;
				} catch (e) {
					console.log('erro na ligacao ' + texto);
					console.log('ligacao '+ ligaux.origem + ' para ' + ligaux.destino);
					alertify.error('Erro json na ligacao '+ ligaux.origem + ' para ' + ligaux.destino);
				}
			} else {
				console.log('faltando um dos nós da ligação.');
				console.log('ligacao '+ ligaux.origem + ' para ' + ligaux.origem);
			}
		}
	}
	if (idNosCamadaZero.size) {
		selecionaNoid(null, false); //desseleciona tudo
		for (let n of idNosCamadaZero) {
			selecionaNoid(n, true);
			if ((idNosCamadaZero.size == 1)&&(idNosInseridos.size>1)) { //coloca o único nó em camada1 inserido na variável para expandir com tecla 1
				gparam.camadaIdExpandido = {}; 
				gparam.camadaIdExpandido[n] = 1;
			}
		}
	} 
	var textoMensagem = texto;
	if (kn)	textoMensagem += (kn>1) ? ' Inseridos ' + kn + ' itens' : ' Inserido 1 item';
	if (kl) {
		if (kn) {
			textoMensagem += (kn>1) ? ' e ' + kl + ' ligações.' : ' e 1 ligação.';
		} else {
			textoMensagem +=  (kn>1) ? ' Inseridas ' + kl + ' ligações.' : ' Inserida 1 ligação.';
		}
	}
	if ((!kn) && (!kl)) { //sem itens novos
		if (bSelecionaCaminho) { //sem itens novos, mas seleciona o caminho já existente no gráfico
			selecionaNoid(null, false); //desseleciona tudo
			// console.log(JSON.stringify(no)); 
			for (let nox of Object.values(no)) {
				if (graph.hasNode(nox.id)) { 
					selecionaNoid(nox.id, true);
				}
			}
			textoMensagem += ' Não adicionou novos itens, mas os itens do caminho foram selecionados.';
		} else {
			textoMensagem += ' Não adicionou novos itens.';
		}
	}
	exibe_mensagem_sucesso_erro(textoMensagem, jsonIn.mensagem); 
	if (kn  && !gparam.bRenderAtivado) { //ativa leiaute por 1 segundo para exibir novos itens
		gparam.renderer.resume();
		setTimeout(
			function() { 
				if (!gparam.bRenderAtivado) {
					gparam.renderer.pause();
				};
			}, 500
		);	
	}
	return true; 
} //.function inserirJson

function exibe_mensagem_sucesso_erro(textoMensagem, mensagem) {
	if (mensagem) {
		alertify.error(mensagem);
	}	
	if (textoMensagem) {
		alertify.success(textoMensagem)
	}
} //.function exibe_mensagem

function menu_incluirCamada_dicItemNota() { //cria um dicionário por nota com lista de itens com essa nota. usado para enviar para o servidor para a rotina de caminhos por nota (extra, intra grupos)
	var dicNotaArray = {};
	for (let idx of gparam.idNosSelecionados) {
		var nota = graph.getNode(idx).data.nota;
		if (nota) {
			if (dicNotaArray[nota]) {
				arrayaux = dicNotaArray[nota];
				arrayaux.push(idx);
				dicNotaArray[nota] = JSON.parse(JSON.stringify(arrayaux));
			} else {
				dicNotaArray[nota] = [idx,];
			}
		}
	}
	return dicNotaArray;
} //.menu_incluirCamada_dicItemNota

function menu_incluirCamada(idin, camada, tipo, bNaoConfirma) {
	//if idin=='', manda dados dos nós selecionados
	var url = '';
	var bAbriuAbaLink = false;
	var bodyj = '';
	var sidSelecionadosInicial = new Set([...gparam.idNosSelecionados]);
	
	//idin = idin.replace(/\//g, '').trim(); //isto causa bug se o nome tiver barra, por exemplo, S/C em caso de empresa no exterior
	idin = idin.trim();
	if ((!idin) && (!gparam.idnoSelecionado)) return; 
	
	if (idin) {
		sidSelecionadosInicial = new Set([idin,]);
	} else {
		sidSelecionadosInicial = new Set([...gparam.idNosSelecionados]);
	}

	var sitensQueNaoEstaoNaBase = new Set();
	for (const idaux of sidSelecionadosInicial) { // gparam.idNosSelecionados) { 
		if (idaux.substr(0,3)=='CH_') {
			menu_links_google(true);
			sitensQueNaoEstaoNaBase.add(idaux);
		} else if (([ 'LI_', 'AR_'].includes(idaux.substr(0,3))) || ((idaux.substr(0,3)=='ID_') && !gparam.inicio.bBaseLocal))  {
			menu_abrirNovaAba(idaux);
			bAbriuAbaLink = true;
			sitensQueNaoEstaoNaBase.add(idaux);
		}	
	}
	
	if (!tipo) {
		tipo = 'cnpj';
	}

	if ((gparam.idNosSelecionados.size ==1) && gparam.idnoSelecionado && ([ 'EN_','TE_', 'EM_'].includes(gparam.idnoSelecionado.substr(0,3))) && (camada>1)) {
		alertify.warning('A rotina só expande endereço, telefone ou email em camada 1. Para expandir os itens relacionados, selecione-os primeiro com a tecla J (menu Filtrar/Localizar>Adjacentes)');
		return;
	}
	if (sidSelecionadosInicial.size==sitensQueNaoEstaoNaBase.size) {
		return; //todos os itens selecionados são chave, link, arquivo ou id_
	} else {
		//aqui poderia criar outro set removendo os tipo chave, link, etc de gparam.idNosSelecionados.
	}
	if (tipo=='links') {
		dialogoParametrosLink();
	} else {
			if (camada>10) {
				alertify.error('O número de camadas é limitado em 10.');
				return;
			}
			camada = Math.min(camada, 10);
			if (tipo.startsWith('caminhos')) {
				if (gparam.idNosSelecionados.size<2) {
					alert('Para usar a opção caminhos, selecione ao menos dois itens do gráfico. Utilize Shift+Click para adicionar itens à seleção');
					return;
				}
				url = base + 'grafojson/' + tipo + '/' + camada + '/';
				if (tipo=='caminhos') {
					bodyj = JSON.stringify([[...gparam.idNosSelecionados]]);
				} else {
					bodyj = JSON.stringify(menu_incluirCamada_dicItemNota());
				}
			} else {
				tipo = 'cnpj';
				url = base + 'grafojson/' + tipo + '/' + camada + '/';
				bodyj = ''
			}
			fazFetch(url, idin, bodyj);
	}
	return;

	function fazFetch(url, idin, bodyjsonIn) { 
		document.body.style.cursor = 'wait';
		var bodyjson; qitens=1;
		//?? idin = ([ 'LI_', 'AR_'].includes(idin.substr(0,3)))? 'LI' : idin;
		//let bodyjson = idin ?  JSON.stringify([idin,]) :  JSON.stringify([...gparam.idNosSelecionados]); //TODO: remover os LI_ da requisição para o servidor
		//bodyjson = bodyjsonIn? bodyjsonIn : bodyjson;
		if (bodyjsonIn) {
			bodyjson = bodyjsonIn;
		} else {
			bodyjson = idin ?  JSON.stringify([idin,]) :  JSON.stringify([...gparam.idNosSelecionados]); //TODO: remover os LI_ da requisição para o servidor
			qitens = idin ? 1 : gparam.idNosSelecionados.size;
		}
		 //2023-04-19 idin na url é enfeite, porque os parâmetros são passados no body. Problema é quando idin tem algum caractere como / que atrapalha a url
		url += encodeURIComponent((idin ? idin : gparam.idnoSelecionado).replaceAll('/', '').replaceAll('?', ' '));
		// replace barra remove erro em PE com barra, por exemplo PE_ S/C (encodeURIComponente não resolve problema do /), 
		if (qitens>1) {
			url += ' ('+ qitens + ' itens)'; //para ajudar a analisar o log
		} 
		fetch(url, {method: 'post', body:  bodyjson, headers: {"Content-type": "application/json"}, cache: "no-store"}) // mode: 'cors',
		  .then(
			function(response) {
			  if (response.status !== 200) {
				mensagemErroHttp(response);
				return;
			  }
			  // Examine the text in the response
			  response.json().then(function(data) {
				document.body.style.cursor = 'default';
				if (data.no.length) {
					var textoInserir =  '';
					if (!data.mensagem) {
						if (camada>1) {
							textoInserir = ((tipo=='cnpj') ? 'Camada ' : (tipo + ' em camada ' ) ) + camada +'. ';
						}
					}
					inserirJson(data, textoInserir, bNaoConfirma, tipo=='caminhos'); // sem delay
					
				} else if (bAbriuAbaLink) {
					;
				} else {
					if (isNumeric(idin.replace(/[\.\-\//]/g, '').trim()) || idin.includes('*')) { 
						//mensagem quando se digita cpf/cnpj
						alertify.error('Não encontrou ' + idin + ' na base. ' + data.mensagem);
					} 
					else {
						alertify.error('Não encontrou o item ou novos itens que satisfaçam os parâmetros da consulta. ' + data.mensagem);
					}
				}
			  });
			}
		  )
		  .catch(function(err) {
			document.body.style.cursor = 'default';
			console.log('Fetch Error :-S', err);
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
		  });
	}
	function dialogoParametrosLink() {
		//https://stackoverflow.com/questions/30712759/multiple-input-boxes-in-alertifyjs-prompt-dialog
		/* This is important : strip the HTML of dlgContent to ensure no conflict of IDs for input boxes arrises" */
		/* Now instead of making a prompt Dialog , use a Confrm Dialog */
		var dlgLinkOriginal = document.getElementById('dlgLink');
		var dlgLink = document.getElementById('dlgLink').cloneNode(true); //clone para não mexer no original, soluciona problema de instabilidade (parava de funcionar depois de misturar tipos de consulta, cnpj e link)
		//dlgLink.setAttribute('id', 'dlgLink_clone'); //não resolve problema em mobile
		dlgLink.id = 'dlgLink_clone';
		dlgLinkOriginal.parentNode.appendChild(dlgLink); 
		dlgLink.outerHTML = ''; //isso funciona no firefox, mas no chrome dá erro sem a linha de cima
		ativaAtalhos(false);
		//alert(dlgLink.id);
		//alertify.confirm(dlgLink).set('onok', function(closeevent, value) { 
		alertify.confirm(dlgLink).set({
			onok:function() { 
				var listaInput = dlgLink.getElementsByTagName('input'); //isto dá erro no android
				var valorMinimo = parseFloat(listaInput.dlgLink_valorMinimo.value).toString();
				var valorMaximo = parseFloat(listaInput.dlgLink_valorMaximo.value).toString();
				var numeroItens = parseInt(listaInput.dlgLink_numeroItens.value).toString();
				var camada = parseInt(listaInput.dlgLink_camadas.value).toString();
				
				//copia parametros para formulário original
				var listaInputOriginal = dlgLinkOriginal.getElementsByTagName('input');
				listaInputOriginal.dlgLink_valorMinimo.value = listaInput.dlgLink_valorMinimo.value;
				listaInputOriginal.dlgLink_valorMaximo.value = listaInput.dlgLink_valorMaximo.value;
				listaInputOriginal.dlgLink_numeroItens.value = listaInput.dlgLink_numeroItens.value;
				listaInputOriginal.dlgLink_camadas.value = listaInput.dlgLink_camadas.value;
				/* Insert your code to work with the two values */ 	
				// await new Promise(r => setTimeout(r, 1000)); //delay de 1 segundo
				valorMinimo = (valorMinimo!='NaN')?valorMinimo:'0';			
				valorMaximo = (valorMaximo!='NaN')?valorMaximo:'0';
				numeroItens = (numeroItens!='NaN')?numeroItens:'0';
				camada = (camada!='NaN')?camada:'0';
				if (camada>10) {
					alertify.error('O número de camadas é limitado em 10.');
				}
				camada = Math.min(camada, 10);
				ativaAtalhos(true);
				url = base + 'grafojson/links/'  + camada +  '/' + numeroItens + '/' + valorMinimo + '/' + valorMaximo  + '/' ;
				fazFetch(url, idin);
				ativaAtalhos(true); 
				dlgLink.remove(); //ttt
			}, 
		onclose:function() { 
			ativaAtalhos(true); }, 
		oncancel:function() { ativaAtalhos(true);  }}
	).set('title',"Inserir Ligacoes");
	
	document.getElementById('dlgLink_camadas').value = camada; //estranho, mas tem que por isso pra ajustar o campo com o valor
	}
	
} //.function menu_incluirCamada

function menu_incluir1Camada(idin) {
	//para tratar 1 camada, se clicar repetidamente o mesmo item, vai aumentando as camadas.
	var idref = idin;
	var camada = 1;
	if (!idin) {
		idref = [...gparam.idNosSelecionados][0];
	}
	if (gparam.camadaIdExpandido[idref]){ //se ícone já foi clicado, abre camada seguinte.
		camada = gparam.camadaIdExpandido[idref] + 1;
	}
	menu_incluirCamada(idin, camada);
	gparam.camadaIdExpandido = {}; //reseta, expansão gradativa só de 1 item por vez.
	gparam.camadaIdExpandido[idref]=camada;
} //.function menu_incluir1Camada

function menu_inserir(textoDefault, teclaShift, teclaCtrl) {
	if (teclaCtrl) {
		return;
	}
	if (teclaShift) {
		return menu_ligar_novo();
	}
	if (!gparam.inicio.bBaseReceita) {
		return menu_ligar_novo();
	}
	//var camada = 1;
	ativaAtalhos(false);
	//var itensDefault = gparam.inserirDefault;
	
	if (textoDefault) {
		itensDefault = textoDefault;
	} 
	else {
		try {
			itensDefault = document.getElementById('input_cnpj').value;
		}  catch (e){itensDefault = gparam.inserirDefault; };
	}
	var textoPrompt = 'Para visualizar o gráfico de relacionamentos, digite CNPJ, CNPJs separados por PONTO E VÍRGULA (;) ou ESPAÇO, radical do CNPJ, Razão Social, Nome Fantasia ou Nome de Sócio. ';
	if (!gparam.mobile) {
		textoPrompt += ' Para realizar busca por sequência exata, utilize * (curinga de palavra). Por ex: FULANO DE *; *DE TAL; EMPRESA* BRASILEIRA; ';
		textoPrompt += ' Utilize @ e um número para obter mais registros, por exemplo, FULANO@20. Para exibir Matriz e 10 filiais, digite  o Radical do CNPJ seguido de @10. Para visualizar um CNPJ aleatório, pressione OK com o campo vazio.';
		// textoPrompt +=  ' <b>ATENÇÃO:</b> A busca por nome está mais flexível. Agora o padrão é a busca por parte nos nomes, não é mais necessário nomes completos.'
	}
	
	alertify.prompt( 'RedeCNPJ - Digite CNPJ/CPF/Nome', textoPrompt , itensDefault
               , function(evt, cnpjs) {   //quando se pressiona cancel, esta rotina não é chamada. Usando vazio para retornar um cnpj de teste
					gparam.inserirDefault = cnpjs;
					try {
						document.getElementById('input_cnpj').value = gparam.inserirDefault;
					} catch (e) {;};
					
					var cn = cnpjs.trim().toUpperCase();
					var cnaux = cn.replaceAll('.', '').replaceAll('-', '').replaceAll('/',''); //cn.replace(/\./g, '').replace(/\-/g, '');
					//console.log(cnaux);
					if ((cn.search(';')==-1) && isNumeric(cnaux.replaceAll(' ','').replaceAll(',',''))) { //se só tiver digitos, considera espaço como separador
						cn = cn.replaceAll(' ',';').replaceAll(',',';');
					}					
					if (1) { //(cn) { 
						if (!cn || (cn=='T')) {
							cn='#TESTE#';
						}
						if (isNumeric(cnaux) && (cnaux.length==11)) { 
							alertify.warning('A busca por CPF é feita por apenas 6 digitos e pode apresentar resultados incorretos. A tabela de dados abertos não tem todos os dígitos de CPF.');
						}
						if (!gparam.mobile) {
							alertify.warning('Pressione as teclas 1 a 9 para inserir a camada correspondente ao número.'); //alerta temporario
						}
						//menu_incluirCamada(cn, camada);
						menu_incluir1Camada(cn);
					}
					ativaAtalhos(true);
				}, function() { ativaAtalhos(true);}
	);
} //.function menu_inserir

function menu_links_google(bAbrePalavrasChaves) {
	//manda termos de busca para o servidor, que fará uma chamada ao google e retornará uma lista de nós e de ligações.
	if (!gparam.inicio.bbusca_chaves && bAbrePalavrasChaves) {
		alertify.error('A opção de busca de palavras chave não está habilitada. Baixe o projeto no github e rode localmente.');
		return;
	}
	//var termosId = gparam.idnoSelecionado? replaceAll(graph.getNode(gparam.idnoSelecionado).data.descricao,'&', ' ') : '';
	var termosId = gparam.idnoSelecionado? graph.getNode(gparam.idnoSelecionado).data.descricao.replaceAll('&', ' ') : '';
	var url='';
	var termos = '';
	var kpalavras = 0;
	var pagina = 1;
	if (!termosId && gparam.idnoSelecionado) {
		termosId = graph.getNode(gparam.idnoSelecionado).data.id.substr(3);
	}
	if (gparam.idnoSelecionado && [ 'LI_', 'AR_'].includes(gparam.idnoSelecionado.substr(0,3)) && bAbrePalavrasChaves 
			&& !gparam.idnoSelecionado.startsWith('LI_https://www.google.com')) {
		termosId = gparam.idnoSelecionado;
	}
	var textoPrompt = bAbrePalavrasChaves? 'Digite termos para buscar no Google. Será criado um gráfico com o resultado da busca e conexões com palavras chaves (isto pode demorar):' : 'Digite termos para buscar no Google. Será criado um gráfico com o resultado da busca:';
	var termos = prompt(textoPrompt, termosId);
	if (!termos) {
		return;
	} 
	if (![ 'LI_', 'AR_'].includes(termos.substr(0,3)) ) {
		if (gparam.paginaBuscaGoogle[termos]) {
			gparam.paginaBuscaGoogle[termos]++;
			//pagina = gparam.paginaBuscaGoogle[termos];
			pagina = prompt('Digite um número inteiro com a Página do Google para baixar:', gparam.paginaBuscaGoogle[termos]);
			if (pagina) {
				gparam.paginaBuscaGoogle[termos] = pagina;
			}
		} else {
			gparam.paginaBuscaGoogle[termos] = 1;
		}
	}
	//var url = base + 'busca_google/' + gparam.paginaBuscaGoogle[termos]  + '/' + encodeURIComponent(termos) ; 
	if (termos.search('@')!=-1) {
		kpalavras = parseInt(termos.split('@')[1]);
		if (kpalavras) {
			termos = termos.split('@')[0];
		}
	} else {
		kpalavras = 20;
	}
	if  ([ 'LI_', 'AR_'].includes(termos.substr(0,3))) {
		url = base + 'busca_google?link=' + encodeURIComponent(termos); 
	} else {
		url = base + 'busca_google?pag=' + +encodeURIComponent(gparam.paginaBuscaGoogle[termos])  + '&q=' + encodeURIComponent(termos); 
	}
	
	url += '&palavras_chave=' + (bAbrePalavrasChaves? kpalavras : '0');
	
	if (bAbrePalavrasChaves) {
		alertify.warning('O servidor irá baixar os arquivos e selecionar palavras chaves relacionadas à busca. Isto pode demorar...');
	}
	fazFetch(url, termosId);

	return;
	function fazFetch(url, idin) {
		document.body.style.cursor = 'wait';
		let idSelecionadoAnterior = gparam.idnoSelecionado;
		idin = ([ 'LI_', 'AR_'].includes(idin.substr(0,3)))? 'LI' : idin;
		let bodyjson = idin ?  JSON.stringify([idin,]) :  JSON.stringify([...gparam.idNosSelecionados]);
		fetch(url, {method: 'get',  cache: "no-store"}) // mode: 'cors',
		.then(
			function(response) {
				if (response.status !== 200) {
					mensagemErroHttp(response);
					return;
				}
				// Examine the text in the response
				response.json().then(function(data) {
					document.body.style.cursor = 'default';
					if (data.no.length) {
						inserirJson(data, 'busca no google por '+termos, true);
						if (idSelecionadoAnterior && (pagina.toString()=='1')) {
							setTimeout(function() {
								var resp = true;
								if (termos!=termosId)  { //se os termos forem diferentes da descrição do cpf/cnpj, pergunta se quer ligar
									var resp = confirm('Liga ao item que estava selecionado?');
								}
								if (resp) {
									gparam.idNosSelecionados.add(idSelecionadoAnterior);
									menu_ligar_selecionados(true,'',true); 
								}					 
								if (data.mensagem) {
									alertify.success(data.mensagem);
								}
							 }, 1000);
						}
					} else {
						if (data.mensagem) {
							alertify.error(data.mensagem);
						}
						else {
							alertify.warning('Não encontrou informações'); 
						}
					}
				});
			}
		    )
		.catch(function(err) {
			document.body.style.cursor = 'default';
			console.log('Fetch Error :-S', err);
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
		});
	}
} //.function menu_links_google

function menu_abreBuscasEmSites() {
	menu_buscaEmSite('https://www.reclameaqui.com.br/busca/?q=', null, true);
	menu_buscaEmSite('http://portaldatransparencia.gov.br/busca?termo=');
	menu_buscaEmSite('https://www.jusbrasil.com.br/busca?q=');	
	menu_buscaEmSite('https://www.escavador.com/busca?q=');	
	menu_buscaEmSite('https://duckduckgo.com/?q=');	
	menu_buscaEmSite('https://www.bing.com/search?q=');
	menu_GoogleMaps(false);
	menu_buscaEmSite('https://www.google.com/search?q=', 'N');
} //.function menu_abreBuscasEmSites

function menu_buscaEmSite(siteUrl, perguntaParametroAdicionalGoogle, bsemaspas){
	//perguntaParametroAdicionalGoogle=null, padrão; se =='S' pergunta parametro adicional para google, se =='N' adiciona gparam.termoBuscaGoogle
	if (perguntaParametroAdicionalGoogle=='S') {
		let resp = prompt('Insira termo a ser adicionado nas próximas buscas do Google pela tecla G:\nObservação: Houve uma alteração na tecla de atalho, para exibir links do google, utilize a tecla H. ', gparam.termoBuscaGoogle);
		if (resp===null) return;
		gparam.termoBuscaGoogle = resp;
	}
	var parametroAdicional = '';
	//var parametro = replaceAll(graph.getNode(gparam.idnoSelecionado).data.descricao,'&', ' ');
	var parametro = graph.getNode(gparam.idnoSelecionado).data.descricao.replaceAll('&', ' ');
	if (perguntaParametroAdicionalGoogle) {
		parametroAdicional = perguntaParametroAdicionalGoogle ? '+' + gparam.termoBuscaGoogle: '';
	}
	if (!parametro) {
		parametro = graph.getNode(gparam.idnoSelecionado).data.id.substr(3);
	}
	if (bsemaspas) {
		var strUrl = siteUrl + parametro.replaceAll(' ','+') + parametroAdicional;		
	} else {
		var strUrl = siteUrl + '"' + parametro + '"' + parametroAdicional;
	}
	window.open(strUrl).focus();
} //.function menu_buscaEmSite

function menu_GoogleMaps(bMostraMensagem) {
	var data = graph.getNode(gparam.idnoSelecionado).data;
	if (data.logradouro) {
		var strUrl = 'https://www.google.com.br/maps/place/' + data.logradouro + ',' + data.municipio + '/' + data.uf;
		var novaJanela=window.open(strUrl);
		novaJanela.focus();
	} else if (bMostraMensagem) {
		alertify.error('Não há endereço cadastrado.');
	}
} //.function menu_GoogleMaps

function menu_abrirNovaAba(idno, bNosSelecionados) {
	var novaJanela=null;
	if ((!idno)&&(!bNosSelecionados)) {
		novaJanela = window.open(base); // + '?pula_mensagem=sim');
		novaJanela.focus(); 
		gparam.abaFilha = novaJanela;
		return;
	}

	if ((!idno)&&bNosSelecionados) { //abre numa nova aba os nós selecionados
		//se tiver só um nó selecionado, pergunta quantas camadas
		if ((gparam.idNosSelecionados.size==1) && ([ 'PF_', 'PJ_'].includes(gparam.idnoSelecionado.substr(0,3)))){ 
			var camada = prompt('Quantidade de camadas para abrir ' + gparam.idnoSelecionado + ' em uma nova aba:','1');
			if (!camada) return;
			novaJanela = window.open(base + 'grafico/' + String(camada) + '/' + gparam.idnoSelecionado) ;
			if (novaJanela) {
				novaJanela.focus();
				gparam.abaFilha = novaJanela;
			}
		} else {	
			menu_copiaItensParaOutraAba(true, true);
		}
		return;
	} 
	if (idno.startsWith('LI_')) {
		novaJanela = window.open(idno.substr(3));
		novaJanela.focus();
		return;
	} else if (idno.startsWith('AR_')) {
		var url = base + 'abrir_arquivo' ; //+ idno.substr(3);
		//novaJanela=window.open(strUrl);
		if (!gparam.usuarioLocal) {
			if (idno.includes('/') || idno.includes('\\') ) {
				alert('Essa rotina somente abre arquivos se a execução do projeto for local.');
				return;
			}
		}
		let bodyjson = JSON.stringify([idno.substr(3)]); //JSON.stringify([...gparam.idNosSelecionados]);
		fetch(url, {method: 'post', body: bodyjson, headers: {"Content-type": "application/json"}, cache: "no-store"}) // mode: 'cors',
		.then( 
			function(response) {
				if (response.status !== 200) {
					mensagemErroHttp(response);
					return;
				}
				// Examine the text in the response
				response.json().then(function(data) {
				if (data['retorno']) {
					alertify.success('O arquivo ' + idno.substr(3) + ' foi aberto.');
				} else {
					alertify.error('O arquivo ' + idno.substr(3) + ' não foi aberto. ' + data['mensagem']);
				}
				});
			}
		)
		.catch(function(err) {
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
		});

		return;
	};
	
} //.function menu_abrirNovaAba

function menu_nomeAba() {
	var nome = prompt('Digite o nome para esta aba', document.title);
	if (nome) {
		document.title = nome;
	}
} //.function menu_nomeAba

function menu_selecionarTudo() {
	graph.forEachNode(
		function(node) {
			selecionaNoid(node.id, true, true);
		}	
	);
	alertify.success('Foram selecionados ' + graph.getNodesCount() + ' itens.');
} //.function menu_selecionarTudo

function menu_selecionarInverte() {
	//inverte a seleção
	var snos = new Set(gparam.idNosSelecionados);
	selecionaNoid(null, false); //apaga seleção
	graph.forEachNode(
		function(node) {
			if (!snos.has(node.id)) {
				//var nodeUI = graphics.getNodeUI(node.id);
				selecionaNoid(node.id, true, true);
			}
		}	
	);
	alertify.success('Foram selecionados ' + gparam.idNosSelecionados.size+ ' itens.');
} //.function menu_selecionarInverte

function menu_pinarNo(bfixar){
	var layout = gparam.layout;
	for (let n of gparam.idNosSelecionados) {
		let no = graph.getNode(n);
		if (bfixar===null) { //inverte
			layout.pinNode(no, !layout.isNodePinned(no));
		} else if (bfixar==1) {
			layout.pinNode(no, true);
		} else if (bfixar==0) {
			layout.pinNode(no, false);
		}
	}
//	var no = graph.getNode(gparam.idnoSelecionado);
//	layout.pinNode(no, !layout.isNodePinned(no));
} //.function menu_pinarNo

function menu_pinarDesfazerTudo(){ 
	var layout = gparam.layout;
	graph.forEachNode(
		function(node) {
			gparam.layout.pinNode(node, false);
		}	
	);
	alertify.success('Todos os nós foram desafixados.');
} //.function menu_pinarDesfazerTudo

function menu_pinarUmNoEmCadaGrupo(bfixar){ 
	var listaGrupos = separaGrupos(0); //lista de sets 
	var sfixados = new Set();
	for (let sgrupo of listaGrupos) {
		let nid = [...sgrupo][0];
		let no = graph.getNode(nid);
		gparam.layout.pinNode(no, true);
		sfixados.add(nid);
	}
	selecionaSet(sfixados);
	alertify.success('Cada grupo teve um nó fixado.');
} //.function menu_pinarUmNoEmCadaGrupo

function pinarNoTemp(idNo, milissegundos) {
	var layout = gparam.layout;
	//if (!gparam.idnoSelecionado) {
	//	return;
	//}
	//var no = graph.getNode(gparam.idnoSelecionado);
	var no = graph.getNode(idNo);
	if (layout.isNodePinned(no)) {
		return;
	}
	layout.pinNode(no, true); 
	setTimeout(
		function() { 
			layout.pinNode(no, false); 
		}, milissegundos
	); 
} //.function pinarNoTemp

function suspendeZoom(milissegundos) {
	//gparam.scale = graphics.scale;
	//desabilita scale temporariamente (se tiver muitos nós, mexer na escala pode travar o browser
	gparam.mensagem_alerta_zoom_desativado = 'Aguarde para fazer ZOOM.';
	graphics.scale = function(a,b) { 
		//alertify.error('O zoom foi temporariamente desativado. Aguarde alguns segundos.');
		if (gparam.mensagem_alerta_zoom_desativado) { alertify.error(gparam.mensagem_alerta_zoom_desativado); };
		gparam.mensagem_alerta_zoom_desativado = ''; //exibe mensagem só uma vez
		return gparam.renderer.getTransform().scale; 
	}; 
	setTimeout(
		function() { 
			graphics.scale = gparam.fScale;
		}, milissegundos
	); 
} //.function suspendeZoom

function menu_rotulosCompletos(bTipo) { 
	if (bTipo===null) {
		gparam.kTipoRotulo = (gparam.kTipoRotulo + 1) % 4;
	} else if (bTipo) {
		gparam.kTipoRotulo=0;
	} else {
		gparam.kTipoRotulo=2;
	}
	graph.forEachNode( function(node) {
		var ui=graphics.getNodeUI(node.id); 
		var [identificador, nome, nota] = labelsNo(node, gparam.kTipoRotulo); //node.data.label.split('\n');
		ui.getElementsByTagName('tspan')[0].text(identificador);
		ui.getElementsByTagName('tspan')[1].text(nome);
		ui.getElementsByTagName('tspan')[2].text(nota);
	});
} //.function menu_rotulosCompletos


function menu_embaralhaTexto() {
	gparam.embaralhaRotulo = !gparam.embaralhaRotulo; 
	graph.forEachNode( function(node) {
		var ui=graphics.getNodeUI(node.id); 
		var [identificador, nome, nota] = labelsNo(node, gparam.kTipoRotulo);
		ui.getElementsByTagName('tspan')[0].text(identificador);
		ui.getElementsByTagName('tspan')[1].text(nome);
		ui.getElementsByTagName('tspan')[2].text(nota);
	});
	if (gparam.embaralhaRotulo) { 
		alertify.success('Os novos itens terão a descrição embaralhada');
	} 
} //.function menu_embaralhaTexto


function menu_ligacoesExibe(bTipo) { 
	if (bTipo===null) {
		gparam.bMostraLigacao = !gparam.bMostraLigacao;
	} else if (bTipo) {
		gparam.bMostraLigacao= true;
	} else {
		gparam.bMostraLigacao= false;
	}
	//zoom in e out para dar um refresh na tela
	gparam.renderer.zoomIn();
	gparam.renderer.zoomOut();
} //.function menu_ligacoesExibe

function menu_rotulosPosicao(bTipo) { 
	if (bTipo===null) {
		
	} else if (bTipo) {
		gparam.btextoEmbaixoIcone=true;
	} else {
		gparam.btextoEmbaixoIcone=false;
	}
} //.function menu_rotulosPosicao

function menu_colorir(corEscolhida) {
	function colorir(n, cor) {
		var node = graphics.getNodeUI(n);
		try {
			node.getElementsByTagName('rect')[0].setAttribute('fill',cor);
		} catch (e){; };
		var no = graph.getNode(n);
		if (no) {
			no.data.cor = cor;
		}

	}
	if (!gparam.idNosSelecionados.size) {
		alertify.alert('Colorir', 'Não há itens selecionados para colorir. Selecione e tente novamente.', function(){ ; });
		return;
	}
	var cor = document.querySelector("#palheta").value; 
	if (corEscolhida) {
		cor = corEscolhida;
	}
	var tmensagem = (gparam.idNosSelecionados.size==1) ? 'Colorir 1 nó.' : ('Colorir '+ gparam.idNosSelecionados.size + ' nós selecionados.');
	var tsucesso = (gparam.idNosSelecionados.size==1) ? '1 nó foi colorido.' : (gparam.idNosSelecionados.size + ' nós foram coloridos.');
	for (let n of gparam.idNosSelecionados) {
		colorir(n, cor);
	}			
	alertify.success(tsucesso);
} //.function menu_colorir

function menu_ligar_selecionados(bEstrela, nomeLigacao, bSemMensagem) {
	// se bEstrela, liga o primeiro selecionado com todos os outros
	// se !bEstrela, tipo fila, liga linearmente do primeiro ao segundo, segundo ao terceiro e sucessivamente.
	if (gparam.idNosSelecionados.size<2) {
		if (!bSemMensagem) {
			alertify.alert('Ligar nós selecionados', 'Não há itens selecionados. Selecione e tente novamente.', function(){ ; });
		}
		return;
	}
	//ligação já existe, então edita, apaga a ligação e cria nova.
	if ((gparam.idNosSelecionados.size==2) && !nomeLigacao) {
		var id1 = [...gparam.idNosSelecionados][0], 
			id2 = [...gparam.idNosSelecionados][1];
		var labelLigacao = '';	
		var ligExistente = graph.hasLink(id1, id2);
		if (ligExistente) {
			labelLigacao = ligExistente.data.label ? ligExistente.data.label : '';
		} else { 
			ligExistente = graph.hasLink(id2, id1);
			if (ligExistente) { 
				labelLigacao = ligExistente.data.label ? ligExistente.data.label : '';
				gparam.idNosSelecionados = new Set([id2, id1]); //inverte ordem para a direção da seta permanecer a mesma
			}
		} 
		if (ligExistente) {
			nomeLigacao = prompt('Digite o texto da ligação:', labelLigacao);
			if (nomeLigacao===null) return;
			menu_desligar_selecionados(false);
		}
	}	
	let label = nomeLigacao?nomeLigacao:'';
	let primeiroNo = [...gparam.idNosSelecionados][0];
	
	if (!bSemMensagem) {
		var mensagem = bEstrela ? 'Deseja ligar o item ' +  primeiroNo + ' aos itens ' + (gparam.idNosSelecionados.size-1) + ' selecionados?' : 'Deseja ligar os ' + gparam.idNosSelecionados.size + ' itens selecionados?';
		//mensagem += '\nDigite o texto da ligaçao (opcional):';
		if (!nomeLigacao) {
			if (nomeLigacao==='') {
				if (!confirm(mensagem)) {
					label = null;
				} 
			} else {
				mensagem += '\nDigite o texto da ligaçao (opcional):';
				label = prompt(mensagem, '');
			}
		}
		if (label===null) {
			return;
		}
	}
	var ligacoes = [];
	var anterior = null;
	var destino = null;
	var inicial = null
	for (let n of gparam.idNosSelecionados) {
		if (!inicial) {
			anterior = n;
			inicial = n;
		} else {
			destino = n;
			ligacoes.push({'origem': anterior,
						   'destino': destino,
						   'cor': gparam.corLigacaoLink, //'green',
						   'camada': 1,		   
						   'tipoDescricao': '', //'link',
						   'label': label});
			if (!bEstrela) {
				anterior = destino;
			} 
		}
	}
	/*
	if (!bEstrela) { //isso fecha o círculo
		anterior = destino;
		ligacoes.push({'origem': anterior,
								   'destino': inicial,
								   'cor': gparam.corLigacaoLink, //'green',
								   'camada': 1,		   
								   'tipoDescricao': '', //'link',
								   'label': label});
	} */ 
	var noLigacoes = {'no':[], 'ligacao':ligacoes, 'mensagem':''};
	inserirJson(noLigacoes,' Ligações. ');
	return true;
} //.function menu_ligar_selecionados

function menu_desligar_selecionados(bRemoverTodasLigacoes) {
	//se bRemoverTodasLigacoes=false, só remove se a ligação for entre DOIS itens selecionados
	var resp;
	if (!gparam.idNosSelecionados.size) {
		alertify.alert('Remover ligação', 'Não há itens selecionados. Selecione e tente novamente.', function(){ ; });
		return;
	}
	if (bRemoverTodasLigacoes) {
		resp = confirm('Deseja remover TODAS as ligações dos itens selecionados? Não será possível reverter.');
		if (!resp) return;
	}

	var slinkIds = new Set();
	while (true) { //loop, primeiro tenta apagar link ENTRE os selecionados, se não achar ligação, tenta apagar todas as ligações dos selecionados
		graph.forEachLink(function(link){
			if (link) {
				if ( (gparam.idNosSelecionados.has(link.fromId) && gparam.idNosSelecionados.has(link.toId)) ||
					 ( bRemoverTodasLigacoes && (gparam.idNosSelecionados.has(link.fromId) || gparam.idNosSelecionados.has(link.toId)) ) ) {
						slinkIds.add(link); 
				}
			}
		});
		if (slinkIds.size) {
			break;
		}
		if (bRemoverTodasLigacoes) {
			if (!slinkIds.size) {
				alertify.success('Não há ligações a remover.');
				return;
			}
			break;
		} else {
			if (!slinkIds.size) {
				resp = confirm('Não há ligações ENTRE os itens selecionados. Deseja remover TODAS as ligações dos itens selecionados?');
				if (!resp) {
					return;
				}
				bRemoverTodasLigacoes = true;	
			}
		}
	}
	for (let link of slinkIds) {
		var linkUIaux=null;
		try {
			linkUIaux = graphics.getLinkUI(link.id);
			element=document.getElementById('link_label_'+linkUIaux.attr('id'));
			element.parentNode.removeChild(element);
			graph.removeLink(link);
		} catch (e){; };		
	}
} //menu_desligar_selecionados

function sv(texto) {
	return texto? texto:'';
} //.function sv

function junta(a, separador, b) {
	if (a && b) {
		return ''+ a + separador + b;
	} else if (a) {
		return ''+a;
	} else if (b) {
		return ''+b;
	}	
	return ''
} //.function junta

function removeGalhos(bExibeMensagem) {
	var quantidadeLigacoes;	
	var sNosRemover;	
	var contagem=0;
	if (!confirm('Deseja simplificar o gráfico, mantendo apenas os itens com mais de uma ligação ou que tenha alguma anotação ou cor? Não será possível reverter!!')) {
		return;
	}
	while (true) {
		sNosRemover = new Set();	
		graph.forEachNode(function(node) {
			if (node) {
				quantidadeLigacoes = graph.getLinks(node.id)? graph.getLinks(node.id).length: 0;
				if ((quantidadeLigacoes <= 1) && (node.data.camada != 0) && (!node.data.cor) && (!node.data.nota)) {
					sNosRemover.add(node.id);
				}
			}
		});
		contagem += sNosRemover.size;
		if (sNosRemover.size==0) {
			break;
		}
		sNosRemover.forEach(removeIdNo);
	}
	if (bExibeMensagem) {
		if (contagem>0) {
			alertify.success('Foram removidos ' + contagem + ' items.');
		} else {
			alertify.success('Não foram localizados itens para remover.');
		}
	}
} //.function removeGalhos

function menu_quebraGraficoEmPartes(){
	var ngrupos = prompt('Deseja quebrar este gráfico em outras abas em partes menores? Especifique a quantidade aproximada de novas abas (máximo de 10)', 4);
	ngrupos = parseInt(ngrupos);
	if (!ngrupos) {
		return;
	}
	if (ngrupos>10) {
		alertify.error('Escolha uma quantidade menor de novas abas.'); 
		return;
	}
	var tamanho = Math.floor(graph.getNodesCount()/ngrupos)+1;
	//console.log(tamanho);
	var conjuntos = separaGrupos(tamanho);
	if (conjuntos.length==1) {
		alert('O gráfico não pode ser separado.');
		return;
	}
	var k = 0;
	for (let conj of conjuntos) {
		var sconj = new Set(conj);
		//este alert serve para criar um delay entre as requisições... Se não houver pausa o servidor tenta criar arquivos json com nome repetido o que vai dar erro depois.
		resp = confirm('Deseja criar uma nova aba com ' + sconj.size + ' elementos?'); 
		if (resp) {
			k += 1;
			var jsonDados = getRedeNosLigacoes(false, sconj, true);
			openWindowWithPost({'json':jsonDados}, ''); //menu_copiaItensParaOutraAba não funciona neste caso, porque há uma demora para abrir a nova aba
	
		} else {
			resp = confirm('Deseja abrir outras abas?');
			if (!resp) {
				break;
			}
		}
	}
	alertify.success('Foram inseridas ' + k + ' novas abas');
} //.function menu_quebraGraficoEmPartes

function separaGrupos(tamanhoGrupo) {
	//pega os nos do gráfico e separa em grupos até tamanhoGrupo, mantendo os itens conectados juntos
	//se tamanhoGrupo=0, retorna os subcomponentes (árvores, regiões conectadas) do grafico, listaGrupos = lista de sets = [set(componente1), set(componente2)...]
	//se tamanhoGrupo<>0, retorna lista de conjuntos = [[conjunto1], [conjunto2],..]
	var di = {};
	var bMudou = false;
	var contagemAnterior = -1;
	//inicializa di com id, o loop while irá fazer que di[elemento] seja o menor para os que estão ligados
	graph.forEachLink(function(link){
		di[link.fromId] = link.fromId;
		di[link.toId] = link.toId;
	});
	graph.forEachNode(function(node){
		di[node.id] = node.id;
	});
	var sgrupos = null;
	while (1) {
		bMudou = false;
		graph.forEachLink(function(link){
			var menor = (di[link.fromId]<=di[link.toId]) ? di[link.fromId] : di[link.toId] ;
			if (di[link.fromId] != di[link.toId]) {
				bMudou = true;
			}
			di[link.fromId] = menor;
			di[link.toId] = menor;
		});
		
		sgrupos = new Set(Object.values(di));
		if ((sgrupos.size==contagemAnterior)&&(!bMudou)) {
			break;
		}
		contagemAnterior = sgrupos.size;
		//console.log(sgrupos.size);
		//break;
	}
	//dgrupo associa o menor valor do grupo com um set com os elementos do grupo
	var dgrupo = {};
	for (const [k, v] of Object.entries(di)) {
		var value = dgrupo[v];
		if (value == null) {
			dgrupo[v] = new Set();
		}
		dgrupo[v].add(k);	
	}

	//cada elemento de listaGrupos é set com itens conectados
	var listaGrupos = [];
	for (const v of Object.values(dgrupo)) {
		listaGrupos.push(v);
	}

	listaGrupos.sort(function(a,b){
	  return b.size - a.size; //ordem decrescente, size porque os elementos são sets
	});
	if (!tamanhoGrupo) {
		return listaGrupos; //[ set1, set2,...]
	}
	//conjuntos, tenta separar os conjuntos com no máximo tamanhoGrupo, preservando as ligações
	//se o grupo conexo já for maior que tamanhoGrupo, coloca sem quebrá-lo
	
	var conjuntos = [];
	var tamanhoAux = 0;
	var caux = []; //new Set();
	for (const v of listaGrupos) {
		if ((caux.length==0)||((v.size+caux.length)<tamanhoGrupo)) {
			Array.prototype.push.apply(caux, Array.from(v));
		} else {
			conjuntos.push(JSON.parse(JSON.stringify(caux)));
			caux = Array.from(v);
		}
		if (caux.length>=tamanhoGrupo) {
			conjuntos.push(JSON.parse(JSON.stringify(caux)));
			caux = []; //new Set();
		}
	}
	if (caux.length) {
		conjuntos.push(JSON.parse(JSON.stringify(caux)));
	}
	return conjuntos; //[ lista1, lista2,..]
} //.function separaGrupos

function menu_selecionaGruposColoridos(bCoresDistintas){ 
	//seleciona os grupos com ao menos dois itens coloridos. Se bCoresDistintas=true, duas cores devem ser distintas (entradas e alvos)
	var conjuntos = separaGrupos(0);
	var k = 1;
	if (conjuntos.length==1) {
		alert('O gráfico só tem um grupo conexo.');
		return;
	}
	var lista = [];
	for (let sconj of conjuntos) {
		var cores = new Set();
		let itensColoridosNoSubConjunto = 0;
		for (let idin of sconj) {
			var noData = graph.getNode(idin).data;
			if (noData && noData.cor) {
				cores.add(noData.cor);
				itensColoridosNoSubConjunto = itensColoridosNoSubConjunto +1;
			}
		}
		if (itensColoridosNoSubConjunto>=2) {
			if (!bCoresDistintas | (cores.size>=2) ) {
				Array.prototype.push.apply(lista, Array.from(sconj));
			}
		}
	}
	selecionaSet(new Set(lista));
	if (lista.length) {
		alertify.success('Os grupos foram selecionados, no total de '+lista.length+' elementos');
	} else {
		if (bCoresDistintas) {
			alertify.error('Não há grupos com cores diferentes');
		} else {
			alertify.error('Não há grupos com mais de um item colorido');
		}
	}	
} //.function menu_selecionaGruposColoridos

function removeIsolados(bExibeMensagem) {
	var quantidadeLigacoes;	
	var sNosRemover;	
	var contagem=0;
	if (!confirm('Deseja remover os itens sem ligação? Não será possível reverter!!')) {
		return;
	}
	sNosRemover = new Set();	
	graph.forEachNode(function(node) {
		if (node) {
			
			quantidadeLigacoes = 0 ;
			getlinks = graph.getLinks(node.id);
			if (getlinks) {
				quantidadeLigacoes += getlinks.length;
			}
			if (quantidadeLigacoes == 0) {
				sNosRemover.add(node.id);
			}
		}
	});
	contagem = sNosRemover.size;
	if (sNosRemover.size) {
		sNosRemover.forEach(removeIdNo);
	}
	if (bExibeMensagem) {
		if (contagem>0) {
			alertify.success('Foram removidos ' + contagem + ' items.');
		} else {
			alertify.success('Não foram localizados itens isolados para remover.');
		}
	}
} //.function removeIsolados

function criarNovoNo(idNovo, descricaoNovo, nota, nomeLigacao, dados, bNaoLigar, bLigarEntre) {
	/*
	var no = {'id': idNovo,
			   'descricao': descricaoNovo,
			   'camada': 0,
			   'situacao_ativa': true,
			   'imagem': iconeF(idNovo), //'icone-grafo-id.png',
			   'cor': 'yellow',
			   'nota': nota}; */
	var nodados = {};
	if (dados) {
		nodados = JSON.parse(JSON.stringify(dados))
	}
	nodados.id = idNovo;
	nodados.descricao = descricaoNovo;
	nodados.nota = nota;
	/* não está colocando mais itens novos como camada=0
	if (nodados.camada) {
		nodados.camada = nodados.camada; // ? nodados.camada : 0; //coloca camada 0 só se for isolado inicialmente
	} */
	//nodados.situacao_ativa = nodados.situacao_ativa ? nodados.situacao_ativa : true;
	nodados.imagem = nodados.imagem ? nodados.imagem : iconeF(idNovo);
	//nodados.cor = nodados.cor ? nodados.cor : 'yellow';
	nodados.cor = nodados.cor ? nodados.cor : 'white';
	//console.log(JSON.stringify(nodados)); 
	graph.addNode(idNovo, JSON.parse(JSON.stringify(nodados)));
	
	if (idNovo.startsWith('LI_')) { //isto pode dar inconsistência com imagem em base64??
		setTimeout(function(){
		   //menu_faviconNosItens(false);
		   faviconNoId(idNovo, '');
		},1000);
	}
	
	if (gparam.idnoSelecionado) {
		var position = gparam.layout.getNodePosition(gparam.idnoSelecionado);
		//let angulo=Math.PI*2*Math.random();
		//gparam.layout.setNodePosition(idNovo, position.x + Math.random()*gparam.springLength-gparam.springLength/2, position.y + Math.random()*gparam.springLength-gparam.springLength/2);
		//gparam.layout.setNodePosition(idNovo, position.x, position.y + gparam.springLength);
		var angulo = pegaAnguloLigacaoDoItemSelecionado(false);
		gparam.layout.setNodePosition(idNovo, position.x + Math.cos(angulo)*gparam.springLength, position.y + Math.sin(angulo)*gparam.springLength);
	};
	menu_rendererAtivarParar(true, false);
	selecionaNoid(idNovo, true, true);
	//trocar ordem da seleção para as setas ficarem saindo do novo item somente quando tiver mais de dois itens
	let ids = [...gparam.idNosSelecionados];
	//console.log('idnoselecionados');
	//console.log(gparam.idNosSelecionados);
	if (bLigarEntre) {
		ids.splice(1, 0, idNovo); 
		if (ids.length==2) {
			let links = graph.getLinks(ids[0]);
			if (links && links.length==1) {
				ids.push(links[0].toId);
			} 
			/*
			for (linkNo of links) {
				
			} */
		}
		//menu_desligar_selecionados(true); 
	} else if (ids.length>2) {
		ids.pop(idNovo);
		ids.unshift(idNovo);
	}
	gparam.idNosSelecionados = new Set(ids);
	gparam.idnoSelecionado = idNovo; 
	gparam.listaIdNosInseridos.push(new Set([idNovo]));
	if (gparam.idNosSelecionados.size==1) {
		return;
	}
	//if (!menu_ligar_selecionados(true, nomeLigacao)) { 
	if (bLigarEntre) {
		menu_ligar_selecionados(false, nomeLigacao, true);
	} else if (!bNaoLigar && !menu_ligar_selecionados(true, nomeLigacao, true)) {
		gparam.renderer.moveTo(position.x, position.y);
		gparam.layout.pinNode(graph.getNode(idNovo),true);
		menu_rendererAtivarParar(true, false);
	}
	selecionaNoid(idNovo, false, false);
} //.function criarNovoNo

//xxe
//const editarIconeColarImagem = async (e) => {
async function editarIconeColarImagem(e) {
	e.preventDefault();
	try {
		var clipboardItems = typeof navigator?.clipboard?.read === 'function' ? await navigator.clipboard.read() : e.clipboardData.files;
	} catch (error) {
		alertify.error('Não conseguiu ler a área de transferência. Tente pressionar CTRL+V');
		return;
	}
	for (const clipboardItem of clipboardItems) { //só os flavors como image/ aparecem aqui... Deve estar filtrado pelo campo? quando se copia de outra janela EditarImagem, copia aparece como text/html com base64
		let blob;
		if (clipboardItem.type?.startsWith('image/')) {
			// For files from `e.clipboardData.files`.
			blob = clipboardItem;
			// Do something with the blob.
			//appendImage(blob);
			editarColarImagemDoClipboard(blob);
		} else {
			  // For files from `navigator.clipboard.read()`.
			  const imageTypes = clipboardItem.types?.filter(type => type.startsWith('image/'))
			  for (const imageType of imageTypes) {
				blob = await clipboardItem.getType(imageType);
				// Do something with the blob.
				editarColarImagemDoClipboard(blob);
			  }
		}
	}
} //.function editarIconeColarImagem

function editarColarImagemDoClipboard(blob) {
	const reader = new FileReader();
	reader.onload = function (event) {
		const base64 = event.target.result;
		//const img = document.createElement("img");
		var img = document.getElementById('dlgItemEditar_imagem');
		img.src = URL.createObjectURL(blob);
		//document.body.append(img);
		//imageContainer.appendChild(img);
		//console.log(base64);
		gparam.base64Imagem = base64;
	};
	reader.readAsDataURL(blob);	
} //.function editarColarImagemDoClipboard

function menu_ligar_novo(idNovo, descricaoNovo, bNaoLigar, bLigarEntre, bInverterLIgacaoPadrao, posicao) {
	//cria novo item (não PJ) e liga com nós selecionados.
	if (idNovo && !bNaoLigar) {
		if (graph.hasNode(idNovo) && idNovo.startsWith('LI_')) { //neste caso, só liga com o nó já existente
			var resp = alert('O item já existe no gráfico. Este será selecionado:\n:' + idNovo);
			selecionaNoid(idNovo);
			return;
		}
	}
	idNovo = idNovo ? idNovo: ''; //idNovo = idNovo ?? ''
	descricaoNovo = descricaoNovo ? descricaoNovo: '';
	var dlgItemOriginal = document.getElementById('dlgItem');
	var dlgItem = document.getElementById('dlgItem').cloneNode(true); //clone para não mexer no original, soluciona problema de instabilidade (parava de funcionar depois de misturar tipos de consulta, cnpj e link)
	var camposTexto = dlgItem.getElementsByClassName('ajs-input');
	var dados = {};
	camposTexto[0].value= idNovo;
	camposTexto[1].value= descricaoNovo; 
	camposTexto[2].value= '';
	camposTexto[3].value= '';

	var campoImagem = camposTexto[4];
	if (1) {
		const img = document.createElement("img");
		img.id = "dlgItemEditar_imagem";
		img.alt = "Cole imagem aqui";
		img.height=100;
		img.width=100;
		img.title = "Para substituir a imagem, Cole (CTRL+V) aqui";
		campoImagem.appendChild(img);
	}
	
	dlgItemOriginal.parentNode.appendChild(dlgItem); // para dlgItem.outerHTML = '' funcionar no chrome
	dlgItem.outerHTML = ''; //receita de bolo para usar o alertify.confirm. sem isso  a linha de cima dava erro no chrome
	ativaAtalhos(false);
	gparam.base64Imagem = null;
	campoImagem.addEventListener('paste', editarIconeColarImagem);	
	
	alertify.confirm(dlgItem)
	//não funciona .set('defaultFocusOff', true)
	//não funciona .set('focus', camposTexto[0])
	.set('onfocus', function() { camposTexto[0].focus(); } )
	.set('onok', function(closeevent, value) { 
		ativaAtalhos(true); 
		var camposTexto = dlgItem.getElementsByClassName('ajs-input');
		//idNovo = camposTexto[0].value.toUpperCase().trim();
		idNovo = camposTexto[0].value.trim();
		descricaoNovo = camposTexto[1].value;
		var tnota = camposTexto[2].value;
		var tligacao = camposTexto[3].value;
		if (!idNovo) {
			alert('O Identificador não pode ser nulo. Tente novamente.');
			return;
		}
		if (idNovo.toLowerCase().startsWith('https://') || idNovo.toLowerCase().startsWith('http://')) {
			idNovo = 'LI_' + idNovo;
		} else if (idNovo.startsWith('"') && idNovo.endsWith('"')) { //aspas quando se copia o caminho completo pelo menu contextual no windows. não sei como fica em outros sistemas
			idNovo = 'AR_' + idNovo.slice(1,-1);
		} else if (idNovo.startsWith('C:\\') || idNovo.startsWith('D:\\') || (idNovo.substr(1,2)==':\\')) { //isso só vai funcionar no windows
			idNovo = 'AR_' + idNovo;
		} else if (idNovo.startsWith('LI_') || idNovo.startsWith('AR_')) { //não por em maiuscula, senão link para url não funciona
			//não faz nada
		} else {
			idNovo = idNovo.toUpperCase();
			idNovo = tipoPresumido(idNovo);
			while (graph.hasNode(idNovo)) {
				idNovo = prompt('Item novo:\n\nO identificador ' + idNovo + ' já existe no gráfico.\nAltere o novo identificador:', idNovo);
				if (idNovo===null) {
					return;
				}
				idNovo = idNovo.toUpperCase();
				idNovo = tipoPresumido(idNovo);
			}		
		}
		if (graph.hasNode(idNovo)) { //caso LI_ AR_
			alert('O identificador ' + idNovo + ' já existe no gráfico. Não será feita a inclusão');
			return;
		}
		/*
		if (idNovo.startsWith('PJ_')) {
			alert('Para inserir um PJ, use a opção Inserir CNPJ ou CPF (I)');
			ativaAtalhos(true);
			return;
		}*/
		descricaoNovo = idNovo.startsWith('PF_')?idNovo.substr(15):descricaoNovo;
		if (tligacao) {
			bNaoLigar = false;
		} 
		//dados.camada = bNaoLigar? 0 : 1; //ttt
		criarNovoNo(idNovo, descricaoNovo, tnota, tligacao, dados, bNaoLigar, bLigarEntre, bInverterLIgacaoPadrao);
		if (posicao) {
			gparam.layout.setNodePosition(idNovo, posicao.x, posicao.y);
			//console.log('setnodeposition: ' + posicao.x + ' ; ' +  posicao.y);
		}
		if (gparam.base64Imagem) {
			menu_faviconNosItens(gparam.base64Imagem);
		}
	}, function() { campoImagem.removeEventListener("paste", editarIconeColarImagem, false); 
		ativaAtalhos(true); }
	).set('oncancel', function() { campoImagem.removeEventListener("paste", editarIconeColarImagem, false); 
									ativaAtalhos(true);  })
	.set('title',"Novo Item (U)");

} //.function menu_ligar_novo

function menu_editar_no(noid) {
	//edita dados item, se o usuário alterar o id, cria novo item.
	if (!noid) {
		noid = gparam.idnoSelecionado;
	}
	var idNovo =  noid;
	var node = graph.getNode(noid);
	if (!node) {
		alert(noid + ' não foi encontrado.')
		return;
	}
	var ui=graphics.getNodeUI(noid); 
	var dlgItemOriginal = document.getElementById('dlgItemEditar');
	var dlgItem = document.getElementById('dlgItemEditar').cloneNode(true); //clone para não mexer no original, soluciona problema de instabilidade (parava de funcionar depois de misturar tipos de consulta, cnpj e link)
	var camposTexto = dlgItem.getElementsByClassName('ajs-input');
	camposTexto[0].value= noid;
	camposTexto[1].value= node.data.descricao;
	camposTexto[2].value= node.data.nota;
	//camposTexto[3] = texto ligacao, não existe mais para o formulário de edição
		
	var campoImagem = camposTexto[3];
	if (1) {
		const img = document.createElement("img");
		var nodeUI = graphics.getNodeUI(noid);
		if (nodeUI) {
			img.src = nodeUI.getElementsByTagName('image')[0].getAttribute('xlink:href');
		} 
		img.id = "dlgItemEditar_imagem";
		img.alt = "Cole imagem aqui";
		img.height=100;
		img.width=100;
		img.title = "Para substituir a imagem, Cole (CTRL+V) aqui";
		campoImagem.appendChild(img);
	}
	
	dlgItemOriginal.parentNode.appendChild(dlgItem); // para dlgItem.outerHTML = '' funcionar no chrome
	dlgItem.outerHTML = ''; //receita de bolo para usar o alertify.confirm. sem isso  a linha de cima dava erro no chrome
	ativaAtalhos(false);
	gparam.base64Imagem = null;
	campoImagem.addEventListener('paste', editarIconeColarImagem);
	
	alertify.confirm(dlgItem).set('onok', function(closeevent, value) { 
		ativaAtalhos(true); 
		var camposTexto = dlgItem.getElementsByClassName('ajs-input');
		//idNovo = camposTexto[0].value;
		var idNovo = camposTexto[0].value;
		var tligacao = camposTexto[3].value;
		if (!idNovo) {
			alert('O Identificador não pode ser nulo.');
			return;
		}
		
		if (idNovo.toLowerCase().startsWith('https://') || idNovo.toLowerCase().startsWith('http://')) {
			idNovo = 'LI_' + idNovo;
		} else if (idNovo.startsWith('"') && idNovo.endsWith('"')) { //aspas quando se copia o caminho completo pelo menu contextual no windows. não sei como fica em outros sistemas
			idNovo = 'AR_' + idNovo.slice(1,-1);
		} else if (idNovo.startsWith('C:\\') || idNovo.startsWith('D:\\') || (idNovo.substr(1,2)==':\\')) { //isso só vai funcionar no windows
			idNovo = 'AR_' + idNovo;
		} else if (idNovo.startsWith('LI_') || idNovo.startsWith('AR_')) { //não por em maiuscula, senão link para url não funciona
			//não faz nada
		} else {
			idNovo = idNovo.toUpperCase();
			idNovo = tipoPresumido(idNovo);
			while (graph.hasNode(idNovo) && (noid!=idNovo) ) {
				idNovo = prompt('Editar Item:\n\nO identificador ' + idNovo + ' não pode ser utilizado, pois já existe no gráfico.\nAltere o identificador:', idNovo);
				if (idNovo===null) {
					return;
				}
				idNovo = idNovo.toUpperCase();
				idNovo = tipoPresumido(idNovo);
			}
		}

		if (noid==idNovo) {
			node.data.descricao = camposTexto[1].value;
			node.data.nota = camposTexto[2].value;
			//poderia se usar reinsereComNovoId(idNovo, idNovo) ao invês de trocar uis
			ui.getElementsByTagName('tspan')[1].text(node.data.descricao);
			ui.getElementsByTagName('tspan')[2].text(node.data.nota);
			
		} else {
			if (graph.hasNode(idNovo)) { //caso LI_ AR_
				alert('O identificador ' + idNovo + ' já existe no gráfico. Não será feita a inclusão');
				return;
			}
			if ([ 'PF_', 'PJ_', 'EN_', 'TE_', 'EM_'].includes(noid.substr(0,3))) { 
				if (!confirm('ESTA OPERAÇÃO NÃO É RECOMENDADA!! Alterar este identificador pode causar INCONSISTÊNCIAS e não será possível buscar informações no Banco de Dados. Deseja prosseguir?')) {
					return;
				}
			}	
			node.data.descricao = camposTexto[1].value;
			node.data.nota = camposTexto[2].value;
			reinsereComNovoId(noid, idNovo); //xxx se alterar o id, essa rotina apaga e corrige .data em no e nas ligações.
		}		
		if (nodeUI && gparam.base64Imagem) {
			menu_faviconNosItens(gparam.base64Imagem);
		}
	}, function() { 
		campoImagem.removeEventListener("paste", editarIconeColarImagem, false);
		ativaAtalhos(true); }
	).set('oncancel', function() { campoImagem.removeEventListener("paste", editarIconeColarImagem, false); 
									ativaAtalhos(true); })
	.set('title',"Editar Item (E)");
} //.function menu_editar_no



function soDigitos(id) {
//usar com cautela, só deixar digitos para verificar cpf/cnpj pode dar resultado incorreto, p. ex: yy12345678901 seria considerado cpf
	return id.replace(/\D+/g, '');
} //.function soDigitos

function isNumeric(texto) {
  var er = /^[0-9]+$/;
  return (er.test(texto.trim()));
} //.function isNumeric

function tipoPresumido(id) {
	// supõe se tiver undercores na terceira posicao, já começa com tipo EN_, PF_ , PJ_, etc
	if (!id) {
		return '';
	}
	if ((id.length>3) && (id.substr(2,1) == '_') && (id.substr(0,2)==id.substr(0,2).toUpperCase()) && (!isNumeric(id.substr(0,2)))) { 
		return id.trim(); 
	}
	//var digitos = soDigitos(id); //problema em usar soDigitos, pode ter letra + 14 ou 11 numeros
	var idlimpo = id.replace(/[\.\-\//]/g, '').trim();
	if (isNumeric(idlimpo) && (idlimpo.length==14)) {
		return 'PJ_' + idlimpo;
	} else if (isNumeric(idlimpo) && (idlimpo.length==11)) { //falta adicionar nome
		return 'PF_' + idlimpo;
	} else {
		return 'ID_' + id.trim();
	}
} //.function tipoPresumido

function alterarItens(dadosNos) {//altera dados do item a partir de lista de dados de nos, corrige elemento visível (nota, cor ou imagem) 
	for (let no of dadosNos) {
		var noid = no['id'];
		var node = graph.getNode(noid);
		var ui=graphics.getNodeUI(noid); 
		for (const [chave, valor] of Object.entries(no)) {
			if (chave=='id') {
				continue;
			}
			var valorAux = valor.trim();
			if ((chave=='nota') && (valorAux.startsWith('+'))) { //se começar com +, adiciona a nota existente
				valorAux = node.data['nota'] + ' ' + valorAux.substr(1);
			} 
			node.data[chave] = valorAux;
			if (chave=='nota') {
				ui.getElementsByTagName('tspan')[2].text(valorAux);
				if (ui.children[0].tagName=='title') {
					ui.children[0].textContent = textoTooltip(node, true);
				}
			} else if (chave=='cor') {
				try {
					ui.getElementsByTagName('rect')[0].setAttribute('fill',valor);
				} catch (e){console.log(e); };		
			} else if (chave=='imagem') {
				var urlImagem = baseImagem + valor;
				if (valor.startsWith('http')) {
					urlImagem = valor;
				}
				try {
					ui.getElementsByTagName('image')[0].setAttribute('xlink:href', urlImagem);
				} catch (e){console.log(e); };				
			}
		}		
	}
} //.function alterarItens

function entrada_hierarquico_pyjs(entrada) {
	var entradaTabs = [];
	var kl = 0;
	var cab = entrada.split('\n')[0];
	//var identadorTabs = true; //trim remove espaços ou tabulação
	var kidentadores = 1;
	var insereNumeroNoId = false; //por default, insere número no id se for código python ou javascript
	var mostraNumero = false;

	if (!cab.startsWith('_>')) {
		console.log('erro.')
		return;
	}
	 //TODO ver se hierarquico vai adicionar nome da coluna

	insereNumeroNoId =  cab.includes('n') || cab.includes('N');
	mostraNumero = cab.includes('n');
	if (cab.includes('j')) {
		//identadorTabs = true;
		insereNumeroNoId = true;
	}
	if (cab.includes('p')) { //python, tabulação com 4 espaços
		//identadorTabs = false;
		kidentadores = 4;
		insereNumeroNoId = true;
	}
	/*
	if (cab.includes('e')) {
		identadorTabs = false;
	}*/
	if (cab.includes('n')) {
		mostraNumero = true;
	}		
	if (cab.search(/\d/g)!=-1) {
		kidentadores = parseInt(cab.match(/\d/g)[0]);
		kidentadores = kidentadores ? kidentadores : 1;
	}

	for (let linha of entrada.split('\n')) {
		if (!entradaTabs.length) {
			entradaTabs.push('_>'); //tabela hierarquica
		} else if (linha.trim()) {
			var recuo = Math.floor((linha.length - linha.trimStart().length)/kidentadores); //supõe PEP, quatro espaços de tabulação
			var linhax = '\t'.repeat(recuo);

			if (insereNumeroNoId) {
				linhax += kl.toString().padStart(4,0);
				if (mostraNumero) {
					linhax += ' ';
				} else {
					linhax += '__';
				}
				linhax += linha.trim();
			} else {
				linhax = linha.trimEnd();
			}
			entradaTabs.push(linhax);
		}
		kl += 1;
	}
	return  entradaTabs.join('\n');	
} //.function entrada_hierarquico_pyjs

function inserir_lista(entrada, bNaoConfirma) {
	//inserir três tipos de lista, dependendo se a primeira célula tiver um ou dois underscores ou sem underscore.
	//sem underscore na primeira célula, colunas A,B,C,D,E, cria ligacoes A->B com descrição de ligação C. D e E são descrições dos identificadores A e B
	//sem underscore, só uma coluna, insere identificadores, pfs ou pjs, só busca dados de cnpj, não adiciona camadas
	//1 underscore na primeira célula, por dupla de colunas (fila). Colunas A,B,C,D, gera ligações A->B, B->C, C->D, considera a primeira linha nome das colunas
	//2 underscores na primeira célula, por dupla de colunas (estrela). Colunas A,B,C,D, gera ligações A->B, A->C, C->D, considere a primeira linha como nome das colunas
	//1 undercore + sharp (_#). Coluna _#A, B, C, altera parametro B ou C do id A
   	
	//var itens = entrada.replace(/\n/g,';');
	var max = 0;
	var lista = [];
	var dadosExtras = [];
	var elems = null;
	entrada = entrada.replaceAll('\r\n', '\n');
	var primeiraLinhaEntrada = entrada.split('\n')[0];
	if (primeiraLinhaEntrada.startsWith('_~') || primeiraLinhaEntrada.startsWith('_>')) { //tipo python, troca espaços por tabs para tipoLista hierarquica
		entrada = entrada_hierarquico_pyjs(entrada);
	}
	for (let linha of entrada.split('\n')){
		elems = linha.split('\t');
		max = Math.max(max, elems.length);
	}

	//var kLinhas = 0;
	var bPrimeiraLinha = true;
	var tipoLista = 'ligacao';
	var itensLinhaAnterior = [];
	var linhaHierarquica = new Array(max);
	var itensLinha = [];
	var cabecalhos;
	
	for (let linha of entrada.split('\n')){
		elems = linha.split('\t');
		elems.map(s => s.trim()); //trim elementos
		if ((elems.join('').trim()=='') || (!linha.trim()) ){
			bPrimeiraLinha=true;
			itensLinhaAnterior = [];
			itensLinha = new Array(elems.length).fill(''); //iniciado só para copiar em itensLInhaAnterior
			linhaHierarquica = new Array(elems.length).fill('');
			continue
		}
		if (bPrimeiraLinha) {
			cabecalhos = JSON.parse(JSON.stringify(elems));
			if (max > cabecalhos.length) {
				var aux = Array(max - cabecalhos.length).fill('');
				cabecalhos = cabecalhos.concat(aux);
			}
			if (cabecalhos[0].startsWith('_+')) {
				tipoLista = 'fila';
			} else if (cabecalhos[0].startsWith('_*')) {
				tipoLista = 'estrela';
			} else if (cabecalhos[0].startsWith('_>')) {
				tipoLista = 'hierarquica';
			} else if (cabecalhos[0].startsWith('_#')) {
				tipoLista = 'alteraDados';
			} else {
				tipoLista = 'ligacao';
				cabecalhos=[];
				bPrimeiraLinha=false;
			}
		}

		if ((tipoLista!='ligacao') && (bPrimeiraLinha)){
			cabecalhos[0] = cabecalhos[0].substr(2);
			bPrimeiraLinha = false;
			continue;
		}
		bPrimeiraLinha = false;		
		var dadosExtrasNo = {};
		if (tipoLista == 'ligacao') { 
			//colunas A,B,C,D,E, cria ligacoes A->B com descrição de ligação C. D e E são descrições dos identificadores A e B
			switch(elems.length) {
				case 0:
					break;
				case 1:
					lista.push([tipoPresumido(elems[0]), '', '', '', '']);
					break;
				case 2:
					lista.push([tipoPresumido(elems[0]), tipoPresumido(elems[1]), '', '', '']);
					break;
				case 3:
					lista.push([tipoPresumido(elems[0]), tipoPresumido(elems[1]), elems[2], '', '']);
					break;
			    case 4: 
					lista.push([tipoPresumido(elems[0]), tipoPresumido(elems[1]), elems[2], elems[3], '']);
					break;
				default:
					lista.push([tipoPresumido(elems[0]), tipoPresumido(elems[1]), elems[2], elems[3], elems[4]]);
			}
		} else if (tipoLista == 'alteraDados') { 
			//colunas _#A,B,C,D,E, altera parametros definidos pelos rótulos B,C,D,E nos elementos da coluna A	
			var idPre = tipoPresumido(elems[0]);
			idPre = tipoPresumido(cabecalhos[0]? cabecalhos[0] + ' ' + elems[0] : elems[0]);	
			dadosExtrasNo['id'] = idPre;
			for (let k=1; k<=elems.length; k++) {
				if (cabecalhos[k]) {
					dadosExtrasNo[cabecalhos[k]] = elems[k];
					lista.push([idPre, '', '', '', '']);
				}
			}
			dadosExtras.push( JSON.parse(JSON.stringify(dadosExtrasNo)) );
		} else {
			//console.log(itensLinha);
			itensLinhaAnterior = JSON.parse(JSON.stringify(itensLinha)); //usado em hierarquica e |

			itensLinha = [];
			
			for (let k=0; k<elems.length; k++) {
				if (cabecalhos[k].startsWith('_-') || !elems[k])  { //ignora essa coluna
					itensLinha.push('');
					continue;
				}
				var cabecalhok = cabecalhos[k];
				if (cabecalhok.startsWith('|')) { //vinculo vertical
					cabecalhok = cabecalhok.substr(1);
					bLigacaoVertical = true;
				} else {
					bLigacaoVertical = false;
				}
				if (cabecalhok.startsWith('$')) { //se $ no nome da coluna, coloca o texto também na ligação
					cabecalhok = cabecalhok.substr(1);
					//nomeLigacao = cabecalhok;
				}

				var idPre = tipoPresumido(elems[k]);
				if (idPre.startsWith('ID_')) {
					idPre = tipoPresumido(cabecalhok? cabecalhok + ' ' + elems[k]:elems[k]);
				}
				itensLinha.push(idPre);
				if (bLigacaoVertical && itensLinhaAnterior[k]) {
					if (itensLinhaAnterior[k]) {
						lista.push([itensLinhaAnterior[k], idPre, '', '', '']);
					}
				}
			}
			//itensLinhaAnterior = JSON.parse(JSON.stringify(itensLinha)); //usado em hierarquica e |
					
			if (tipoLista == 'estrela') { // _* undercore + estrela
				//converte tabela para ligacões, por dupla de colunas (estrela). Colunas A,B,C,D, gera ligações A->B, A->C, C->D
				//se algum rotulo começar com 1 underscores, adiciona o texto como ligacao, senão adiciona nos elementos
				for (let k=1; k<itensLinha.length; k++) {
					var idPre1 = itensLinha[0]; 
					var idPre2 = itensLinha[k];
					if (!idPre1 ||  !idPre2) {
						continue;
					}
					var cabecalhok = cabecalhos[k];
					var nomeLigacao = '';
					if (cabecalhok.startsWith('|')) { //vinculo vertical
						cabecalhok = cabecalhok.substr(1);
					} 
					if (cabecalhok.startsWith('$')) { //se $ no nome da coluna, coloca o texto também na ligação
						cabecalhok = cabecalhok.substr(1);
						nomeLigacao = cabecalhok
					}
					lista.push([idPre1, idPre2, nomeLigacao, '', '']);

				}				
			} else if (tipoLista == 'fila')  { //um underscore + _+
				//converte tabela para ligacões, por dupla de colunas (fila). Colunas A,B,C,D, gera ligações A->B, B->C, C->D
				//se algum rotulo começar com 1 underscores, adiciona o texto como ligacao, senão adiciona nos elementos
				for (let k=0; (k+1)<elems.length; k++) {
					var idPre1 = itensLinha[k]; 
					var idPre2 = itensLinha[k+1];
					if (!idPre1 ||  !idPre2) {
						if (idPre1) {
							lista.push([idPre1, '', '', '', '']);
						}
						if (idPre2) {
							lista.push([idPre2, '', '', '', '']);
						}
						continue;
					}
					var cabecalhok1 = cabecalhos[k+1];
					var nomeLigacao = '';
					if (cabecalhok1.startsWith('|')) { //vinculo vertical
						cabecalhok1 = cabecalhok1.substr(1);
					} 
					if (cabecalhok1.startsWith('$')) { //se $ no nome da coluna, coloca o texto também na ligação
						cabecalhok1 = cabecalhok1.substr(1);
						nomeLigacao = cabecalhok1;
					}
					lista.push([idPre1, idPre2, nomeLigacao, '', '']);
				}
			} else if (tipoLista == 'hierarquica')  { //um underscore >  (_/)

				for (let k=0; k<itensLinha.length; k++) { 
					if (!itensLinha[k]) {
						continue;
					}
					if (k==0) {
						if (linhaHierarquica[0]) {
							lista.push([linhaHierarquica[0], itensLinha[0] , '', '', '']);
						} else if (itensLinhaAnterior[0]) {
							lista.push([itensLinhaAnterior[0], itensLinha[0] , '', '', '']);
						} else {
							lista.push([itensLinha[0],'' , '', '', '']);
						}	
						linhaHierarquica = new Array(max).fill('');
						linhaHierarquica[0] = itensLinha[0];

					} else if (itensLinha[k-1]) {
						lista.push([itensLinha[k-1], itensLinha[k], '<<>>', '', '']);
						for (let m=k; m<linhaHierarquica.length; m++) {
							linhaHierarquica[m] = '';
						}		
						linhaHierarquica[k] = itensLinha[k];				
					} else if (!itensLinha[k-1]) {
						if (itensLinhaAnterior[k]) {
							lista.push([itensLinhaAnterior[k], itensLinha[k], '', '', '']);
							linhaHierarquica[k] = itensLinha[k];
						} else if (itensLinhaAnterior[k-1]) {
							lista.push([itensLinhaAnterior[k-1], itensLinha[k], '<<>>', '', '']);
							linhaHierarquica[k] = itensLinha[k];								
						}  
						else if (linhaHierarquica[k]) {
							lista.push([linhaHierarquica[k], itensLinha[k], '', '', '']);
							linhaHierarquica[k] = itensLinha[k];
						} else { 
							console.log('Algo errado - hierarquica');
						}
					} else {
						alertify.error('Algo errado...');
						console.log('erro:' + itensLinha);
					}
					if (false) {
						for (let m=k+1; m<linhaHierarquica.length; m++) {
								linhaHierarquica[m] = '';
						}
					}
				}
			} else {
				console.log('erro...');
			}
		} 
	}
	
	if (!lista.length) {
		alertify.error('Formato não reconhecido.');
		return;
	}
	var tamanhoGrupo=0;
	if (tipoLista != 'hierarquica') {
		if (ajustarArvore(lista, true, 10)>0){
			tamanhoGrupo = prompt('A lista tem identificadores que não são PJ ou PF repetidos diversas vezes.\nPara facilitar a visualização, pode-se dividir esses identificadores em ramos.\nDigite uma quantidade de itens por ramos ou Cancele para inserir sem ramos.', 10);
		}
		if (tamanhoGrupo) {
			lista = ajustarArvore(lista, false, tamanhoGrupo);
		}
	}
	var nos = [];
	var ligacoes = [];
	var nosid = new Set();
	var cnpjsids = new Set();
	var cnpjDescricao = {};
    for (let linha of lista) {
		var id1 = linha[0]; 
		var id2 = linha[1]; 
		//var id1limpo = id1.replace(/[\.\-\//]/g, '');
		//var id2limpo = id2.replace(/[\.\-\//]/g, '');
		//TODO verificar se sem pontos e virgulas tem 14 dígitos
		if ((!id1) && (!id2)) {
			continue;
		}	
		if (id1.startsWith('PJ_')) {
			cnpjsids.add(id1);
			cnpjDescricao[id1] = linha[3];			
		} else if (id1) {
			let descricaoaux = id1.startsWith('PF_')?id1.substr(15):linha[3];
			if (!nosid.has(id1)) {
				nosid.add(id1);
				nos.push({'id': id1,
			   'descricao': descricaoaux, //linha[3],
			   'camada': 0,
			   //'situacao_ativa': true,
			   'imagem': iconeF(id1), //'icone-grafo-id.png',
			   'cor': 'yellow'});
			}
		}
		if (id2.startsWith('PJ_')) {
			cnpjsids.add(id2);
			cnpjDescricao[id2] = linha[4];
		} else if (id2) {
			let descricaoaux = id2.startsWith('PF_')?id2.substr(15):linha[4];
			if (!nosid.has(id2)) {
				nosid.add(id2);
				nos.push({'id': id2,
			   'descricao': descricaoaux, //linha[4],
			   'camada': 0,
			   //'situacao_ativa': true,
			   'imagem': iconeF(id2), //'icone-grafo-id.png',
			   'cor': 'yellow'});
			}
		}
	    if ((id1) && (id2)) {
		   ligacoes.push({'origem': id1,
			   'destino': id2,
			   'cor': gparam.corLigacaoLink, //'green',
			   'camada': 1,
			   'tipoDescricao': '', //'link',
			   'label': linha[2]});
		}
	}
	if (cnpjsids.size) {
		fazFetchCnpjs(cnpjsids, nos, ligacoes);
	} else {
		var noLigacoes = {'no':nos, 'ligacao':ligacoes, 'mensagem':''};
		inserirJson(noLigacoes,' drop lista ', bNaoConfirma);
		alterarItens(dadosExtras);
	}
	return;
	/*
    var entradaExemplo = [['ID_a1','ID_a2','l1','nome 1','nome 2'], 
					['ID_a1','ID_a3','l2', 'nome 1', 'nome 3'],
					['ID_a3','ID_a4','l3', 'nome 3', 'nome 4'] ]; */
	function ajustarArvore(lista, bSoConta, kGrupo) {
		//se um ID tiver mais de kGrupo ligacoes, vai quebrando em subarvores de no máximo kGrupo elementos.
		//const kGrupo=10;
		if (!kGrupo) {
			kGrupo=10;
		}
		var contagemIds = {}; //itens que não são cpf/cnpj ou EN_
		//conta elementos ID_ para abrir arvore
		for (let linha of lista) {
			var id1 = linha[0]; 
			if (id1.substr(0,3)=='ID_') {
				if (! contagemIds[id1]) {
					contagemIds[id1] = 0;
				}
				contagemIds[id1] += 1;
			}
		}
		//verifica quais itens tem muita repetição
		var idsArvore = new Set();
		for (let k of Object.keys(contagemIds)) {
			if (contagemIds[k]>kGrupo) {
				idsArvore.add(k);
			}
		}
		if (bSoConta) {
			return idsArvore.size;
		}
		contagemIds = {}; //contagem para loop da lista
		var listaAdicional = [];
		var listaSaida = [];
		for (let linha of lista) {
			let linhaSaida = [...linha];
			var id1 = linha[0]; 
			if (idsArvore.has(id1)) {
				if (!contagemIds[id1]) {
					contagemIds[id1]=0;
				}
				contagemIds[id1] += 1;
				idgrupo = id1 + '(' + String(Math.floor(contagemIds[id1]/kGrupo)+1) + ')';
				if (contagemIds[id1]%kGrupo==1) {
					listaSaida.push([id1, idgrupo,'','','']);
				}
				linhaSaida[0] = idgrupo;
			}
			listaSaida.push(JSON.parse(JSON.stringify(linhaSaida)));
		}
		return listaSaida;
	} //.function ajustarArvore

	function fazFetchCnpjs(cnpjsids, nos, ligacoes) {
		//var idin = [...cnpjsids].join(';');		
		var idinlista = [...cnpjsids];
		document.body.style.cursor = 'wait';
		let bodyjson = JSON.stringify(idinlista);
		var url =  base + 'grafojson/cnpj/0/' + idinlista[0];
		if (idinlista.length>1) {
			url += ' (' + idinlista.length + ' itens)';
		}
		//fetch(url, {method: 'get'}) // mode: 'cors',pos
		fetch(url, {method: 'post', body:  bodyjson, headers: {"Content-type": "application/json"}, cache: "no-store"}) // mode: 'cors',
		  .then(
			function(response) {
			  if (response.status !== 200) {
				mensagemErroHttp(response);
				return;
			  }
			  // Examine the text in the response
			  response.json().then(function(data) {
				//console.log(data);
				document.body.style.cursor = 'default';
				for (let n of data['no']) {
					nos.push(JSON.parse(JSON.stringify(n)));
					//todo verificar se todos os cnpjs supostos apareceram
				}
				for (let li of data['ligacao']) {
					ligacoes.push(JSON.parse(JSON.stringify(li)));
				}
				var noLigacoes = {'no':nos, 'ligacao':ligacoes, 'mensagem':''};
				inserirJson(noLigacoes,' drop lista ', bNaoConfirma);
				alterarItens(dadosExtras);
			  });
			}
		  )
		  .catch(function(err) {
			document.body.style.cursor = 'default';
			console.log('Fetch Error :-S', err);
			alertify.error('Aconteceu um erro (Fetch error ' + err + ')');
		  });
	} //.function fazFetchCnpjs
} //.function inserir_lista

function menu_editarNota(noid){
	var ui=graphics.getNodeUI(noid); 
	var nota = graph.getNode(noid).data.nota;
	nota = nota? nota: '';
	ativaAtalhos(false);
	var brenderer = menu_rendererAtivarParar(false, false);
	var tprompt = 'Digite texto de anotação.';
	if (gparam.idNosSelecionados.size>1) {
		tprompt += ' Há ' + gparam.idNosSelecionados.size + ' itens selecionados. O mesmo texto de Nota será aplicado em todos. Não será possível reverter as alterações.'
	}
	alertify.prompt( 'Editar Nota', tprompt, nota
	   , function(evt, texto) { 
			if (!(texto===null)) { 
				for (let nid of gparam.idNosSelecionados) {
					ui=graphics.getNodeUI(nid); 
					ui.getElementsByTagName('tspan')[2].text(texto);
					graph.getNode(nid).data.nota = texto;
					try {
						ui.children[0].textContent = textoTooltip(graph.getNode(nid), true);
					} catch (e){; };
				}
			}
			menu_rendererAtivarParar(brenderer, false);
			ativaAtalhos(true);
		}, function() { 
			ativaAtalhos(true);
			menu_rendererAtivarParar(brenderer, false);
	});
} //.function menu_editarNota

function menu_alterarIcone(nomeIcone) { 
	var menuIconeOptions, nomeIcone;
	if (!nomeIcone) {
		var menuIconeOptions = document.getElementById('menu_selecao_icone_options');
		var nomeIcone = menuIconeOptions.value;
	}
	if (nomeIcone) { 
		for (let noid of gparam.idNosSelecionados) {
			let no = graph.getNode(noid);
			no.data.imagem = nomeIcone;
			var node = graphics.getNodeUI(noid);
			try {
				node.getElementsByTagName('image')[0].setAttribute('xlink:href', baseImagem + nomeIcone);
			} catch (e){; };
		}		
	} 
	if (menuIconeOptions) {
		menuIconeOptions.value=0; 
	}
} //.function menu_alterarIcone

function saveTextAsFile(textToSave, nomeArquivo, mime) {   //salva arquivo texto sem precisar mandar para o servidor.
	var textToSaveAsBlob = new Blob([textToSave], mime); //{type:"text/plain"});
	var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);
	var fileNameToSaveAs = nomeArquivo; 
	var downloadLink = document.createElement("a");
	downloadLink.download = fileNameToSaveAs;
	downloadLink.innerHTML = "Download File";
	downloadLink.href = textToSaveAsURL;
	downloadLink.onclick = function (event) {document.body.removeChild(event.target);} ;
	downloadLink.style.display = "none";
	document.body.appendChild(downloadLink);
	downloadLink.click();
} //.function saveTextAsFile

function menu_exportaExcel(bSoSelecionados) {
	menu_exportaArquivo(bSoSelecionados, 'xlsx');
} //.function menu_exportaExcel(bSoSelecionados)

function menu_exportai2(bSoSelecionados) {
	menu_exportaArquivo(bSoSelecionados, 'anx');
} //.function menu_exportai2

function menu_exportaArquivo(bSoSelecionados, tipo, jsonIn) {
	//jsonIn - se informado, ignora o parametro bSoSelecionados
	var jsonDados, url;
	if (jsonIn){ 
		jsonDados = jsonIn;
	} else {
		jsonDados = getRedeNosLigacoes(bSoSelecionados);
	}
	if (jsonDados['no'].length==0) {
		alertify.error('Não há itens para exportar.');
		return;
	}
	if (tipo=='xlsx') {
		url = 'dadosemarquivo/xlsx';
	} else if (tipo=='anx') {
		url = 'dadosemarquivo/anx';
	} else if (tipo=='osm') {
		if (jsonDados['no'].length>10) {
			alert('Se houver mais de ' + gparam.inicio.geocode_max + ' endereços, serão utilizados somente as coordenadas do município dos cnpjs. A api de geolocalização de endereço só é usada com poucos itens, devido à lentidão. Se quiser um mapa com localização precisa, use a rotina com um gráfico menor.');
		} else {
			alertify.warning('A rotina de geolocalização usa a api do OpenStreetMaps e irá demorar (1 segundo por endereço).'); 
		}
		//url = 'dadosemarquivo/osm';
		url = 'mapa'
	} else if (tipo=='json') {
		url = ''; //'selecao_de_itens';
	} else {
		return;
	}
	openWindowWithPost(jsonDados, url);
	//iframeAuxiliar.exportaSoSelecionados = bSoSelecionados;
} //.function menu_exportaArquivo


function getRedeNosLigacoes(bSoSelecionados, setNos, bSemPosicao) {	
	//se setNos=null, pega todos os itens do gráfico ou apenas ou selecionados
	//se setNos for especificado, pega esses da lista
	//return dojo.toJson({'no':listaNoInicial, 'ligacao':listaLigacaoInicial});
	//return JSON.stringify({'no':listaNoInicial, 'ligacao':listaLigacaoInicial}, filtroDeMembros);
	var nosAux=[], ligacoesAux=[];
	//pega dados apartir do vivagraph, assim não é preciso fazer ajustes em listaLigacaoInicial ou listaNoInicial
	var setAux = setNos ? setNos : gparam.idNosSelecionados;
	
	if (!setNos && !bSoSelecionados) { // || setNos) {
		graph.forEachNode( 
			function(node) {
				var nodedata = JSON.parse(JSON.stringify(node.data));
				if (!bSemPosicao) {
					nodedata['posicao'] = gparam.layout.getNodePosition(node.id);
					nodedata['pinado'] = gparam.layout.isNodePinned(node);
				} else {
					try {
						delete nodedata['posicao'];
						delete nodedata['pinado'];
					} catch (e){; };
				}
				if (setNos) { 
					if (setNos.has(node.id)) {
						nosAux.push(nodedata);	
					}
				} else {
					if ((!bSoSelecionados) || gparam.idNosSelecionados.has(node.id)) {
						nosAux.push(nodedata);			
					}
				}
			}
		);
	} else { //!bSoSelecionados
		for (let noid of setAux) {
			var node = graph.getNode(noid);
			if (node) {
				var nodedata = JSON.parse(JSON.stringify(node.data));
				if (!bSemPosicao) {
					nodedata['posicao'] = gparam.layout.getNodePosition(node.id);
					nodedata['pinado'] = gparam.layout.isNodePinned(node);
				} else {
					try {
					delete nodedata['posicao'];
					delete nodedata['pinado'];
					} catch (e){; };
				}
				nosAux.push(nodedata);				
			}
		}
	}
	graph.forEachLink(function(link){
		/* ligacoesAux.push(
			{"origem":link.fromId,
			"destino":link.toId ,
			"cor":link.data.cor,
			"camada":link.data.camada,
			"tipoDescricao": link.data.tipoDescricao,
			"label": link.data.label
			}
		); */
		if (setNos) { 
			if (setNos.has(link.fromId) && setNos.has(link.toId)) {
				ligacoesAux.push(link.data);	
			}		
		} else {
			if ((!bSoSelecionados) || (gparam.idNosSelecionados.has(link.fromId) && gparam.idNosSelecionados.has(link.toId))) {
				ligacoesAux.push(JSON.parse(JSON.stringify(link.data)));	
			}
		}
	}); 
	return {'no':nosAux, 'ligacao':ligacoesAux};
} //.function getRedeNosLigacoes

function menu_salvaJsonArquivo(bSoSelecionados) {
	var redeItens = getRedeNosLigacoes(bSoSelecionados);
	if (redeItens.no.length==0) { 
		alertify.error('Não há itens para exportar');
	} else {
		var data1 = new Date(); // toIsoString não corrige timezone
		var datahora = new Date(data1.getTime() - (data1.getTimezoneOffset() * 60000)).toISOString().replaceAll(':','.');
		saveTextAsFile(JSON.stringify(redeItens), 'rede_cnpj-'+datahora+'.json', {type:"application/json"});
	}
} //.function menu_salvaJsonArquivo

/*
function replaceAll(texto, textoAProcurar, textoASubstituir) { // pode ser substituido por string.replaceAll, que já existe no javascript
	//return texto.split(textoAProcurar).join(textoASubstituir);
	if (texto) {
		return texto.replace(new RegExp(textoAProcurar,'g'), textoASubstituir); 
	} else {
		return '';
	}
} //.function replaceAll
*/

function converteImagens2Base64(listaImagens) {
	var dicionarioBase64 = {};
	var c = document.createElement('canvas');
	for (let nomeImagem of listaImagens) {
		var img = new Image();
		img.src = baseImagem + nomeImagem;
		img_home.appendChild(img);
		if (1) {
			c.height = img.naturalHeight;
			c.width = img.naturalWidth;
			var ctx = c.getContext('2d');
			ctx.drawImage(img, 0, 0, c.width, c.height, 0, 0, c.width, c.height);
			var base64String = c.toDataURL();
			dicionarioBase64[nomeImagem] = base64String;
		}
	}
	return dicionarioBase64;
} //.function converteImagens2Base64() 

function getXMLdeSVG() {
	var svg_xml = (new XMLSerializer).serializeToString(document.getElementsByTagName('svg')[0]); 
	//svg_xml = replaceAll(svg_xml,'xmlns:xlink="http://www.w3.org/1999/xlink"',''); //esse link é acrescentado em campo de texto, causando erro no svg
	svg_xml = svg_xml.replaceAll('xmlns:xlink="http://www.w3.org/1999/xlink"',''); //esse link é acrescentado em campo de texto, causando erro no svg
	svg_xml = svg_xml.replace('<svg ', '<svg xmlns:xlink="http://www.w3.org/1999/xlink" '); //define namespace para link
	/*
	var listaImagens= [
			'icone-grafo-masculino.png',
			'icone-grafo-feminino.png',
			'icone-grafo-desconhecido.png',
			'icone-grafo-endereco.png',
			'icone-grafo-telefone.png',
			'icone-grafo-email.png',
			'icone-grafo-empresa-publica.png',
			'icone-grafo-empresa-individual.png',
			'icone-grafo-empresa.png',
			'icone-grafo-empresa-fundacao.png',
			'icone-grafo-empresa-estrangeira.png',
			'icone-grafo-id.png' ]; */
	var sImagens = new Set(); //gparam.listaImagens;
	//verifica quais imagens estão sendo usadas.
	var pedacos = svg_xml.split('xlink:href="' + baseImagem);
	for (let p of pedacos) {
		if (p.indexOf('.png') != -1) {
			var nome = p.split('.png')[0];
			if (nome) {
				sImagens.add(nome+'.png');
			}
		}
	}
	var listaImagens = [...sImagens];
	//ver http://d3export.housegordon.org/ exemplo para exportação svg		
	var dicionario = converteImagens2Base64(listaImagens);
	for (let key of listaImagens) {
		var baseStr=dicionario[key];
		var strProcurar = 'xlink:href="' + baseImagem + key + '"';
		var strSubstituicao = 'xlink:href="'+baseStr + '"';
		//svg_xml = replaceAll(svg_xml, strProcurar, strSubstituicao);
		svg_xml = svg_xml.replaceAll(strProcurar, strSubstituicao);
	}
	return svg_xml;
} //.function getXMLdeSVG()

function menu_exportaSVG() {
	var mime={type:"image/svg"};
	alertify.success("SVG (Scalable Vector Graphics)");
	var data1 = new Date(); // toIsoString não corrige timezone
	var datahora = new Date(data1.getTime() - (data1.getTimezoneOffset() * 60000)).toISOString().replaceAll(':','.');	
	saveTextAsFile(getXMLdeSVG(), 'rede_cnpj-'+datahora+'.svg', mime); 
} //.function menu_exportaSVG

function menu_zoomin(teclaShift, teclaCtrl) {
	menuOnClick(); //firefox no android, não está fechando o menu
	if (teclaCtrl) {
		return;
	}
	if (teclaShift) {
		return menu_configurar_springLength(1);
	}
	var vezes = gparam.mobile?6:3;
	var escalamax = gparam.mobile?8:2;
	if (gparam.renderer.getTransform().scale>escalamax) {
		return;
	}
	for(var k=0; k<vezes; k++) {
		var escala = gparam.renderer.zoomIn();
		if (escala>escalamax) {
			break;
		}
	}
} //.function menu_zoomin

function menu_zoomout(teclaShift, teclaCtrl) {
	menuOnClick(); //firefox no android, não está fechando o menu
	if (teclaCtrl) {
		return;
	}
	if (teclaShift) {
		return menu_configurar_springLength(-1);
	}
	var vezes = gparam.mobile?6:2;
	for(var k=0; k<vezes; k++) {
		var escala = gparam.renderer.zoomOut();
	}
} //.function menu_zoomout

function menu_input_cnpj(elemento) {
    if(event.key === 'Enter') {
		gparam.inserirDefault = elemento.value;
		var cn = elemento.value.trim().toUpperCase();
		if (isNumeric(cn) && (cn.length==11)) { 
			alertify.warning('A busca por CPF pode apresentar resultados incorretos, pois a tabela de sócios não tem todos os dígitos do identificador.');
		}
		menu_incluirCamada(elemento.value, 1);
	}
} //.function menu_input_cnpj

//teclas Up, down, left e right servem somente para navegar árvore hierárquica
function menu_teclaUp(bSemMensagem) { //segue direção da seta
	var proximoNo = null;
	
	if (gparam.idNosSelecionados.size>1) {
		var lista = [...gparam.idNosSelecionados];
		lista.unshift(lista.pop());
		primeiroNoid = [...gparam.idNosSelecionados][0];
		selecionaSet(new Set(lista), primeiroNoid);
		return;
	}

	graph.forEachLinkedNode(gparam.idnoSelecionado, function(nodeaux, link){
		if (link.toId==gparam.idnoSelecionado) {
			proximoNo = link.fromId;
			return;
		}
	});	
	
	if (proximoNo) {
		selecionaNoid(proximoNo, false, false);
	} else if (!bSemMensagem) {
		alertify.error('Não encontrou item anterior');
	}
} //.function menu_teclaUp

function menu_teclaRight(bSemMensagem) { //segue direção contrária da seta?
	var proximoNo = null;
	if (gparam.idNosSelecionados.size>1) {
		var lista = [...gparam.idNosSelecionados];
		lista.push(lista.shift());
		primeiroNoid = [...gparam.idNosSelecionados][0];
		selecionaSet(new Set(lista), primeiroNoid);
		return;
	}
	var k = 0;

	graph.forEachLinkedNode(gparam.idnoSelecionado, function(nodeaux, link){
		if (!proximoNo) {
			if (link.fromId==gparam.idnoSelecionado) {
				proximoNo = link.toId;
				k += 1;
				if (k>1) {
					return;
				}
			}
		}
	});	
	
	if (proximoNo) {
		selecionaNoid(proximoNo, false, false);
	} else if (!bSemMensagem) {
		alertify.error('Não encontrou item.');
	}
} //.function menu_teclaRight

function menu_teclaLeft(bSemMensagem) { //segue direção da seta
	var proximoNo = null;
	if (gparam.idNosSelecionados.size>1) {
		var lista = [...gparam.idNosSelecionados];
		lista.unshift(lista.pop());
		primeiroNoid = [...gparam.idNosSelecionados][0];
		selecionaSet(new Set(lista), primeiroNoid);
		return;
	}

	graph.forEachLinkedNode(gparam.idnoSelecionado, function(nodeaux, link){
		if (link.fromId==gparam.idnoSelecionado) {
			proximoNo = link.toId;
			return;
		}		
	});	
	
	if (proximoNo) {
		selecionaNoid(proximoNo, false, false);
	} else if (!bSemMensagem) {
		alertify.error('Não encontrou item.');
	}
} //.function menu_teclaLeft

function menu_teclaDown(bSemMensagem) { 
//segue direção da seta, se chega no final do ramo, volta e entra no ramo pela esquerda
//se houver vários itens selecionados, move para visualizar o último (anterior) da seleção
	/* //sintaxe antiga, antes desselecionada e só deixava o primeiro selecionado
	if (gparam.idNosSelecionados.size>1) {
		const lastValue = Array.from(gparam.idNosSelecionados).pop();
		selecionaNoid(lastValue, false, false);
		return;
	}
	*/
	if (gparam.idNosSelecionados.size>1) {
		var lista = [...gparam.idNosSelecionados];
		lista.push(lista.shift());
		primeiroNoid = [...gparam.idNosSelecionados][0];
		selecionaSet(new Set(lista), primeiroNoid);
		return;
	}
	var noInicial = gparam.idnoSelecionado;
	var noid = gparam.idnoSelecionado;
	menu_teclaRight(true);
	if (noid != gparam.idnoSelecionado) {
		return;
	}
	var nosCaminho = new Set(noid);
	var passos = 0;
	while (true) {
		//console.log(gparam.idnoSelecionado);
		passos += 1;
		if (passos>graph.getNodesCount()*10) { //para evitar loop infinito
			selecionaNoid(noInicial, false, false);
			if (!bSemMensagem)  {
				alertify.error('Não encontrou item seguinte.');
			}
		}
		nosCaminho.add(noid);
		//console.log('up');
		menu_teclaUp(true);
		if (noid == gparam.idnoSelecionado) { //não saiu do lugar, sair da rotina
			selecionaNoid(noInicial, false, false);
			if (!bSemMensagem)  {
				alertify.error('Não encontrou item seguinte.');
			}
				break;			
		}		
		var knos = 0;
		var proximoNo = null;
		graph.forEachLinkedNode(gparam.idnoSelecionado, function(nodeaux, link){
			if (link.fromId==gparam.idnoSelecionado) { 
				knos += 1;
				if (knos==2) {
					proximoNo = link.toId;
					return;
				}
			}		
		});	
		if (knos>1) {
			selecionaNoid(proximoNo, false, false);
			if (!nosCaminho.has(gparam.idnoSelecionado)) {
				//console.log('saiu x1');
				break; 
			} else {
				menu_teclaUp(true);
			}
		}	
		noid =  gparam.idnoSelecionado;
	}
} //.function menu_teclaDown

function menu_configurar_nodeSize() {
	var parametro = prompt('Digite o tamanho do ícone.', gparam.nodeSize);
	if (!parametro) {
		return;
	}
	gparam.nodeSize = parseInt(parametro);
	//pra funcionar corretamente, é necessário mudar todos os elementos visuais que usam nodeSize, como rect, etc... 
	graph.forEachNode( function(node) {
		var ui=graphics.getNodeUI(node.id); 
		if (gparam.btextoEmbaixoIcone) { //se houver items criados com um estado ou outro, pode ficar inconsistente e isso não resolve.
			ui.getElementsByTagName('text')[0].attr('x', gparam.nodeSize/2).attr('y', String(gparam.tamanhoFonte*1.1 + gparam.nodeSize) + 'px');;		
			ui.getElementsByTagName('tspan')[0].attr('x', gparam.nodeSize/2);		
			ui.getElementsByTagName('tspan')[1].attr('x', gparam.nodeSize/2);
			ui.getElementsByTagName('tspan')[2].attr('x', gparam.nodeSize/2);
			ui.getElementsByTagName('image')[0].attr('width', gparam.nodeSize).attr('height', gparam.nodeSize);
			ui.getElementsByTagName('rect')[0].attr('width', gparam.nodeSize).attr('height', gparam.nodeSize);
			ui.getElementsByTagName('rect')[1].attr('width', gparam.nodeSize).attr('height', gparam.nodeSize);
		} else {
			ui.getElementsByTagName('text')[0].attr('x', gparam.nodeSize).attr('y', gparam.nodeSize*0.5+gparam.tamanhoFonte*0.5);;		
			ui.getElementsByTagName('tspan')[0].attr('x', gparam.nodeSize*1.2);		
			ui.getElementsByTagName('tspan')[1].attr('x', gparam.nodeSize*1.2);
			ui.getElementsByTagName('tspan')[2].attr('x', gparam.nodeSize*1.2);
			ui.getElementsByTagName('image')[0].attr('width', gparam.nodeSize).attr('height', gparam.nodeSize);
			ui.getElementsByTagName('rect')[0].attr('width', gparam.nodeSize).attr('height', gparam.nodeSize);
			ui.getElementsByTagName('rect')[1].attr('width', gparam.nodeSize).attr('height', gparam.nodeSize);		
		}
	}); 
} //.function menu_configurar_nodeSize

function menu_configurar_springLength(zoomInOut) {
	var tamanho = gparam.layout.simulator.springLength();
	if (zoomInOut==-1) {
		gparam.layout.simulator.springLength(tamanho*0.9);
		gparam.springLength = tamanho*0.9;
	} else if (zoomInOut==1) {
		gparam.layout.simulator.springLength(tamanho*1.1);
		gparam.springLength = tamanho*1.1;
	} else {
		var parametro = prompt('Digite o comprimento da ligação (valor padrão ' + gparam.springLength + ')', tamanho);
		if (parametro) {
			gparam.layout.simulator.springLength(parametro);
			gparam.springLength = parametro;
		}
	}
	menu_rendererAtivarParar(true, false); //para atualizar tela
} //.function menu_configurar_springLength

function balanca() {
//deslocamento para o renderizador atualizar tela, não adianta se renderer estiver parado.
	if (!gparam.idnoSelecionado) {
		return;
	}
	var position = gparam.layout.getNodePosition(gparam.idnoSelecionado);
	gparam.layout.setNodePosition(noaux.id, position.x+10, position.y+10);
} //.function balanca

function menu_configurar_springCoeff() {
	var parametro = prompt('Digite o coeficiente da "mola" da ligação (valor padrão 0.0002)', gparam.layout.simulator.springCoeff());
	if (parametro) {
		gparam.layout.simulator.springCoeff(parametro);
	}
} //.function menu_configurar_springCoeff

function menu_configurar_gravity() {
	var parametro = prompt('Digite o valor da gravidade (valor padrão -1.2)', gparam.layout.simulator.gravity());
	if (parametro) {
		gparam.layout.simulator.gravity(parametro);
	}
} //.function menu_configurar_gravity

function menu_configurar_dragCoeff() {
	var parametro = prompt('Digite o coeficiente de arrasto (valor padrão 0.02)', gparam.layout.simulator.dragCoeff());
	if (parametro) {
		gparam.layout.simulator.dragCoeff(parametro);
	}
} //.function menu_configurar_dragCoeff

function menu_configurar_theta() {
	var parametro = prompt('Digite do coeficiente theta (valor padrão 0.8)', gparam.layout.simulator.theta());
	if (parametro) {
		gparam.layout.simulator.theta(parametro);
	}
} //.function menu_configurar_theta(

//menu contextual
function showMenu(x, y){
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.classList.add('show-menu');
} //.function showMenu

function hideMenu(){
	//menu.classList.contains('show-menu') //para verificar
    menu.classList.remove('show-menu');
} //.function hideMenu

function onContextMenu(e){
	//	Para evitar ativar menu contextual com alertify.prompt
	if (document.onkeydown == null) { //teste, quando ativaAtalhos(false), seta-se document.onkeydown=null. Então se onkeydown==null, supõe que os teclados de atalho estão desativados e desativa o menu contextual da rede
		return;
	}
	e.preventDefault();
	showMenu(e.pageX, e.pageY);
    document.addEventListener(gparam.eventclick, menuOnClick, false);
} //.function onContextMenu

function menuOnClick(e){
	//devido a inconsistência no firefox e chrome no android, foi colocado menuOnClick(); antes de todos os comandos do menu
	hideMenu();
	document.removeEventListener(gparam.eventclick, menuOnClick);
	//window.scrollTo(0,0); //ttt
} //.function menuOnClick

function menu_botao(event) {
	event.preventDefault();
	// menu funciona no chrome do android mas não no firefox (não fecha o menu)
	if (gparam.mobile) {
		showMenu(7,80);
	} else {
		showMenu(7,30);
	}
	setTimeout(function(){
        document.addEventListener(gparam.eventclick, menuOnClick, false);
	},1000);
	event.preventDefault();
	return false;
} //.function menu_botao
//.menu contextual

//resposta a evento drop no div do menu, para abrir opção de inserção. Por exemplo, arrastar do word ou excel uma lista de cnpjs.
function dragover_handler(ev) {
	ev.preventDefault();
	// Define o dropEffect para ser do tipo move
	ev.dataTransfer.dropEffect = "copy"
} //.function dragover_handler

function drop_handler(ev) {
	ev.preventDefault();
	// Pega o id do alvo e adiciona o elemento que foi movido para o DOM do alvo
	var tipos = ev.dataTransfer.types;
	//console.log(tipos);
	//window.focus(); //não funciona, o focus with no aplicativo de origem da dragagem
	if (tipos.includes("rede_json")) { //recebe botão DRAG de outra aba da rede
		var nosLigacoes = ev.dataTransfer.getData("rede_json"); 
		inserirJson(JSON.parse(nosLigacoes), 'Drop. ');
	} else if (tipos.includes("text/x-moz-url")) { //drop link url - funciona no firefox, mas no chrome não aparece esse flavor
		//var data = ev.dataTransfer.getData("text");
		var lista = ev.dataTransfer.getData("text/x-moz-url").split('\n'); //url separado do titulo por linha
		//menu_ligar_novo('LI_' + lista[0], lista[1]); 
		//código para tirar duplicação da descrição, mas complica demais.
		var tdescricao = lista[1];
		if (labelsNo_LI('LI_' + lista[0], gparam.tamCorteLabel).toUpperCase()==lista[1].toUpperCase()) { //se id ficar igual a descrição (nome da página), ignora descricao
			tdescricao = '';
		}
		menu_ligar_novo('LI_' + lista[0], tdescricao);
	} else if (tipos.includes( "text/uri-list")) { //drop link url- no chrome
		var item = ev.dataTransfer.getData("text/uri-list"); //aqui só tem url, não tem título da página como no firefox
		menu_ligar_novo('LI_' + item, '');
	} else if (tipos.includes("text/plain")) {
		var data = ev.dataTransfer.getData("text");
		if (ev.shiftKey) {
		   
		} else {
			inserir_lista(data);
		}
	} else if (tipos.includes("Files")) {
		menu_importarJsonArquivo(ev, 'drop');
	} else {
		alertify.error('Drop. Tipo não reconhecido');
		console.log(tipos);
		return;
	}
} //.function drop_handler

function ajustaRegiaoDrop() {
	//var dropzoneId = "drop_area"; //"div_botoes"; //só esta região vai aceitar drop
	var dropzones = ['drop_area', 'principal_svg'];
	window.addEventListener("dragenter", function(e) {
		//console.log(e.target.id);
		//if (e.target.id != dropzoneId) {
		if (!dropzones.includes(e.target.id)) {
			e.preventDefault();
			e.dataTransfer.effectAllowed = "none";
			e.dataTransfer.dropEffect = "none";
		}
	}, false);

	window.addEventListener("dragover", function(e) {
		//if (e.target.id != dropzoneId) {
		if (!dropzones.includes(e.target.id)) {
			e.preventDefault();
			e.dataTransfer.effectAllowed = "none";
			e.dataTransfer.dropEffect = "none";
		}
	});

	window.addEventListener("drop", function(e) {
		//if (e.target.id != dropzoneId) {
		if (!dropzones.includes(e.target.id)) {
			e.preventDefault();
			e.dataTransfer.effectAllowed = "none";
			e.dataTransfer.dropEffect = "none";
		}
	});
} //.function ajustaRegiaoDrop

function drag_handler(ev) {
	ev.dataTransfer.setData("rede_json", JSON.stringify(getRedeNosLigacoes(true, null, true))); //terceiro parametro true=bsemposicao
	var texto = [...gparam.idNosSelecionados].join('\n');
	ev.dataTransfer.setData("text/plain", texto);
	
	var linksArray = [];
	for (let item of gparam.idNosSelecionados) {
		if (item.startsWith('LI_')) { 
			linksArray.push(item.substr(3));
		}
	}
	if (linksArray.length>0) {
		ev.dataTransfer.setData("text/x-moz-url", linksArray.join('\n'));
		ev.dataTransfer.setData("text/uri-list", linksArray.join('\n'));	
	} else {
		ev.dataTransfer.setData("text/uri-list", base + 'grafico/1/'+ texto.replaceAll('\n', ';')); //arrastando para uma outra aba que não seja da redecnpj, abre o gráfico dos itens selecionados
	}
	return;
	/*
	if (gparam.idnoSelecionado.startsWith('LI_')) { 
		texto = gparam.idnoSelecionado.substr(3);
		ev.dataTransfer.setData("text/x-moz-url", texto);
		ev.dataTransfer.setData("text/uri-list", texto);
	} else {
		ev.dataTransfer.setData("text/uri-list", base + 'grafico/1/'+ texto.replaceAll('\n', ';')); //arrastando para uma outra aba que não seja da redecnpj, abre o gráfico dos itens selecionados
	} 
	*/
} //.function drag_handler

function ativaAtalhos(bcaptura) {
	// é preciso desativar antes de usar o alertify.prompt
	if (gparam.mobile) {
		return;
	}
	if (bcaptura) {
		document.onkeydown = evento_teclasDown;
	} else {
		document.onkeydown = null;
	}
} //.function ativaAtalhos

function evento_teclasDown(e) {
	function testa(keyIn, pressShift, pressCtrl) {
		//não dá para usar alt key, porque isso abre o menu do navegador
		if (keyIn!=e.code) {
			return false;
		} else if (pressShift!=e.shiftKey) {
			return false;
		} else if (pressCtrl!=e.ctrlKey) {
			return false;
		} 
		return true;
	}
	if ((e.code.startsWith('Digit') && (e.code.length==6)) || (e.code.startsWith('Numpad') && (e.code.length==7) && (e.getModifierState('NumLock')))){
		var ns = e.code.substr(-1);
		var tipo = 'cnpj';
		if (e.shiftKey && !e.ctrlKey) {
			tipo = 'links';
		//} else if (!e.shiftKey && e.ctrlKey) {
		} else if (e.ctrlKey) {
				tipo = 'caminhos';	
		}
		if (('0' <= ns) && (ns <='9')) {
			if (ns=='0') {
				ns='10';
				//observação: javascript não aceita SHIFT+TeclaKeypd como atalho, também não aceita CTRL+SHIFT+0
				//menu_incluirCamada('', 10, tipo);
			} 
			var camadaInsercao = parseInt(ns);
			if ((camadaInsercao==1)&&(tipo=='cnpj')) {
				menu_incluir1Camada('');
			} else {
				if (tipo=='caminhos') {
					menu_caminhos(camadaInsercao, '', e.shiftKey);
				} else {
					menu_incluirCamada('', camadaInsercao, tipo);
				}
			}
			e.preventDefault();
			return;
		}
	} else if (testa('KeyZ', false, true)) { 
		menu_inserirDesfazer();
	} else if (testa('KeyJ', false, false)) { 
		menu_localiza_adjacentes();
	} else if (testa('KeyJ', true, false)) { 
		menu_localiza_componente();
	} else if (testa('KeyJ', false, true)) { 
		menu_localiza_itensComMaisLigacoes();
	} else if (testa('KeyI', false, false)) { 
		try { //ler do clipboard, funciona só no chrome, firefox dá erro (precisa configurar algo)
			navigator.clipboard
			.readText()
			.then((clipText) => {menu_inserir(clipText);})
		} 
		catch(err){
			menu_inserir();
		};
	} else if (testa('KeyU', false, false)) { 
		menu_ligar_novo('', '', true); //novo item sem ligação com selecionados
	} else if (testa('KeyU', true, false)) { 
		menu_ligar_novo('', '', false); //novo item com ligacao com selecionados
	} else if (testa('KeyU', false, true)) { 
		menu_ligar_novo('', '', false, true); //novo item com ligacao entre selecionados
	} else if (testa('KeyD', false, false)) { 
		menu_dados(false, gparam.idNoOnHover);
	} else if (testa('KeyD', true, false)) { 
		menu_dados(true, null);
	} else if (testa('KeyD', false, true)) { 
		menu_listaSelecao(true);
	} else if (testa('KeyA', false, false)) { 
		menu_abrirNovaAba(null, true);
	} else if (testa('KeyA', true, false)) { 
		menu_abrirNovaAba(null);
	} else if (testa('KeyA', false, true)) { 
		menu_selecionarTudo();
	} else if (testa('KeyA', true, true)) { 
		menu_selecionarInverte();
	} else if (testa('KeyQ', false, false)) {
		menu_quebraGraficoEmPartes();
	} else if (testa('KeyE', false, false)) { 
		menu_editar_no();	} 
	else if (testa('KeyB', false, false)) { 
		menu_abreBuscasEmSites();
	} else if (testa('KeyG', false, false)) { 
		menu_buscaEmSite('https://www.google.com/search?q=', 'N');
	} else if (testa('KeyG', true, false)) { 
		menu_GoogleMaps(true);;
	} else if (testa('KeyG', false, true)) { 
		menu_buscaEmSite('https://www.google.com/search?q=', 'S');
		//menu_links_google(false);
	} else if (testa('KeyH', false, false)) { 
		menu_links_google(false);
	} else if (testa('KeyH', true, false)) { 
		menu_links_google(true);
	} else if (testa('KeyN', false, false)) { 
		menu_rotulosCompletos(null);
	} else if (testa('KeyN', true, false)) { 
		menu_ligacoesExibe(null);
	} else if (testa('KeyF', false, false)) { 
		menu_localiza(false);
	} else if (testa('KeyF', true, false)) { 
		menu_localiza(true);
	} else if (testa('KeyF', false, true)) { 
		menu_localizaPorCampo(false);
	} else if (testa('KeyL', false, false)) { 
		menu_ligar_selecionados(true);
	} else if (testa('KeyL', true, false)) { 
		menu_desligar_selecionados(false);
	} else if (testa('KeyK', false, false)) { 
		menu_ligar_selecionados(false);
	} else if (testa('Delete', false, false)) { 
		menu_excluirNosSelecionados();
	} else if (testa('Delete', true, false)) { 
		menu_excluirTudo();
	} else if (testa('Delete', false, true)) { 
		removeIsolados(true);
	} else if (testa('Backspace', true, false)) { 
		excluirNoMantendoLinks();
	} else if (testa('KeyP', false, false)) { 
		menu_pinarNo(null);
	} else if (testa('KeyP', true, false)) { 
		menu_pinarDesfazerTudo();
	} else if (testa('KeyP', false, true)) { 
		menu_pinarUmNoEmCadaGrupo();		
	} else if (testa('KeyC', false, false)) { 
		menu_colorir();
	} else if (testa('KeyC', true, false)) { 
		menu_colorir('transparent');
	} else if (testa('KeyC', false, true)) { 
		menu_copiaClip();
	} else if (testa('KeyV', false, true)) { 
		menu_colaClip();
	} else if (testa('Space', false, false)) { 
		menu_rendererAtivarParar(!gparam.bRenderAtivado, true);
	} else if (testa('ArrowLeft', false, false)) { 
		menu_teclaLeft(false);
	} else if (testa('ArrowRight', false, false)) { 
		menu_teclaRight(false);	
	} else if (testa('ArrowUp', false, false)) { 
		menu_teclaUp(false);
	} else if (testa('ArrowDown', false, false)) { 
		menu_teclaDown(false);	
	} else if (testa('KeyO', false, false)) { 
		menu_exportaJSONServidorParaBaseLocal(true, '', 'operacao' );	
	} else {
		return;
	} 
	e.preventDefault();
} //.function evento_teclasDown

alertifyfake = {
	'prompt':function(titulo, texto, valor, func1, func2) {
		menuOnClick(); //firefox no android, não está fechando o menu
		var resp = 	prompt(titulo+'\n'+texto.replaceAll('<b>','').replaceAll('</b>',''), valor);
		if (!(resp===null)) {
			func1(null, resp);
		} else {
			func2();
		};
	},
	'confirm':function(titulo, texto, func1,func2) {
		menuOnClick();
		var resp = confirm(titulo + '\n' + texto);
		if (resp) {
			func1();
		} else {
			func2();
		}
	},
	'alert':function(titulo, texto, func) {
		menuOnClick();
		//texto = texto.replace(/<b>/g, '').replace(/<\/b>/g, '').replace(/<br>/g, '; ')
		texto = texto.replace(/<b>/g, '').replace(/<\/b>/g, '').replace(/<br>/g, '\n')
		setTimeout(function(){ alert(titulo + '\n\n' + texto);}, 500);	
		func();
	},
	'success':function(texto) {
		menuOnClick();
		setTimeout(function(){ alert(texto);}, 500);
	},
	'warning':function(texto) {
		menuOnClick();
		setTimeout(function(){ alert('ATENÇÃO!!! ' + texto); }, 500);
	},
	'error':function(texto) {
		menuOnClick();
		setTimeout(function(){ alert('ERRO!!! ' + texto); }, 500);
	}
} //.alertifyfake

function ajustaAmbiente_adicionarListaIconesAoMenu() {
	//var menuIcone = document.getElementById('menu_selecao_icone');
	var menuIconeOptions = document.getElementById('menu_selecao_icone_options');
	for (item of gparam.listaImagens) {
		/*
		var itemMenu = document.createElement('li');
		itemMenu.innerHTML = '\
			<button type="button" class="menu-btn" onclick="menu_alteraIcone('+item+');"> \
			<i class="fa fa-tags"></i><span class="menu-text">' + item + '</span> \
			</button>	'	
		itemMenu.setAttribute('class', "menu-item"); */
		var itemOption = document.createElement('option');
        //itemOption.onchange = 'menu_alteraIcone("' + item + '");';
		itemOption.text = item;
		itemOption.value = item;
		menuIconeOptions.appendChild(itemOption);
	}
} //.function ajustaAmbiente_adicionarListaIconesAoMenu

function ajustaAmbiente() {
	menu = document.querySelector('.menu');
	if (gparam.mobile) { 
	//if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){ //mobile
		//alert('Esta página pode não funcionar corretamente no celular ou tablet... Se der erro, abra um issue na página do projeto no github. Tente em um computador com o Firefox, Chrome ou Edge.');
		//mobile. gambiarra, o alertify não funciona no ipad, no android fica muito pequeno
		alertify.set('notifier','position', 'top-left'); //se fica de lado, os alertas não aparecem no mobile
		//gparam.mobile = true;
		gparam.inserirDefault = ''; //'TESTE'; //como é dificil digitar no mobile, coloca um valor padrão
		alertify.prompt = alertifyfake.prompt;
		//alertify.confirm = alertifyfake.confirm; //confirm é usado para informar parametros em dlgLink, por isso não pode sobrepor
		alertify.alert = alertifyfake.alert; 
		alertify.warning = alertifyfake.warning;
		if (/Android/i.test(navigator.userAgent)) { //android

		} else 	{ //safari antigo (parou de funcionar). Safari novo no ipad = versão desktop
			gparam.safari = true;
			//safari, trocar onclick por ontouchend nos botoes
    		var botoes = document.getElementsByClassName('botaosuperior');
    		for (var i=0; i<botoes.length; i++) { //ipad antigo não aceita let
    			botoes[i].ontouchend=botoes[i].onclick;
    		} 
			gparam.eventclick = 'touchend';
    		document.querySelectorAll('.menu-btn').forEach( function(element,key) {element.ontouchend = element.onclick;});
		} 
	} else { //desktop
		try {
			document.getElementById('div_referencia').textContent=gparam.inicio.referenciaBDCurto; //\xa0 espaço não separável
		} catch (e) {;}
		document.addEventListener('contextmenu', onContextMenu, false); //menu contextual em toda a tela
		ajustaAmbiente_adicionarListaIconesAoMenu();
		try {
			document.getElementById('input_cnpj').value = gparam.inserirDefault;
		} catch (e) {;};		
	}

} //.function ajustaAmbiente

function main() {
	ajustaAmbiente();
	gparam.layout = Viva.Graph.Layout.forceDirected(graph, {
		   springLength : gparam.springLength, //170, //140, //80,
		   springCoeff : 0.0002, //0.0002,
		   dragCoeff : 0.02, 
		   gravity : -1.0, //-1.2, 
		   theta : 0.8
	});
	gparam.renderer = Viva.Graph.View.renderer(graph, {
			graphics : graphics,
			layout: gparam.layout,
			container  : document.getElementById('principal')
		});
	gparam.renderer.run();
	gparam.geom = Viva.Graph.geom();
	if (!gparam.mobile) {
		//Ajusta região para drag and drop de arquivo ou do excel
		ajustaRegiaoDrop();
		gparam.AreaSelecaoRetangular.Setup();
		ativaAtalhos(true);
	}
	if (gparam.inicio.cpfcnpj) {
		menu_incluirCamada(gparam.inicio.cpfcnpj, gparam.inicio.camada, null, true);
	} else if (gparam.inicio.idArquivoServidor ) {
		menu_importaJSONServidor(gparam.inicio.idArquivoServidor, true);
	} else if (gparam.inicio.lista) {
		inserir_lista(gparam.inicio.lista, true);
	} else if (gparam.inicio.json) {
		inserirJson(gparam.inicio.json, 'Json informado. ', true);
	} else {
		const urlParams = new URLSearchParams(window.location.search);
		//if (urlParams.get('pula_mensagem')!='sim') {
			if (gparam.inicio.mensagem) {
				var horaAbrePopup = localStorage.getItem( 'horaAbrePopup' );
				if (!horaAbrePopup || !(horaAbrePopup>new Date())) {
					if (gparam.mobile) {
						alert('Esta página pode não funcionar corretamente no celular ou tablet... Se der erro, abra um issue na página do projeto no github. Tente em um computador com o Firefox, Chrome ou Edge.\n\n' + gparam.inicio.mensagem);
					} else {
						alert(gparam.inicio.mensagem);
					}
					var expira = new Date();
					localStorage.setItem( 'horaAbrePopup', expira.setHours(expira.getHours() + 20)); //exibe de novo em 20 horas
				}
			}
		// }
		if (gparam.inicio.bMenuInserirInicial && !window.opener) { //se for aberta por outra aba, não abre opção de inserir
			menu_inserir();
		}
	}
	
} //.main()

</script>

<style type="text/css" media="screen"> 
	* {
	font-family: 'Quicksand', sans-serif;
	}
	html, body, svg { width: 100%; height: 100%;
	/* para acertar texto dos botoes no safari */
	-ms-text-size-adjust: 200%;
	-webkit-text-size-adjust: 200%;
	
	}
	.graph-overlay {
	  position: absolute;
	  left: 0;
	  top: 0;
	  width: 100%;
	  height: 100%;
	  display: none;
	}
	.graph-selection-indicator {
	  position: absolute;
	  left: 0;
	  top: 0;
	  background: transparent;
	  border: dashed orange;
	}
#drop_area {
  border: 2px dashed #ccc;
  border-radius: 20px;
}
#drop_area.highlight {
  border-color: purple;
}
#drop_area:hover {
  background: #ddd;
}
#block_container {
    display: flex;
    justify-content: left;
}

{% if parametros.mobile %}
	.menu {
		width:300px;
	}
	{% if parametros.chrome %}
		.botaosuperior {
			margin-right:10px; 
			margin-bottom:10px; 
			border-radius:5px; 
			/* font-size:30px; */
			width: fit-content;
		} 
		.menu-btn {
			font-size:12px;
		}
		.menu-text {
			margin-left:50px;
			font-size:10px;
		} 
		.alertify-notifier .ajs-message.ajs-success{
			  color: black;
			  font-size: 8px;
		}
	{% else %}
		.botaosuperior {
				margin-right:10px; 
				margin-bottom:10px; 
				border-radius:5px; 
				font-size:30px;
				width: fit-content;
			} 
		.menu-btn {
			font-size:14px;
		}
		.menu-text {
			margin-left:50px;
			font-size:14px;
		} 	
		.alertify-notifier .ajs-message.ajs-success{
			  color: black;
			  font-size: 14px;
		}
	{% endif %}
	
	.menu .menu { /* submenu não ficar à direita */
	  position: fixed;
	  top: 4px;
	  left: 4px;
	}
	
{% endif %}

</style>
</head>

<body id='corpo' onload='main()' style='overflow:hidden; '>
<!-- overflow:hidden para não aparecer barra de rolagem -->
<!--div id="block_container"-->
	<div id='div_botoes'>
		<button class='botaosuperior' id='btn_menu' type="button" onclick="javascript:menu_botao(event);" title='Abre Menu com opções'><i class="fa fa-bars"></i></button> <!-- tirei o texto Menu -->
		<button class='botaosuperior' id='btn_menu' type="button" onclick="window.open(base+'grafico_no_servidor/rede_cnpj_diagrama.json');" title='Abre diagrama clicável com orientações e vídeos de uso da ferramenta.'>
			{% if parametros.mobile %}
				<img src="/static/imagem/favicon.ico" alt="MapRoad"/>
			{% else %}
				<img src="/static/imagem/favicon.ico" alt="MapRoad" class='botaosuperior' width="12" height="12"/> 
			{% endif %}
		</button>
		
		{% if not parametros.mobile %}
			<button class='botaosuperior' id='btn_github' type="button" onclick="window.open('https://github.com/rictom/rede-cnpj/')"  title='Clique para abrir o código original no Github. ATENÇÃO: o projeto é open source.'>
				<b>RedeCNPJ no Github</b>
			</button>
			
		{% endif %}
		{% if parametros.bBaseReceita %}
			{% if not parametros.mobile %}
				<button class='botaosuperior' id='btn_srf' type="button" onclick="window.open('https://dados.gov.br/dados/conjuntos-dados/cadastro-nacional-da-pessoa-juridica---cnpj')" title='Clique para abrir a página de dados abertos de CNPJ da Receita Federal do Brasil'><b>Dados Abertos</b></button>
			{% endif %}
		{% endif %}
		{% if not parametros.mobile %}	
			<button id='div_referencia' title="{{ parametros.referenciaBD }}" disabled><b>Referência</b></button>
			<button class='botaosuperior' type="button" onclick="javascript:menu_rendererAtivarParar(true, true);" title='Ativar Leiaute (Barra de Espaço)'><i class="fa fa-play"></i></button>
			<button class='botaosuperior' type="button" onclick="javascript:menu_rendererAtivarParar(false, true);" title='Parar Leiaute (Barra de Espaço)'><i class="fa fa-stop"></i></button>
		{% endif %}
		<button class='botaosuperior' type="button" onclick="javascript:menu_zoomin(event.shiftKey, event.ctrlKey);" title='Aumenta visualização. A roda do mouse também faz isso. Pressionando SHIFT+click aumenta apenas o tamanho das ligações.'><i class="fa fa-search-plus"></i></button>
		{% if not parametros.mobile %}
			<button class='botaosuperior' type="button" onclick="javascript:menu_zoomout(event.shiftKey, event.ctrlKey);" title='Diminui visualização.  A roda do mouse também faz isso. Pressionando SHIFT+click diminui apenas o tamanho das ligações.'><i class="fa fa-search-minus"></i></button>
		{% endif %}
		<button class='botaosuperior' type="button" onclick="gparam.renderer.reset();" title='Reinicia escala de visualização'><i class="fa fa-compress"></i></button>

		{% if not parametros.mobile %}
			<input type="text" id="input_cnpj" name="input_cnpj" size="18" value='' onkeydown='menu_input_cnpj(this)' 
				onfocusin="ativaAtalhos(false)" onfocusout="ativaAtalhos(true);" onClick="this.select();"
				title='Digite {% if parametros.bBaseReceita %} CNPJ, Razão Social, Nome Fantasia, CPF de sócio ou Nome de sócio {% endif %}e pressione Enter. Os nomes podem ter acentuação ou estar com letras minúsculas, pois o texto é convertido em maiúsculas sem acentuação. CNPJS e CPFs podem ter pontos, traços ou barras. Para buscar por Unidade Gestora, coloque UG_NNNNNN, onde NNNNNN é o código da UG. A busca por endereço, por telefone ou por email ainda não foi implementada.'>
		{% endif %}
		<button class='botaosuperior' type="button" onclick="javascript:menu_inserir(null, event.shiftKey, event.ctrlKey);" title='Inserir{% if parametros.bBaseReceita %} CNPJ ou CPF do Banco de Dados {% endif %}(Tecla I)'><i class="fa fa-user-plus"></i></button>
		<button class='botaosuperior' type="button" onclick="javascript:menu_dados(event.shiftKey);" title='Exibir Dados do Item (D). SHIFT+Click ou SHIFT+D abre os dados de CNPJ em nova aba.'><i class="fa fa-newspaper"></i></button>

		{% if not parametros.mobile %}
			<button class='botaosuperior' type="button" onclick="javascript:menu_incluir1Camada('');" title='Expande Vínculos Societários em Camada 1 (Tecla 1)'><i class="fa fa-layer-group"></i></button>
			<button class='botaosuperior' type="button" onclick="javascript:menu_botao_caminhos('');" title='Procura caminhos entre itens selecionados no gráfico'>
				<img src="/static/imagem/code-fork.png" alt="caminhos" class='botaosuperior' width="12" height="12"/>
			</button>

			<button class='botaosuperior' type="button" onclick="javascript:menu_botaoAbre(event.shiftKey)" title="Adiciona última visualização salva no navegador com o botão ao lado. Pressionando SHIFT pode se escolher o nome do conjunto." ><i class="fa fa-folder-open"></i></button>
			<button class='botaosuperior' type="button" onclick="javascript:menu_botaoSalva(event.shiftKey)" title="Salva a visualização atual no navegador. Pressionando SHIFT pode se definir nome do conjunto." ><i class="fa fa-save"></i></button>
			<button class='botaosuperior' type="button" onclick="javascript:menu_exportaExcel(false)" title="Salva arquivo Excel com dados dos itens da tela" ><i class="fa fa-file-excel"></i></button>
			<button class='botaosuperior' type="button" onclick="javascript:menu_exportaArquivo(false, 'osm');" title='Abre endereços de cnpjs com OpenStreetMap'><i class="fa fa-globe"></i></button>

			<!--button id="drop_area"  ondrop="drop_handler(event);" ondragover="dragover_handler(event);"  title="Arraste para esta tela uma coluna de CNPJs, um arquivo tipo json ou o botão DRAG de outra aba" disabled>DROP</button> -->
			<button class='botaosuperior' onclick="javascript:menu_colaClip();"  title="(CTRL+V) COLA itens da Área de Transferência da RedeCNPJ de outra aba"><i class="fa fa-paste"></i></button>
			<button id="drag_area"  ondragstart="drag_handler(event);" draggable="true" onclick="javascript:menu_copiaClip();" ondblclick="javascript:menu_copiaItensParaOutraAba(event.shiftKey, true);" title="COPY: CLICK SIMPLES para copiar para a Área de Transferência da RedeCNPJ (CTRL+C), para ser colada em outra aba. Dê CLICK DUPLO para COPIAR os itens selecionados para NOVA ABA já aberta por SHIFT+DUPLO CLICK, tecla A ou SHIFT+A; SHIFT+DUPLO CLICK copia os itens para uma NOVA ABA; DRAG: Arraste este botão para outra Aba de Rede para copiar os itens selecionados."><b>COPY/DRAG</b><!-- drag_area--> <!--i class="fa fa-hand-holding-water"></i--></button>
		{% endif %}
	</div>

<div id="principal" style="width: 100%; height: 100%; position: absolute; " charset="utf-8" ondrop="drop_handler(event);" ondragover="dragover_handler(event);"  > 
<!-- top=0 desativa botoes-->
	<div id="principal_overlay" class="graph-overlay" style="cursor:crosshair;" ></div>
</div>

<menu id='menu_contexto' class="menu">  <!-- style="overflow: hidden;" overflow: hidden parece resolver quebra da linha de menu no android, mas não deixa submenu aparecer-->
	<li class="menu-item submenu">
		<button type="button" class="menu-btn" title="Expande vinculos de sócios. Aperte a tecla 1-9 para ativar estas opções"> <i class="fa fa-layer-group"></i> <span class="menu-text">Incluir Camadas</span> </button>
		<menu class="menu">
			<li class="menu-item">
				<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('',1);" title="Expande vinculos de sócios. Aperte a tecla 1 para ativar esta opção, ou faça clique duplo no ícone.">
				<i class="fa fa-layer-group"></i><span class="menu-text">1 (Tecla 1)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 2);" title="Expande vinculos de sócios em 2 níveis. Aperte a tecla 2"><i class="fa fa-layer-group"></i><span class="menu-text">2 (Tecla 2)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 3);" title="Expande vinculos de sócios em 3 níveis. Aperte a tecla 3"><i class="fa fa-layer-group"></i><span class="menu-text">3 (Tecla 3)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 4);" title="Expande vinculos de sócios em 4 níveis. Aperte a tecla 4"><i class="fa fa-layer-group"></i><span class="menu-text">4 (Tecla 4)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 5);" title="Expande vinculos de sócios em 5 níveis. Aperte a tecla 5"><i class="fa fa-layer-group"></i><span class="menu-text">5 (Tecla 5)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 6);" title="Expande vinculos de sócios em 6 níveis. Aperte a tecla 6"><i class="fa fa-layer-group"></i><span class="menu-text">6 (Tecla 6)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 7);" title="Expande vinculos de sócios em 7 níveis. Aperte a tecla 7"><i class="fa fa-layer-group"></i><span class="menu-text">7 (Tecla 7)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 8);" title="Expande vinculos de sócios em 8 níveis. Aperte a tecla 8"><i class="fa fa-layer-group"></i><span class="menu-text">8 (Tecla 8)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 9);" title="Expande vinculos de sócios em 9 níveis. Aperte a tecla 9"><i class="fa fa-layer-group"></i><span class="menu-text">9 (Tecla 9)</span> </button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 10);" title="Expande vinculos de sócios em 10 níveis. Aperte a tecla 0"><i class="fa fa-layer-group"></i><span class="menu-text">10 (Tecla 0)</span> </button>
			</li>
		</menu>
	</li>
	<li class="menu-item">
	<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_incluirCamada('', 1,'links');"> <i class="fa fa-layer-group"></i>
	<span class="menu-text" title="Inclui outros vínculos na tabela links (ver documentação no github)">Incluir outras Ligacões (SHIFT+1)</span> </button>
	</li>
	<li class="menu-item">
	<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_inserir();" title="Inserir Item no gráfico com informações do Banco de Dados"> 
	<i class="fa fa-user-plus"></i> <span class="menu-text">Inserir {% if parametros.bBaseReceita %}CNPJ ou CPF {% endif %}(I)...</span> 
	</button>
	</li>
	<li class="menu-item">
	<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_inserirDesfazer();" title="Desfaz última inserção de itens"> 
	<i class="fa fa-undo"></i> <span class="menu-text">Desfazer Inserção (Ctrl+Z)</span> 
	</button>
	</li>
	<li class="menu-item submenu">
	<button type="button" class="menu-btn"><i class="fa fa-eye"></i><span class="menu-text">Visualização</span></button>
	<menu class="menu">
		<li class="menu-item submenu">
		<button type="button" class="menu-btn"><i class="fa fa-thumbtack"></i><span class="menu-text">Fixar</span></button>
		<menu class="menu">		
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_pinarNo(null);" title="Fixa/Desfixa nó na posição do gráfico, não sendo afetado pelo arrastamento de outros nós"> 
			<i class="fa fa-thumbtack"></i> <span class="menu-text">Nós Selecionados (P)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_pinarDesfazerTudo();" title="Deixa todos os nós desafixados"> 
			<i class="fa fa-thumbtack"></i> <span class="menu-text">Desfixar Todos (SHIFT+P)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_pinarUmNoEmCadaGrupo();" title="Fixa pelo menos um nó em cada Grupo"> 
			<i class="fa fa-thumbtack"></i> <span class="menu-text">Fixar nos Grupos (CTRL+P)</span> 
			</button>
			</li>	
		</menu>
		</li>			
		<li class="menu-item submenu">
		<button type="button" class="menu-btn"><i class="fa fa-tags"></i><span class="menu-text">Rótulos</span> </button>
		<menu class="menu">
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_editar_no();"> 
			<i class="fa fa-sticky-note"></i><span class="menu-text">Editar Rótulos (E)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_editarNota(gparam.idnoSelecionado);"> 
			<i class="fa fa-sticky-note"></i><span class="menu-text">Editar Nota</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_rotulosCompletos(true);"> 
			<i class="fa fa-tags"></i><span class="menu-text">Nome Completo</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_rotulosCompletos(false);"> 
			<i class="fa fa-tag"></i><span class="menu-text">Só Primeiro Nome</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_rotulosPosicao(false);"> 
			<i class="fa fa-tag"></i><span class="menu-text">Do lado do ícone</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_rotulosPosicao(true);"> 
			<i class="fa fa-tag"></i><span class="menu-text">Embaixo do ìcone</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_embaralhaTexto();" title='Embaralha texto dos novos itens do gráfico, para dificultar identificação por nome'> 
			<i class="fa fa-tag"></i><span class="menu-text">Embaralha texto</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); menu_ligacoesExibe(null);"> 
			<i class="fa fa-tag"></i><span class="menu-text">Exibe/Oculta de Ligação (SHIFT+N)</span> 
			</button>
			</li>			
		</menu>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_copiaItensParaOutraAba(event.shiftKey, true);";" title="Copia itens selecionados para nova aba filha."> 
		<i class="fa fa-copy"></i> <span class="menu-text">Copia Itens para Aba Filha</span> </button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaArquivo(false, 'osm');" title="Abre OpenStreetMap. Se houver muitos itens, será apontado somente os municípios dos cnpjs."> 
		<i class="fa fa-globe"></i> <span class="menu-text">Abre Mapa</span> </button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_abrirNovaAba(null, true)" title="Abre itens selecionados em nova aba"> 
		<i class="fa fa-external-link-alt"></i> <span class="menu-text">Gráfico em nova aba (A)</span> </button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_quebraGraficoEmPartes()" title="Divide o gráfico em partes menores exibindo em outras abas."> 
		<i class="fa fa-external-link-alt"></i> <span class="menu-text">Quebrar o gráfico em abas (Q)</span> </button>
		</li>
		<li class="menu-item">
			<button type="button" class="menu-btn" onchange="menuOnClick(); javascript:menu_alterarIcone();">
			<i class="fa fa-tags"></i><span class="menu-text">Alterar Ícone &nbsp;&nbsp;</span>
			<select id="menu_selecao_icone_options" class="dropdown" style='max-width:100px'>
                <option value="0">Selecione</option>
			</select>
			</button>
		</li>
		<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_faviconNosItens(null);">
			<i class="fa fa-tags"></i><span class="menu-text">Alterar Ícone para Imagem/Favicon</span>
			</button>
		</li>
		
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_colorir();"> 
		<i class="fa fa-fill-drip"></i><span class="menu-text">Colorir (C)</span>
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick();"> 
		<i class="fa fa-palette"></i><span class="menu-text">Escolher Cor:</span> <input type="color" id="palheta" title="Selecione uma cor" value="#FF0000" />
		</button>
		</li>

		<li class="menu-item">
		<button id='botaoDadosBasicos' type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_dados(false)" title="Exibe dados em popup">
		<i class="fa fa-newspaper"></i><span class="menu-text">Dados (D)</span> </button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_dados(true)" title="Exibe Dados em nova Janela do navegador">
		<i class="fa fa-newspaper"></i><span class="menu-text">Dados em Janela (Shift+D)</span></button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_dados(true)" title="Exibe Dados em nova Janela do navegador">
		<i class="fa fa-newspaper"></i><span class="menu-text">Lista dados da seleção (Ctrl+D)</span></button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_nomeAba()" title="Altera nome da Aba">
		<i class="fa fa-tags"></i><span class="menu-text">Nome da Aba</span></button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); gparam.renderer.reset();" title="Reinicia escala"> 
		<i class="fa fa-compress"></i> <span class="menu-text">Escala Inicial</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_rendererAtivarParar(false, true);"> 
		<i class="fa fa-stop"></i> <span class="menu-text">Leiaute: Parar (Espaço)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_rendererAtivarParar(true, true);"> 
		<i class="fa fa-play"></i> <span class="menu-text">Leiaute: Continuar (Espaço)</span> 
		</button>
		</li>  
	</menu>
	</li>
	<li class="menu-item submenu">
	<button type="button" class="menu-btn" ><i class="fa fa-search"></i><span class="menu-text">Filtrar/Localizar</span></button>
	<menu class="menu">
		<li class="menu-item submenu">
		<button type="button" class="menu-btn" title="Abre aba com busca em sites"> <i class="fa fa-users"></i> <span class="menu-text">Busca em sites</span> </button>
		<menu class="menu">
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_abreBuscasEmSites();" title="Abre abas com busca no google, bing e outros sites deste menu"> 
			<i class="fa fa-search"></i><span class="menu-text">Abre Buscas em Abas (B)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://www.escavador.com/busca?q=');"> 
			<i class="fa fa-balance-scale"></i><span class="menu-text">Escavador</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://www.jusbrasil.com.br/busca?q=');"> 
			<i class="fa fa-balance-scale"></i><span class="menu-text">Jusbrasil</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('http://portaldatransparencia.gov.br/busca?termo=');"> 
			<i class="fa fa-search"></i><span class="menu-text">Portal Transparência</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://www.reclameaqui.com.br/busca/?q=', null, true);"> 
			<i class="fa fa-search"></i><span class="menu-text">Reclame Aqui</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://www.bing.com/search?q=');"> 
			<i class="fa fa-search"></i><span class="menu-text">Bing</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://duckduckgo.com/?q=');"> 
			<i class="fa fa-search"></i><span class="menu-text">DuckDuckGo</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://www.linkedin.com/search/results/all/?keywords=');"> 
			<i class="fa fa-search"></i><span class="menu-text">Linkedin</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://www.google.com/search?q=', 'N');" title='Abre uma aba do Google com busca pelo item'> 
			<i class="fab fa-google"></i><span class="menu-text">Google (G)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_buscaEmSite('https://www.google.com/search?q=', 'S');" title='Abre uma aba do Google pelo item e adiciona um parâmetro (termo) para busca'> 
			<i class="fab fa-google"></i><span class="menu-text">Google + Parâmetro (CTRL+G)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_GoogleMaps(true);" title='Abre o Google Maps no endereço do CNPJ'> 
			<i class="fab fa-google"></i><span class="menu-text">Google Maps (SHIFT+G)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_links_google(false);" title='Adiciona um ícone com link para página de busca do Google e para os links desta busca'> 
			<i class="fab fa-google"></i><span class="menu-text">Google Links (H)</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_links_google(true);" title='Adiciona um ícone com link para página de busca do Google e busca palavras chaves nos links'> 
			<i class="fab fa-google"></i><span class="menu-text">Google e Palavras Chave (SHIFT+H)</span> 
			</button>
			</li>
		</menu>
		</li>
		
		<li class="menu-item submenu">
			<button type="button" class="menu-btn" title="Opções com texto de Notas"> <i class="fa fa-search"></i> <span class="menu-text">Notas/Caminhos</span> </button>
			<menu class="menu">
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_itensComNotas(true);" title="Selecione itens com anotações."> 
			<i class="fa fa-sticky-note"></i><span class="menu-text">Seleciona itens com Nota</span> 
			</button>
			</li>	
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_CaminhosEntreitensComNotas('');" title="Seleciona caminhos entre os itens com qualquer texto de Nota."> 
			<i class="fa fa-search"></i><span class="menu-text">Caminhos entre Itens</span> 
			</button>
			</li>	
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_CaminhosEntreitensComNotas('intra');" title="Seleciona caminhos entre os itens com textos iguais de Nota."> 
			<i class="fa fa-search"></i><span class="menu-text">Caminhos entre Notas Iguais</span> 
			</button>
			</li>	
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_CaminhosEntreitensComNotas('extra');" title="Selecione caminhos entre os itens com textos diferentes de Nota."> 
			<i class="fa fa-search"></i><span class="menu-text">Caminhos entre Notas Diferentes</span> 
			</button>
			</li>	
		</menu>
		</li>		
		
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza(false);" title="Procura por palavra nos itens exibidos do gráfico"> 
		<i class="fa fa-search"></i><span class="menu-text">Localizar (F) ...</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza(true);" title="Procura por palavra nos itens selecionados do gráfico "> 
		<i class="fa fa-search"></i><span class="menu-text">Filtra na Seleção (SHIFT+F) ...</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localizaPorCampo(false);" title="Procura por campo nos itens do gráfico"> 
		<i class="fa fa-search"></i><span class="menu-text">Localizar Por Campo (CTRL+F) ...</span> 
		</button>
		</li>		
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_adjacentes();" title="Adiciona itens com ligação aos selecionados."> 
		<i class="fa fa-search"></i><span class="menu-text">Adjacentes (J)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_componente();" title="Adiciona itens conexos (árvore) aos selecionados."> 
		<i class="fa fa-search"></i><span class="menu-text">Conexos (SHIFT+J)</span> 
		</button>
		</li>		
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_itensComMaisLigacoes();" title="Seleciona itens com mais Ligações."> 
		<i class="fa fa-search"></i><span class="menu-text">Itens com mais ligações (CTRL+J) ...</span> 
		</button>
		</li>	
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_localiza_itensLigadosAColoridos();" title="Selecione itens ligados a outros itens marcados com cores."> 
		<i class="fa fa-search"></i><span class="menu-text">Itens ligados a coloridos ...</span> 
		</button>
		</li>	

		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_selecionaGruposColoridos(false);" title="Seleciona grupos que tenham ao menos dois itens coloridos"> 
		<i class="fa fa-search"></i><span class="menu-text">Grupos com dois coloridos</span> 
		</button>
		</li>	
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_selecionaGruposColoridos(true);" title="Seleciona os grupos que tenham pelo menos duas cores distintas"> 
		<i class="fa fa-search"></i><span class="menu-text">Grupos com duas cores distintas</span> 
		</button>
		</li>	
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_selecionarTudo();" title="Seleciona tudo"> 
		<i class="fa fa-search"></i><span class="menu-text">Seleciona Tudo (CTRL+A)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_selecionarInverte();" title="Inverte seleção"> 
		<i class="fa fa-search"></i><span class="menu-text">Inverte Seleção (CTRL+SHIFT+A)</span> 
		</button>
		</li>
	</menu>
	</li>
	<li class="menu-item submenu">
	<button type="button" class="menu-btn"><i class="fa fa-link"></i><span class="menu-text">Ligar</span></button>
	<menu class="menu">
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); menu_ligar_novo('', '', true);" title="Cria um novo item (que não seja PF ou PJ) com ligação opcional."> 
		<span class="menu-text">Novo Item (U)...</span> 
		</button>
		</li>  
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); menu_ligar_novo('', '', false);" title="Cria novo item (que não seja PF ou PJ) e liga aos selecionados."> 
		<span class="menu-text">Para Novo Item (SHIFT+U)...</span> 
		</button>
		</li>      
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); menu_ligar_novo('', '', false, true);" title="Cria novo item (que não seja PF ou PJ) e liga Entre os itens selecionados."> 
		<span class="menu-text">Novo Item Entre Seleção(CTRL+U)...</span> 
		</button>
		</li>     
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); menu_ligar_selecionados(true);" title="Liga o primeiro aos demais itens selecionados"> 
		<span class="menu-text">Em Estrela (L)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); menu_ligar_selecionados(false);" title="Liga os itens selecionados em fila indiana"> 
		<span class="menu-text">Em Fila (K)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); menu_desligar_selecionados(false);" title="Remove ligações entre os itens selecionados"> 
		<span class="menu-text">Remover Entre (SHIFT+L)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); menu_desligar_selecionados(true);" title="Remove todas as ligações dos itens selecionados"> 
		<span class="menu-text">Remover Ligações</span> 
		</button>
		</li>
	</menu>
	</li>

	<li class="menu-item submenu">
	<button type="button" class="menu-btn"> <i class="fa fa-file-export"></i> <span class="menu-text">Salvar/Abrir</span> </button>
	<menu class="menu">
	
		<li class="menu-item submenu">
		<button type="button" class="menu-btn" title="Salva arquivo em formato Excel, SVG, i2 ou JSON."> <i class="fa fa-file-export"></i> <span class="menu-text">Arquivo</span> </button>
		<menu class="menu">	

			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaExcel(false)" title="Salva dados dos itens da tela em planilha Excel" > 
			<i class="fa fa-file-excel"></i><span class="menu-text">Salvar Excel...</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportai2(false)" title="Salva dados dos itens da tela para o i2 Chart Reader(Experimental)" > 
			<i class="fa fa-file-excel"></i><span class="menu-text">Salvar em Gráfico i2 Chart Reader...</span> 
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaSVG()" title="Salva imagem escalável em formato SVG" >
			<i class="fa fa-save"></i><span class="menu-text" >Salvar Imagem SVG...</span>
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_salvaJsonArquivo(false)" title="Salva arquivo JSON com os itens e ligações de todo o gráfico, que pode ser aberto pela opção ABRIR ARQUIVO JSON. Json é um arquivo texto com informações dos itens exibidos na tela e das ligações entre os itens.">
			<i class="fa fa-save"></i> <span class="menu-text">Salvar Arquivo Json...</span>
			</button>
			</li>
			<li class="menu-item">
			<button type="button" class="menu-btn" id="menu_botao_importaJsonArquivo" disabled title="Abre dados de um arquivo JSON salvo pela opção Salvar Arquivo JSON"> 
			<i class="fa fa-folder-open"></i><span class="menu-text">Abrir Arquivo Json...</span>
			<input value="Importar" type="file" id="fileImportJSON" title="Adiciona grafico no formato JSON" />
			</button>
			<script>
				document.getElementById('fileImportJSON').addEventListener('change', menu_importarJsonArquivo, false);
			</script>
			</li>
 	
		</menu>
		</li>

	
		<li class="menu-item submenu">
		<button type="button" class="menu-btn" title="Exporta/Importa/apaga arquivo JSON no servidor."> <i class="fa fa-file-export"></i> <span class="menu-text">no Servidor</span> </button>
		<menu class="menu">	
			{% if parametros.bgrafico_no_servidor %}
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaJSONServidor(false, true);" title="Salva as alterações no servidor preservando o mesmo link. Observação: os links no servidor poderão ser removidos sem aviso prévio... Para preservar as informações localmente, utilize a opção 'Salvar Arquivo Json'.">
			<i class="fa fa-upload"></i><span class="menu-text">ATUALIZAR JSON no Servidor...</span>
			</button>
			</li>  
			{% endif %}
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaJSONServidor(false)" title="Salva as informações da visualização no servidor e o link poderá ser compartilhado. Observação: os links no servidor poderão ser removidos sem aviso prévio... Para preservar as informações localmente, utilize a opção 'Salvar Arquivo Json'.">
			<i class="fa fa-upload"></i><span class="menu-text">Exportar JSON ao Servidor...</span>
			</button>
			</li>  
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_importaJSONServidor()" title="Carrega um arquivo de visualização exportado ao servidor.">
			<i class="fa fa-download"></i> <span class="menu-text">Importar JSON do Servidor...</span>
			</button>
			</li>  
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_importaJSONServidor(null, null, true)" title="Carrega um arquivo de visualização exportado e depois APAGA do servidor.">
			<i class="fa fa-trash"></i> <span class="menu-text">Apagar JSON do Servidor...</span>
			</button>
			</li>  	
		</menu>
		</li>
		
		
		<li class="menu-item submenu">
		<button type="button" class="menu-btn" title="Salva/Lê/Apaga JSON local no navegador."> <i class="fa fa-file-export"></i> <span class="menu-text">no Navegador</span> </button>
		<menu class="menu">	
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_salvaJSONNavegador(false)" title='Salva as informações da visualização json neste navegador. Os dados ficarão no "localStorage" do navegador, sem necessidade de salvar um arquivo no computador ou exportar ao servidor.'>
			<i class="fa fa-save"></i> <span class="menu-text">Salva JSON no Navegador...</span>
			</button>
			</li>  
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_carregaJSONNavegador()" title="Lê o arquivo de visualização json que está neste navegador.">
			<i class="fa fa-folder-open"></i><span class="menu-text">Abre JSON no Navegador...</span>
			</button>
			</li>  
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_apagaJSONNavegador(null, null, true)" title="Apaga o json no navegador.">
			<i class="fa fa-trash"></i> <span class="menu-text">Apagar JSON no Navegador...</span>
			</button>
			</li>  	
		</menu>
		</li>
		<li class="menu-item submenu">
		<button type="button" class="menu-btn" title="Salva seleção para JSON ou servidor"> <i class="fa fa-file-export"></i> <span class="menu-text">Seleção</span> </button>
		<menu class="menu">
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_salvaJsonArquivo(true)" title="Salva arquivo JSON com os itens e ligações somente dos itens selecionados, que pode ser aberto pela opção Importar JSON">
			<i class="fa fa-save"></i> <span class="menu-text">Salvar Arquivo Json...</span>
			</button>
			</li>  
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaJSONServidor(true)" title="Salva as informações dos itens selecionados no servidor, o link poderá ser compartilhado e aberto em uma nova aba.">
			<i class="fa fa-upload"></i><span class="menu-text">Exportar JSON ao Servidor...</span>
			</button>
			</li>  		
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_copiaClip();" title="Copia os itens selecionados para a Área de Transferência da RedeCNPJ, que poderá cer colado em outra aba.">
			<i class="fa fa-copy"></i><span class="menu-text">Copia Seleção (CTRL+C)</span>
			</button>
			</li>  	
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_colaClip();" title="Cola os itens da Área de Transferência da RedeCNPJ">
			<i class="fa fa-paste"></i><span class="menu-text">Cola da Área (CRTL+V)</span>
			</button>
			</li>  	
		</menu>
		</li>
		{% if parametros.usuarioLocal %}
		<li class="menu-item submenu">
		<button type="button" class="menu-btn" title="Opções para exportar para Banco de Dados"> <i class="fa fa-file-export"></i> <span class="menu-text">Base Local</span> </button>

		<menu class="menu">
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaJSONServidorParaBaseLocal(false)" title="Salva as informações da visualização no Banco de Dados Local SQLITE no Servidor">
			<i class="fa fa-upload"></i><span class="menu-text">Exportar ao Servidor...</span>
			</button>
			</li>  	
			<li class="menu-item">
			<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_exportaJSONServidorParaBaseLocal(true)" title="Salva as informações da visualização no Banco de Dados Local SQLITE no Servidor">
			<i class="fa fa-upload"></i><span class="menu-text">Exportar Seleção...</span>
			</button>
			</li>  	
		</menu>		
		{% endif %}
		
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); window.open('https://github.com/rictom/cnpj-sqlite#arquivo_sqlite');" title="Página para baixar a base de dados de cnpj em SQLITE.">
		<i class="fa fa-download"></i> <span class="menu-text">Baixar Base CNPJ</span>
		</button>
		</li>  
	</menu>
	</li>
	<li class="menu-separator"></li>
	<li class="menu-item submenu">
	<button type="button" class="menu-btn"> <i class="fa fa-trash"></i> <span class="menu-text">Excluir</span> </button>
	<menu class="menu">
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_excluirNosSelecionados()"> 
		<i class="fa fa-trash"></i> <span class="menu-text">Excluir Nós selecionados... (Del)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_excluirTudo()"> 
		<i class="fa fa-trash"></i> <span class="menu-text">Excluir Tudo... (SHIFT+Del)</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:removeIsolados(true);" title="Remove itens sem ligação."> 
		<i class="fa fa-trash"></i><span class="menu-text">Excluir itens isolados (CTRL+Del)</span> 
		</button>
		</li>	
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:excluirNoMantendoLinks()"> 
		<i class="fa fa-trash"></i> <span class="menu-text">Excluir Nó mantendo Link</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:removeGalhos(true);" title="Simplifica o gráfico, mantendo apenas itens com mais de uma ligação."> 
		<i class="fa fa-trash"></i><span class="menu-text">Simplifica Gráfico...</span> 
		</button>
		</li>		

	</menu>
	</li>
	<li class="menu-separator"></li>
	<li class="menu-item submenu">
	<button type="button" class="menu-btn"><i class="fa fa-sliders-h"></i><span class="menu-text">Configurar</span> </button>
	<menu class="menu">
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_configurar_springLength()"> 
		<span class="menu-text">Comprimento da Ligação</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_configurar_springCoeff()"> 
		<span class="menu-text">Coeficiente da "Mola"</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_configurar_dragCoeff()"> 
		<span class="menu-text">Coeficiente de Arrasto</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_configurar_gravity()"> 
		<span class="menu-text">Gravidade</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_configurar_theta()"> 
		<span class="menu-text">Coeficiente Theta</span> 
		</button>
		</li>
		<li class="menu-item">
		<button type="button" class="menu-btn" onclick="menuOnClick(); javascript:menu_configurar_nodeSize()"> 
		<span class="menu-text">Tamanho do Ícone</span> 
		</button>
		</li>
	</menu>
	</li>	
	{% if parametros.bBaseReceita %}
	<li class="menu-item">
	<button type="button" class="menu-btn" onclick="menuOnClick(); window.open('https://github.com/rictom/rede-cnpj#ajuda'); "> 
	<i class="fa fa-info-circle"></i><span class="menu-text">Ajuda...</span> 
	</button>
	</li>
	<li class="menu-item">
	<button type="button" class="menu-btn" onclick="menuOnClick(); window.open('https://github.com/rictom/rede-cnpj'); "> 
	<i class="fa fa-info-circle"></i><span class="menu-text">Sobre...</span> 
	</button>
	</li>
	{% endif %}
</menu>

<iframe id="iframeAuxiliarDownload" src="" onload="" style="display:none"></iframe>

<div style="display:none;">
	<div id="dlgLink">
		<p><b>Digite os parâmetros da consulta</b></p>
		<p>Número máximo de itens (Serão ordenados de forma decrescente)</p>
		<input class="ajs-input" id="dlgLink_numeroItens" type="number" value="15" /> 
		<p>Valor mínimo</p>
		<input class="ajs-input" id="dlgLink_valorMinimo" type="text" value="100000"/> 
		<p>Valor máximo</p>
		<input class="ajs-input" id="dlgLink_valorMaximo" type="text" value=""/> 
		<p>Número de camadas (Profundidade de níveis na consulta)</p>
		<input class="ajs-input" id="dlgLink_camadas" type="number" value="1" /> 
	</div>
</div>

<div style="display:none;">
	<div id="dlgItem">
		<p><b>Digite parâmetros para inserir novo item</b></p>
		<p><b>ID (IDENTIFICADOR)</b></p>
		<p>Digite nome ou identificador de novo item (deve ser único no gráfico)</p>
		<input class="ajs-input" id="dlgItem_id" type="text" value="" title="O Identificador deve começar com DUAS LETRAS seguidos de underscore(_). Hà alguns Prefixos pré-definidos, como PF_ (Pessoa Física na base de sócios), PJ_ (Pessoa Jurídica), EN_ (Endereço normalizado), EM_ (Email), TE_ (Telefone), LI_ (Link de site), AR_ (Arquivo), PH_ (Homem) , PM_ (Mulher), PP_ (Pessoa). O Prefixo OO_ é especial para definir um círculo sem texto para agrupar itens. Se não for informado um Prefixo no identificador, será adicionado ID_. No gráfico o texto do rótulo na primeira linha abaixo do ícone não irá exibir o Prefixo" /> 
		<p>Descrição (texto aparece na segunda linha)</p>
		<input class="ajs-input" id="dlgItem_descricao" type="text" value="" /> 
		<p>Nota (texto na terceira linha - opcional)</p>
		<input class="ajs-input" id="dlgItem_nota" type="text" value="" /> 
		<p>Nome da Ligação com item(s) selecionado(s) (pode ficar vazio)</p>
		<input class="ajs-input" id="dlgItem_ligacao" type="text" value=""/> 
		<div style="width: 100%; display: table;">
			<div style="display: table-row">
				<div class="ajs-input" style="width: 100px; height: 100px; background: white; display: table-cell;" id="dlgItemEditar_imagem_div" contenteditable="true">
					<!-- isto vai ser criado dinamicamente
					<image class="ajs-input" style="width: 100px; height: 100px; background: silver;" id="dlgItemEditar_imagem" tag="dlgItemEditar_imagem" onpaste="editarIconeColarImagem(event);"></image>
					-->
				</div>
				<div style="display: table-cell;">
					{% if not parametros.firefox %}
					<button onclick="editarIconeColarImagem(event);" id="dlgItemEditar_btn" title="Clique para colar imagem da área de transferência. Se isso não funcionar, pressione CTRL+V">Colar</button>
					{% endif %}
				</div>	
			</div>
		</div>
	</div>
</div>


<div style="display:none;">
	<div id="dlgItemEditar">
		<p><b>Altere os parâmetros do Item</b></p>
		<p><b>ID (IDENTIFICADOR)</b></p>
		<input class="ajs-input" id="dlgItemEditar_id" type="text" value="" title="alterar esse campo irá criar um novo item, deve ser único no gráfico"/> 
		<p>Descrição (texto aparece na segunda linha)</p>
		<input class="ajs-input" id="dlgItemEditar_descricao" type="text" value="" /> 
		<p>Nota (texto na terceira linha - opcional)</p>
		<input class="ajs-input" id="dlgItemEditar_nota" type="text" value="" /> 
		<div style="width: 100%; display: table;">
			<div style="display: table-row">
				<div class="ajs-input" style="width: 100px; height: 100px; background: white; display: table-cell;" id="dlgItemEditar_imagem_div" contenteditable="true">
					<!-- isto vai ser criado dinamicamente
					<image class="ajs-input" style="width: 100px; height: 100px; background: silver;" id="dlgItemEditar_imagem" tag="dlgItemEditar_imagem" onpaste="editarIconeColarImagem(event);"></image>
					-->
				</div>
				<div  style="display: table-cell;">
					{% if not parametros.firefox %}
					<button onclick="editarIconeColarImagem(event);" id="dlgItemEditar_btn" title="Clique para colar imagem da área de transferência. Se isso não funcionar, pressione CTRL+V">Colar</button>
					{% endif %}	
				</div>	
			</div>
		</div>
		
	</div></div>


<div id="img_home" style="display:none;"></div>

</body>
</html>
